<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline'
                            https://www.gstatic.com
                            https://*.gstatic.com
                            https://cdn.tailwindcss.com
                            https://unpkg.com
                            https://cdn.jsdelivr.net
                            https://www.google.com
                            https://*.google.com
                            https://apis.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src 'self'
                           https://www.google.com
                           https://*.google.com
                           https://www.gstatic.com
                           https://*.gstatic.com
                           https://accounts.google.com
                           https://apis.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__sharepoint_flow_url = "REPLACE_WITH_YOUR_POWER_AUTOMATE_HTTP_TRIGGER_URL";
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzBaT08WiuMIpqVNrG70iTVMUFXY1X-1zSn0uKa3xgLa4KdUwFbL5q7xh5OwpJMAblAdQ/exec";
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-icon{width:22px;height:22px;stroke-width:2.2}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
    #debug{position:fixed;right:8px;bottom:8px;background:#111827;color:#e5e7eb;border-radius:10px;max-width:48rem;width:calc(100vw - 16px);font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;display:none}
    #debug header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid #374151}
    #debug pre{margin:0;padding:8px 10px;max-height:40vh;overflow:auto;white-space:pre-wrap}
    #debug .pill{background:#374151;color:#9ca3af;border-radius:20px;padding:2px 8px;margin-left:6px;font-size:11px}
    #debug .ok{color:#10b981} #debug .warn{color:#f59e0b} #debug .err{color:#ef4444}
    .link{color:#2563eb;cursor:pointer}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁 -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-blue-800">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">使用 Google 帳號登入以進入儀表板</p>

        <button id="btn-landing-login" onclick="signInWithGoogle()" disabled
                class="mt-6 w-full py-3 rounded-xl bg-blue-800 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>

        <div class="flex items-center justify-between mt-3 text-xs text-gray-600">
          <div id="landing-loading" class="hidden">登入狀態還原中，請稍候…</div>
          <div class="space-x-3">
            <button id="btn-auth-reset" class="hidden link" onclick="clearAuthStuck()">清除登入狀態</button>
            <button id="btn-open-window" class="hidden link" onclick="openInNewWindow()">在新視窗開啟</button>
          </div>
        </div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- 應用殼（登入後顯示） -->
  <div id="app-shell" class="hidden">
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
          </button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="nav-icon"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="tasks" onclick="setView('tasks')"><i data-lucide="clipboard-check" class="nav-icon"></i><span class="nav-label">任務</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="nav-icon"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="file-text" class="nav-icon"></i><span class="nav-label">報告</span></button>
          <button class="nav-item group" data-view="community" onclick="setView('community')"><i data-lucide="messages-square" class="nav-icon"></i><span class="nav-label">資訊交流</span></button>
          <button class="nav-item group" data-view="details" onclick="setView('details')"><i data-lucide="layout-dashboard" class="nav-icon"></i><span class="nav-label">專案詳情</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm">U</div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()">
          <i data-lucide="log-out" class="nav-icon"></i><span class="nav-label">登出</span>
        </button>
      </div>
    </aside>

    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <div id="debug">
    <header>
      <div>Auth Debug<span id="dbg-state" class="pill">init</span></div>
      <button style="color:#9ca3af" onclick="document.getElementById('debug').style.display='none'">✕</button>
    </header>
    <pre id="dbg-log"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      indexedDBLocalPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      inMemoryPersistence,
      GoogleAuthProvider,
      onAuthStateChanged,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // Debug
    const debugMode = /[?&]debug=1/.test(location.search);
    const dbgEl = document.getElementById('debug');
    const dbgLogEl = document.getElementById('dbg-log');
    const dbgStateEl = document.getElementById('dbg-state');
    if (debugMode) { dbgEl.style.display='block'; }
    function logDbg(type, msg, obj){
      if(!debugMode) return;
      const now = new Date().toISOString().slice(11,19);
      dbgLogEl.textContent += `[${now}] [${type}] ${msg}${obj?`: ${typeof obj==='string'?obj:JSON.stringify(obj)}`:''}\n`;
      dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
    }
    function setDbgState(s, cls){ if(!debugMode) return; dbgStateEl.textContent = s; dbgStateEl.className = 'pill ' + (cls||''); }

    // 全域狀態
    let db, auth, storage;
    let currentUserId = "";
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const SHAREPOINT_FLOW_URL   = window.__sharepoint_flow_url || "";
    const AI_SUMMARY_WEBAPP_URL = window.__ai_summary_webapp_url || "";

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;

    // DOM
    const landing = document.getElementById("landing");
    const landingLoading=document.getElementById("landing-loading");
    const appShell = document.getElementById("app-shell");
    const loginBtn = document.getElementById('btn-landing-login');
    const resetBtn = document.getElementById('btn-auth-reset');
    const openWindowBtn = document.getElementById('btn-open-window');

    // Utils
    function showModal(title, message){ alert((title||"提示") + (message?("\n\n" + message):"")); }
    function n(v){ return Number(v)||0; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function escapeHtml(str){ if(str==null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function canUseSessionStorage(){
      try{ const k='__ss__'+Math.random(); sessionStorage.setItem(k,'1'); const ok=sessionStorage.getItem(k)==='1'; sessionStorage.removeItem(k); return ok; }
      catch{ return false; }
    }
    function isLikelyInAppBrowser(){
      const ua = navigator.userAgent || '';
      return /(FBAN|FBAV|Instagram|Line|Line\/|Messenger|WeChat|MicroMessenger|Twitter|TikTok|MiuiBrowser|OPR\/|DuckDuckGo)/i.test(ua);
    }
    function openInNewWindow(){ try{ window.open(location.href,'_blank','noopener,noreferrer'); }catch{} }
    window.openInNewWindow = openInNewWindow;

    // 顯示/隱藏 App
    function showAppShell(show){
      if(show){ landing.classList.add("hidden"); appShell.classList.remove("hidden"); }
      else{ appShell.classList.add("hidden"); landing.classList.remove("hidden"); }
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    // 使用者 UI
    function updateUserChips(){
      const nameEl = document.getElementById("user-display-name");
      const emailEl= document.getElementById("user-email");
      const avatar = document.getElementById("user-avatar");
      const initial= document.getElementById("user-initial");
      const displayName = userProfile.displayName || userProfile.email?.split("@")[0] || "使用者";
      const email = userProfile.email || "";
      if(nameEl) nameEl.textContent = displayName;
      if(emailEl) emailEl.textContent = email;
      if(userProfile.photoURL){
        avatar?.setAttribute("src", userProfile.photoURL);
        avatar?.classList.remove("hidden");
        initial?.classList.add("hidden");
      }else{
        avatar?.classList.add("hidden");
        if(initial){ initial.textContent = (displayName[0]||"U").toUpperCase(); initial.classList.remove("hidden"); }
      }
    }

    function applyUser(user){
      if(user){
        currentUserId = user.uid;
        userProfile = { displayName:user.displayName||"", email:user.email||"", photoURL:user.photoURL||"" };
        updateUserChips();
        showAppShell(true);
        if(!listenersStarted) initializeSystem(true);
        setDbgState('signed-in','ok'); logDbg('OK','applyUser signed-in',{uid:user.uid,email:user.email});
      }else{
        currentUserId = "";
        userProfile = { displayName:"", email:"", photoURL:"" };
        showAppShell(false);
        setDbgState('signed-out'); logDbg('INFO','applyUser signed-out');
      }
    }

    async function clearAuthStuck(){
      try{ landingLoading?.classList.add("hidden"); }catch{}
      try{ loginBtn?.removeAttribute('disabled'); }catch{}
      try{ await signOut(auth); }catch{}
      try{ [localStorage, sessionStorage].forEach(store=>{ try{ for(const k of Object.keys(store)){ if(/^firebase:/.test(k) || /firebase/i.test(k)) store.removeItem(k); } }catch{} }); }catch{}
      logDbg('WARN','auth cache cleared');
      alert('已清除登入快取，請重新登入。若你在 App 內建瀏覽器，請改用外部瀏覽器開啟本頁。');
    }
    window.clearAuthStuck = clearAuthStuck;

    // 登入流程：Popup優先；若被擋且 sessionStorage 可用，回退 Redirect；否則提示外部瀏覽器
    window.signInWithGoogle = async function(){
      try{
        if(!auth){ await initFirebase().catch(()=>{}); }
        if(!auth){ showModal("初始化中","驗證服務尚未就緒，請稍候再試或重新整理。"); return; }
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        // 先試 Popup
        try{
          setDbgState('popup','warn'); logDbg('INFO','signInWithPopup try',{ua:navigator.userAgent});
          await signInWithPopup(auth, provider);
          logDbg('OK','signInWithPopup success');
          return;
        }catch(e){
          const code = e?.code || "";
          logDbg('WARN','signInWithPopup failed', {code, message:e?.message});
          // 若 popup 被擋或被關，嘗試 redirect（但僅在 sessionStorage 可用時）
          const ssOK = canUseSessionStorage();
          if(ssOK){
            setDbgState('redirecting','warn'); logDbg('INFO','fallback to signInWithRedirect');
            await signInWithRedirect(auth, provider);
            return;
          }else{
            // 無法 redirect（會 missing initial state），提示外部瀏覽器
            openWindowBtn?.classList.remove('hidden');
            resetBtn?.classList.remove('hidden');
            showModal("瀏覽器封鎖了登入視窗",
              "請允許彈出視窗（pop-up），或點「在新視窗開啟」，或改用外部瀏覽器（Chrome/Edge/Safari 非無痕）。");
          }
        }
      }catch(e){
        logDbg('ERR','signInWithGoogle outer catch', {code:e?.code, message:e?.message});
        landingLoading?.classList.add("hidden");
        loginBtn?.removeAttribute('disabled');
        resetBtn?.classList.remove('hidden');
      }
    };

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); applyUser(null); }
      catch(e){ showModal("登出失敗", e?.message || String(e)); }
    };

    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const nextExpanded = (typeof force === 'boolean') ? force : !sb.classList.contains('expanded');
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){ btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="w-5 h-5"></i>' : '<i data-lucide="panel-left-open" class="w-5 h-5"></i>'; }
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
    };

    async function choosePersistence(auth){
      const candidates = [indexedDBLocalPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence];
      for(const p of candidates){
        try{ await setPersistence(auth, p); logDbg('OK','persistence selected', {name: p.type || (p.toString?.() || 'unknown')}); return p; }
        catch(e){ logDbg('WARN','persistence failed', {target:p.type || 'unknown', code:e?.code, message:e?.message}); }
      }
      return null;
    }

    async function initFirebase(){
      if(auth) return;
      if(!firebaseConfig){ showModal("設定錯誤","缺少 Firebase 設定"); return; }

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app); auth.languageCode='zh-TW';
      db = getFirestore(app);
      storage = getStorage(app);

      landingLoading?.classList.remove("hidden");
      resetBtn?.classList.add('hidden');
      openWindowBtn?.classList.toggle('hidden', !isLikelyInAppBrowser());
      setDbgState('restoring','warn'); logDbg('INFO','init: restoring...', {ua:navigator.userAgent, ssOK: canUseSessionStorage()});

      let settled=false;
      const safetyTimer=setTimeout(()=>{
        if(!settled){
          logDbg('WARN','restore-timeout','no auth state after 7s');
          landingLoading?.classList.add("hidden");
          loginBtn?.removeAttribute('disabled');
          resetBtn?.classList.remove('hidden');
          setDbgState('timeout','warn');
        }
      },7000);

      // 先掛監聽
      onAuthStateChanged(auth, (user)=>{
        settled=true; clearTimeout(safetyTimer);
        landingLoading?.classList.add("hidden");
        logDbg('INFO','onAuthStateChanged', !!user ? 'user present' : 'no user');
        applyUser(user);
        loginBtn?.removeAttribute('disabled');
      });

      // 選擇持久化
      try{ await choosePersistence(auth); }catch(e){ logDbg('ERR','choosePersistence error', {code:e?.code, message:e?.message}); }

      // 若剛才 fallback 走了 redirect，這裡會拿到結果
      try{
        const rr = await getRedirectResult(auth);
        if(rr?.user){
          logDbg('OK','getRedirectResult user', {uid:rr.user.uid, email:rr.user.email});
          applyUser(rr.user);
          landingLoading?.classList.add("hidden");
          loginBtn?.removeAttribute('disabled');
          settled=true; clearTimeout(safetyTimer);
        }else{
          logDbg('INFO','getRedirectResult empty');
        }
      }catch(e){
        logDbg('ERR','getRedirectResult error', {code:e?.code, message:e?.message});
      }
    }

    function isAuthorized(){ return !!currentUserId; }

    // ====== 以下為資料/視圖（維持與先前版本一致，略寫重點面板） ======
    let managers=[]; const DEFAULT_MANAGERS=["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];
    let currentView="dashboard",selectedProjectId=null,calendarInstance=null;
    let projects=[],tasks=[],events=[],files=[],communityPosts=[],budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0};

    function setActiveByView(view){
      document.querySelectorAll('#app-sidebar .nav-item').forEach(el=>{ el.classList.toggle('active', el.getAttribute('data-view') === view); });
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }
    window.setView=function(view,arg){
      currentView=view; setActiveByView(view);
      if(view==="dashboard") renderDashboard();
      else if(view==="tasks") renderTaskManagement();
      else if(view==="calendar") renderCalendar();
      else if(view==="report") renderReport();
      else if(view==="community") renderCommunity();
      else if(view==="details"){ selectedProjectId=(typeof arg==="string"&&arg)?arg:(projects[0]?.id||null); renderProjectDetails(selectedProjectId); }
    };
    function rerenderByView(){ if(currentView==="dashboard") renderDashboard(); if(currentView==="tasks") renderTaskManagement(); if(currentView==="calendar") renderCalendar(); if(currentView==="report") renderReport(); if(currentView==="community") renderCommunity(); if(currentView==="details") renderProjectDetails(selectedProjectId); }
    function managerOptionsHtml(selected=""){ const list=(managers.length>0?managers.map(m=>m.name).filter(Boolean):DEFAULT_MANAGERS); return list.map(m=>`<option value="${escapeHtml(m)}" ${m===selected?'selected':''}>${escapeHtml(m)}</option>`).join(""); }
    function initializeSystem(withData){
      currentView="dashboard"; renderDashboard(true);
      if(withData) startRealtimeListeners();
      const saved = (()=>{ try{ return localStorage.getItem('sidebarExpanded')!=='0'; }catch{return true} })();
      toggleSidebar(saved);
    }
    function startRealtimeListeners(){
      if(!db || listenersStarted) return; listenersStarted=true;
      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ projects=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ tasks=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), s=>{ events=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="calendar") renderCalendar(); });
      onSnapshot(query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")), s=>{ files=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="details") renderProjectDetails(selectedProjectId); });
      onSnapshot(doc(db, SETTINGS_DOC_PATH), snap=>{ if(snap.exists()){ const d=snap.data()||{}; budgetCaps={ personnelCap:n(d.personnelCap), operatingCap:n(d.operatingCap), equipmentCap:n(d.equipmentCap) }; }else{ budgetCaps={ personnelCap:0, operatingCap:0, equipmentCap:0 }; } if(currentView==="dashboard") renderDashboard(); });
      onSnapshot(query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")), s=>{ managers=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ communityPosts=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="community") renderCommunity(); });
    }

    function renderDashboard(isBoot=false){
      const c=document.getElementById("main-content"); if(!c) return;
      const totalProjects=projects.length;
      const completed=projects.filter(p=>(n(p.progress))>=95).length;
      const totalBudget=projects.reduce((s,p)=>s+n(p.budget),0);
      const empty=totalProjects===0;

      let personnelUsed=0,operatingUsed=0,equipmentUsed=0;
      for(const p of projects){
        const pu=('personnelUsed' in p)?n(p.personnelUsed):n(p.personnelBudget);
        const ou=('operatingUsed' in p)?n(p.operatingUsed):n(p.operatingBudget);
        const eu=('equipmentUsed' in p)?n(p.equipmentUsed):n(p.equipmentBudget);
        personnelUsed+=pu; operatingUsed+=ou; equipmentUsed+=eu;
      }
      const pc=n(budgetCaps.personnelCap), oc=n(budgetCaps.operatingCap), ec=n(budgetCaps.equipmentCap);
      const pRate=pc>0?clamp01(personnelUsed/pc):0, oRate=oc>0?clamp01(operatingUsed/oc):0, eRate=ec>0?clamp01(equipmentUsed/ec):0;
      const pRemain=pc-personnelUsed, oRemain=oc-operatingUsed, eRemain=ec-equipmentUsed;
      const barClass=(rate,remain)=> remain>=0?(rate>=0.95?"bg-yellow-400":"bg-blue-800"):"bg-red-500";

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-blue-800"></i>專案儀表板</h2>
        ${ isBoot && !listenersStarted ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-pulse">
          ${[1,2,3].map(()=>`<div class="bg-gray-100 p-6 rounded-xl"><div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div><div class="h-8 bg-gray-200 rounded w-1/2"></div></div>`).join("")}
        </div>`:"" }

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between"><div class="text-gray-500">專案總數</div><i data-lucide="layers" class="w-8 h-8 text-blue-800"></i></div>
            <div class="mt-3 text-3xl font-extrabold text-gray-900">${totalProjects}</div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-600">
            <div class="flex items-center justify-between"><div class="text-gray-500">接近完成</div><i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i></div>
            <div class="mt-3 text-3xl font-extrabold text-gray-900">${completed}</div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-600">
            <div class="flex items-center justify-between"><div class="text-gray-500">總預算</div><i data-lucide="wallet" class="w-8 h-8 text-orange-600"></i></div>
            <div class="mt-3 text-3xl font-extrabold text-gray-900">${fmtMoney(totalBudget)}</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費總預算</div><div class="text-sm text-gray-500">${fmtMoney(pc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate,pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(personnelUsed)}</strong>（${(pRate*100).toFixed(0)}%）</span><span>${pRemain>=0?`餘額：<strong>${fmtMoney(pRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-pRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費總預算</div><div class="text-sm text-gray-500">${fmtMoney(oc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate,oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(operatingUsed)}</strong>（${(oRate*100).toFixed(0)}%）</span><span>${oRemain>=0?`餘額：<strong>${fmtMoney(oRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-oRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費總預算</div><div class="text-sm text-gray-500">${fmtMoney(ec)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate,eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(equipmentUsed)}</strong>（${(eRate*100).toFixed(0)}%）</span><span>${eRemain>=0?`餘額：<strong>${fmtMoney(eRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-eRemain)}</strong>`}</span></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          ${ empty ? `
            <div class="text-center py-10">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
              <p class="text-lg text-gray-600">目前沒有專案資料。</p>
              <button onclick="setView('tasks')" class="mt-4 px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 前往新增或分配任務
              </button>
            </div>` : `
            <div class="text-gray-700">已載入 ${totalProjects} 個專案。從左側選單瀏覽任務、行事曆與詳情。</div>
          `}
        </div>
      `;
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    // 其他畫面（任務/行事曆/報告/社群）可保留你先前的實作；如需我可再貼完整段落。

    window.addEventListener('DOMContentLoaded', () => {
      initFirebase().catch(e=>{
        logDbg('ERR','initFirebase failed', {code:e?.code, message:e?.message});
        landingLoading?.classList.add("hidden");
        loginBtn?.removeAttribute('disabled');
        resetBtn?.classList.remove('hidden');
      });
    });

    if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
  </script>
</body>
</html>
