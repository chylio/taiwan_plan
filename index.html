<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net https://www.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src https://www.google.com https://www.gstatic.com https://accounts.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    // Firebase 專案設定
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__auth_mode = "google"; // 僅允許 Google
    window.__sharepoint_flow_url = "REPLACE_WITH_YOUR_POWER_AUTOMATE_HTTP_TRIGGER_URL";
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzBaT08WiuMIpqVNrG70iTVMUFXY1X-1zSn0uKa3xgLa4KdUwFbL5q7xh5OwpJMAblAdQ/exec";
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","Noto Sans TC","sans-serif"] },
          colors: { "primary-blue":"#1e40af","secondary-green":"#059669","accent-orange":"#ea580c" }
        }
      }
    }
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}

    /* 側欄：展開/收合 */
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}

    /* 登入首頁背景 */
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁（未登入或尚在還原登入時顯示） -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-primary-blue">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">使用 Google 帳號登入以進入儀表板</p>

        <div id="landing-user" class="hidden mt-6">
          <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border">
            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
              <img id="landing-avatar" alt="" class="w-full h-full object-cover hidden">
              <div id="landing-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold">U</div>
            </div>
            <div class="min-w-0">
              <div id="landing-name" class="font-semibold truncate"></div>
              <div id="landing-email" class="text-xs text-gray-500 truncate"></div>
            </div>
          </div>
        </div>

        <button id="btn-landing-login" onclick="signInWithGoogle()"
                class="mt-6 w-full py-3 rounded-xl bg-primary-blue hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>

        <div id="landing-loading" class="hidden mt-6 text-center text-sm text-gray-600">登入狀態還原中，請稍候…</div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth 進行登入；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- App Shell（登入後才顯示） -->
  <div id="app-shell" class="hidden">
    <!-- 側欄 -->
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
          </button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="w-5 h-5"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="tasks" onclick="setView('tasks')"><i data-lucide="calendar-days" class="w-5 h-5"></i><span class="nav-label">Planner</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="w-5 h-5"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="brain" class="w-5 h-5"></i><span class="nav-label">Brain</span></button>
          <button class="nav-item group" data-view="community" onclick="setView('community')"><i data-lucide="messages-square" class="w-5 h-5"></i><span class="nav-label">資訊交流</span></button>
          <button class="nav-item group" data-view="details" onclick="setView('details')"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="nav-label">專案詳情</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm"></div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()">
          <i data-lucide="log-out" class="w-5 h-5"></i><span class="nav-label">登出</span>
        </button>
      </div>
    </aside>

    <!-- 主內容 -->
    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end">
        <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">確認</button>
      </div>
    </div>
  </div>

  <!-- App 腳本（包含：登入首頁 gating、Google 登入、資料監聽、行事曆等） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // 全域狀態
    let db, auth, storage;
    let currentUserId = "";
    let isAuthReady = false;
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const APP_CHECK_SITE_KEY = window.__app_check_site_key || "";
    const AUTH_MODE = (window.__auth_mode || "google").toLowerCase();
    const SHAREPOINT_FLOW_URL   = window.__sharepoint_flow_url || "";
    const AI_SUMMARY_WEBAPP_URL = window.__ai_summary_webapp_url || "";

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;

    // DOM 快取
    const landing = document.getElementById("landing");
    const landingUser = document.getElementById("landing-user");
    const landingName = document.getElementById("landing-name");
    const landingEmail= document.getElementById("landing-email");
    const landingAvatar=document.getElementById("landing-avatar");
    const landingInitial=document.getElementById("landing-initial");
    const landingLoading=document.getElementById("landing-loading");
    const appShell = document.getElementById("app-shell");

    // 工具
    function showModal(title, message){
      document.getElementById("modal-title").textContent = title || "提示";
      document.getElementById("modal-message").textContent = message || "";
      const modal = document.getElementById("custom-modal");
      const wrapper = document.getElementById("modal-content-wrapper");
      document.getElementById("modal-confirm-btn").onclick = () => {
        wrapper.classList.remove("scale-100","opacity-100");
        wrapper.classList.add("scale-95","opacity-0");
        setTimeout(()=>modal.classList.add("hidden"),300);
      };
      modal.classList.remove("hidden"); modal.classList.add("flex");
      setTimeout(()=>{ wrapper.classList.remove("scale-95","opacity-0"); wrapper.classList.add("scale-100","opacity-100"); },50);
    }
    function n(v){ return Number(v)||0; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function escapeHtml(str){ if(str==null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function tsToDateStr(v){ try{ if(!v) return ""; if (typeof v==="string") return v.slice(0,10); if (v?.toDate) return v.toDate().toISOString().slice(0,10); if (v instanceof Date) return v.toISOString().slice(0,10); return ""; }catch{ return ""; } }
    function overlapsRange(start,end,s,e){ if(!start && !end) return false; const aStart=start||end, aEnd=end||start, bStart=s||e, bEnd=e||s; if(!bStart && !bEnd) return true; if(!aStart||!aEnd||!bStart||!bEnd) return false; return (aStart<=bEnd)&&(bStart<=aEnd); }
    function inRange(d,s,e){ if(!d) return false; if(s && d<s) return false; if(e && d>e) return false; return true; }

    // 側欄切換
    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const nextExpanded = (typeof force === 'boolean') ? force : !sb.classList.contains('expanded');
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){ btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="w-5 h-5"></i>' : '<i data-lucide="panel-left-open" class="w-5 h-5"></i>'; }
      if(window.lucide?.createIcons) lucide.createIcons();
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
    };

    // Auth UI
    function updateUserChips(){
      const boxName = document.getElementById("user-display-name");
      const boxEmail= document.getElementById("user-email");
      const boxAvatar=document.getElementById("user-avatar");
      const boxInitial=document.getElementById("user-initial");

      const displayName = userProfile.displayName || userProfile.email?.split("@")[0] || "使用者";
      const email = userProfile.email || "";

      if(boxName) boxName.textContent = displayName;
      if(boxEmail) boxEmail.textContent = email;
      if(userProfile.photoURL){
        boxAvatar?.setAttribute("src", userProfile.photoURL);
        boxAvatar?.classList.remove("hidden");
        boxInitial?.classList.add("hidden");
      }else{
        boxAvatar?.classList.add("hidden");
        if(boxInitial){ boxInitial.textContent = (displayName[0]||"U").toUpperCase(); boxInitial.classList.remove("hidden"); }
      }

      // landing 卡片
      if(landingUser){
        landingUser.classList.remove("hidden");
        if(landingName) landingName.textContent = displayName;
        if(landingEmail) landingEmail.textContent = email;
        if(userProfile.photoURL){
          landingAvatar?.setAttribute("src", userProfile.photoURL);
          landingAvatar?.classList.remove("hidden");
          landingInitial?.classList.add("hidden");
        }else{
          landingAvatar?.classList.add("hidden");
          landingInitial?.classList.remove("hidden");
          landingInitial.textContent = (displayName[0]||"U").toUpperCase();
        }
      }
    }

    function showAppShell(show){
      if(show){ landing.classList.add("hidden"); appShell.classList.remove("hidden"); }
      else{ appShell.classList.add("hidden"); landing.classList.remove("hidden"); }
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // Google 登入：Popup → 失敗 fallback Redirect
    window.signInWithGoogle = async function(){
      try{
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(auth, provider);
      }catch(e){
        const code = e?.code || "";
        const shouldRedirect = [
          "auth/popup-blocked",
          "auth/cancelled-popup-request",
          "auth/operation-not-supported-in-this-environment",
          "auth/idpiframe-initialization-failed",
          "auth/unauthorized-domain",
          "auth/internal-error"
        ].some(p => code.includes(p));
        if(shouldRedirect){
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });
          await signInWithRedirect(auth, provider);
        }else{
          showModal("登入失敗", e?.message || String(e));
        }
      }
    };

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); }
      catch(e){ showModal("登出失敗", e?.message || String(e)); }
    };

    // 初始化
    async function initFirebase(){
      const cfg = firebaseConfig;
      if(!cfg){ showModal("設定錯誤","缺少 Firebase 設定"); return; }
      const app = initializeApp(cfg);
      if(APP_CHECK_SITE_KEY){
        initializeAppCheck(app,{provider:new ReCaptchaV3Provider(APP_CHECK_SITE_KEY),isTokenAutoRefreshEnabled:true});
      }
      db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);

      // 關鍵：明確設為 Local 持久化，刷新後保留登入
      await setPersistence(auth, browserLocalPersistence).catch(()=>{});

      // 正在還原登入狀態時的提示
      landingLoading.classList.remove("hidden");

      onAuthStateChanged(auth, async (user)=>{
        isAuthReady = true;
        landingLoading.classList.add("hidden");
        if(user){
          currentUserId = user.uid;
          userProfile = { displayName:user.displayName||"", email:user.email||"", photoURL:user.photoURL||"" };
          updateUserChips();
          showAppShell(true);
          if(!listenersStarted) initializeSystem(true);
          await getRedirectResult(auth).catch(()=>{});
        }else{
          currentUserId = ""; userProfile = { displayName:"", email:"", photoURL:"" };
          showAppShell(false);
          if(window.lucide?.createIcons) lucide.createIcons();
        }
      });
    }

    function isAuthorized(){ return !!(isAuthReady && currentUserId); }

    // ====== 以下：你的既有頁面與功能（儀表板 / 任務 / 行事曆 / 報告 / 交流） ======
    let projects=[],tasks=[],events=[],files=[],communityPosts=[],budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0};
    let currentView="dashboard",selectedProjectId=null,calendarInstance=null;

    function setActiveByView(view){
      document.querySelectorAll('#app-sidebar .nav-item').forEach(el=>{
        el.classList.toggle('active', el.getAttribute('data-view') === view);
      });
      if(window.lucide?.createIcons) lucide.createIcons();
    }
    window.setView=function(view,arg){
      currentView=view; setActiveByView(view);
      if(view==="dashboard") renderDashboard();
      else if(view==="tasks") renderTaskManagement();
      else if(view==="calendar") renderCalendar();
      else if(view==="report") renderReport();
      else if(view==="community") renderCommunity();
      else if(view==="details"){ selectedProjectId=(typeof arg==="string"&&arg)?arg:(projects[0]?.id||null); renderProjectDetails(selectedProjectId); }
    };
    function rerenderByView(){ if(currentView==="dashboard") renderDashboard(); if(currentView==="tasks") renderTaskManagement(); if(currentView==="calendar") renderCalendar(); if(currentView==="report") renderReport(); if(currentView==="community") renderCommunity(); if(currentView==="details") renderProjectDetails(selectedProjectId); }

    function initializeSystem(withData){
      currentView="dashboard"; renderDashboard(true);
      if(withData) startRealtimeListeners();
      // 側欄初始展開狀態
      const saved = (()=>{ try{ return localStorage.getItem('sidebarExpanded')!=='0'; }catch{return true} })();
      toggleSidebar(saved);
    }

    function startRealtimeListeners(){
      if(!db || listenersStarted) return; listenersStarted=true;
      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ projects=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ tasks=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), s=>{ events=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="calendar") renderCalendar(); });
      onSnapshot(query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")), s=>{ files=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="details") renderProjectDetails(selectedProjectId); });
      onSnapshot(doc(db, SETTINGS_DOC_PATH), snap=>{ if(snap.exists()){ const d=snap.data()||{}; budgetCaps={personnelCap:n(d.personnelCap),operatingCap:n(d.operatingCap),equipmentCap:n(d.equipmentCap)}; } else { budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0}; } if(currentView==="dashboard") renderDashboard(); });
      onSnapshot(query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")), s=>{ managers=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{ communityPosts=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="community") renderCommunity(); });
    }

    // ====== 儀表板/任務/行事曆/報告/詳情/交流（與你先前版本相同邏輯；因篇幅省略重複註解） ======
    function managerOptionsHtml(selected=""){ const list=(managers.length>0?managers.map(m=>m.name).filter(Boolean):["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"]); return list.map(m=>`<option value="${escapeHtml(m)}" ${m===selected?'selected':''}>${escapeHtml(m)}</option>`).join(""); }
    let managers=[];

    function renderDashboard(isBoot=false){
      const c=document.getElementById("main-content"); if(!c) return;
      const totalProjects=projects.length;
      const completed=projects.filter(p=>(n(p.progress))>=95).length;
      const totalBudget=projects.reduce((s,p)=>s+n(p.budget),0);
      const empty=totalProjects===0;

      let personnelUsed=0,operatingUsed=0,equipmentUsed=0;
      for(const p of projects){
        const pu=('personnelUsed' in p)?n(p.personnelUsed):n(p.personnelBudget);
        const ou=('operatingUsed' in p)?n(p.operatingUsed):n(p.operatingBudget);
        const eu=('equipmentUsed' in p)?n(p.equipmentUsed):n(p.equipmentBudget);
        personnelUsed+=pu; operatingUsed+=ou; equipmentUsed+=eu;
      }
      const pc=n(budgetCaps.personnelCap), oc=n(budgetCaps.operatingCap), ec=n(budgetCaps.equipmentCap);
      const pRate=pc>0?clamp01(personnelUsed/pc):0, oRate=oc>0?clamp01(operatingUsed/oc):0, eRate=ec>0?clamp01(equipmentUsed/ec):0;
      const pRemain=pc-personnelUsed, oRemain=oc-operatingUsed, eRemain=ec-equipmentUsed;
      const barClass=(rate,remain)=> remain>=0?(rate>=0.95?"bg-yellow-400":"bg-primary-blue"):"bg-red-500";

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary-blue"></i>專案儀表板</h2>
        ${ isBoot && !listenersStarted ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-pulse">
          ${[1,2,3].map(()=>`<div class="bg-white p-6 rounded-xl shadow-lg"><div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div><div class="h-8 bg-gray-200 rounded w-1/2"></div></div>`).join("")}
        </div>`:"" }
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue"><div class="flex items-center justify-between"><i data-lucide="layers" class="w-8 h-8 text-primary-blue"></i><span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span></div><p class="text-gray-500 mt-2">總專案數</p></div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-green"><div class="flex items-center justify-between"><i data-lucide="check-circle" class="w-8 h-8 text-secondary-green"></i><span class="text-3xl font-extrabold text-gray-900">${completed}</span></div><p class="text-gray-500 mt-2">接近完成專案數</p></div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-accent-orange"><div class="flex items-center justify-between"><i data-lucide="wallet" class="w-8 h-8 text-accent-orange"></i><span class="text-xl font-extrabold text-gray-900">${fmtMoney(totalBudget)}</span></div><p class="text-gray-500 mt-2">所有專案的預算概算總計</p></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費總預算</div><div class="text-sm text-gray-500">${fmtMoney(pc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate,pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(personnelUsed)}</strong>（${(pRate*100).toFixed(0)}%）</span><span>${pRemain>=0?`餘額：<strong>${fmtMoney(pRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-pRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費總預算</div><div class="text-sm text-gray-500">${fmtMoney(oc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate,oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(operatingUsed)}</strong>（${(oRate*100).toFixed(0)}%）</span><span>${oRemain>=0?`餘額：<strong>${fmtMoney(oRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-oRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費總預算</div><div class="text-sm text-gray-500">${fmtMoney(ec)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate,eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(equipmentUsed)}</strong>（${(eRate*100).toFixed(0)}%）</span><span>${eRemain>=0?`餘額：<strong>${fmtMoney(eRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-eRemain)}</strong>`}</span></div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">所有專案概覽</h3>
          ${ empty ? `<div class="text-center py-10"><i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i><p class="text-lg text-gray-600">目前沒有專案資料。</p><button onclick="setView('creation')" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700"><i data-lucide="plus" class="w-5 h-5 inline mr-1"></i>新增第一個專案</button></div>` :
          `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">編號/名稱</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">專案管理人</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">進度</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">即時狀態</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">
            ${projects.map(p=>{const prog=n(p.progress); const bar=prog>=95?"bg-secondary-green":(prog<50?"bg-accent-orange":"bg-primary-blue"); const badge=prog>=95?"bg-secondary-green/10 text-secondary-green":(prog<50?"bg-accent-orange/10 text-accent-orange":"bg-primary-blue/10 text-primary-blue"); return `<tr><td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-blue hover:underline cursor-pointer" onclick="setView('details','${escapeHtml(p.id)}')"><div class="text-xs text-gray-500">${escapeHtml(p.id)}</div>${escapeHtml(p.title)}</td><td class="px-4 py-4 whitespace-nowrap text-sm">${escapeHtml(p.manager||"")}</td><td class="px-4 py-4 whitespace-nowrap text-sm"><div class="w-32 bg-gray-200 rounded-full h-2.5"><div class="progress-bar h-2.5 rounded-full ${bar}" style="width:${prog}%"></div></div><span class="text-xs text-gray-500 mt-1 inline-block">${prog}%</span></td><td class="px-4 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badge}">${escapeHtml(p.status||"")}</span></td><td class="px-4 py-4 whitespace-nowrap text-sm"><button onclick="setView('details','${escapeHtml(p.id)}')" class="text-primary-blue hover:text-blue-700 text-sm">查看詳情</button></td></tr>`;}).join("")}
          </tbody></table></div>`}
        </div>`;
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // 任務/行事曆/報告/詳情/交流等函式（與你上一版一致）
    // 為節省篇幅，下方只保留行事曆與必要互動；其餘（新增任務、交流區、檔案上傳、報告/AI）沿用你已採用的版本，如有需要我可再替你精簡/補全。

    function renderCalendar(){
      const c=document.getElementById("main-content");
      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="calendar" class="w-7 h-7 mr-3 text-primary-blue"></i> 行事曆</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg"><div id="calendar"></div></div>
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增行事</h3>
            <form id="new-event-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700">所屬專案</label><select id="evt-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>'}</select></div>
              <div><label class="block text-sm font-medium text-gray-700">標題</label><input type="text" id="evt-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              <div><label class="block text-sm font-medium text-gray-700">參與者/負責人</label><select id="evt-assignee" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ managerOptionsHtml() }</select></div>
              <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">開始日期</label><input type="date" id="evt-start" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div><div><label class="block text-sm font-medium text-gray-700">結束日期</label><input type="date" id="evt-end" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div></div>
              <div><label class="block text-sm font-medium text-gray-700">說明（可選）</label><textarea id="evt-desc" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="補充說明"></textarea></div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-800">新增行事</button>
            </form>
            <div id="event-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>
        </div>`;
      if(window.lucide?.createIcons) lucide.createIcons();

      const calEl=document.getElementById("calendar");
      if(calEl && window.FullCalendar){
        if(calendarInstance){ calendarInstance.destroy(); calendarInstance=null; }
        calendarInstance = new FullCalendar.Calendar(calEl,{ locale:"zh-tw", initialView:"dayGridMonth", height:700,
          headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek" },
          events: events.map(ev=>{ const start=ev.startDate, end=(ev.endDate && ev.endDate!==ev.startDate)?ev.endDate:ev.startDate; return { id:ev.id, title:`${ev.title||""} (${ev.assignee||""})`, start, end, allDay:true, extendedProps:{ projectId: ev.projectId, assignee: ev.assignee, description: ev.description||"" } }; }),
          dateClick:(info)=>{ const s=document.getElementById("evt-start"); const e=document.getElementById("evt-end"); if(s) s.value=info.dateStr; if(e) e.value=info.dateStr; },
          eventClick:(info)=>{ const ev=info.event; const pId=ev.extendedProps?.projectId||""; const desc=ev.extendedProps?.description||""; showModal(ev.title, `專案: ${pId}\n負責: ${ev.extendedProps?.assignee||""}\n${desc?('說明: '+desc):''}`); }
        }); calendarInstance.render();
      }

      document.getElementById("new-event-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback=document.getElementById("event-form-feedback");
        if(!isAuthorized()){ showModal("請先登入","請先登入後再新增行事。"); return; }
        const projectId=document.getElementById("evt-project-id").value;
        const title=document.getElementById("evt-title").value;
        const assignee=document.getElementById("evt-assignee").value;
        const startDate=document.getElementById("evt-start").value;
        const endDate=document.getElementById("evt-end").value;
        const description=document.getElementById("evt-desc").value;
        if(!projectId){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先選擇專案。"; return; }
        try{
          await addDoc(collection(db, EVENTS_COLLECTION_PATH),{ projectId,title,assignee,startDate,endDate,description,createdAt:serverTimestamp(),reporterId:currentUserId });
          feedback.className="mt-4 text-sm text-secondary-green"; feedback.textContent="行事已新增！";
          (document.getElementById("new-event-form")).reset(); renderCalendar();
        }catch(err){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="新增行事失敗：資料庫錯誤。"; }
      });
    }

    // 啟動：先顯示登入首頁，再初始化 Firebase（避免初次空白）
    window.addEventListener('DOMContentLoaded', ()=>{
      showAppShell(false); // 預設顯示登入首頁
      initFirebase();
      if(window.lucide?.createIcons) lucide.createIcons();
    });
  </script>
</body>
</html>
