<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <!-- 修正後 CSP：允許 Firebase Auth 所需 Google/GS 靜態與 OAuth 子網域 -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline'
                            https://www.gstatic.com
                            https://*.gstatic.com
                            https://cdn.tailwindcss.com
                            https://unpkg.com
                            https://cdn.jsdelivr.net
                            https://www.google.com
                            https://*.google.com
                            https://apis.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src 'self'
                           https://www.google.com
                           https://*.google.com
                           https://www.gstatic.com
                           https://*.gstatic.com
                           https://accounts.google.com
                           https://apis.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <!-- UI 與套件 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- 全域設定（請依實際環境調整） -->
  <script>
    // Firebase 專案設定
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    // Firestore APP ID（路徑用途）
    window.__app_id = "taiwanplan-f7566";
    // SharePoint（Power Automate HTTP 觸發 URL）— 如需備份請替換
    window.__sharepoint_flow_url = "REPLACE_WITH_YOUR_POWER_AUTOMATE_HTTP_TRIGGER_URL";
    // AI 週/月報 Apps Script Web App URL
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzBaT08WiuMIpqVNrG70iTVMUFXY1X-1zSn0uKa3xgLa4KdUwFbL5q7xh5OwpJMAblAdQ/exec";
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-icon{width:22px;height:22px;stroke-width:2.2}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
    /* debug 面板（?debug=1 顯示） */
    #debug{position:fixed;right:8px;bottom:8px;background:#111827;color:#e5e7eb;border-radius:10px;max-width:48rem;width:calc(100vw - 16px);font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:9999}
    #debug header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid #374151}
    #debug pre{margin:0;padding:8px 10px;max-height:40vh;overflow:auto;white-space:pre-wrap}
    #debug .pill{background:#374151;color:#9ca3af;border-radius:20px;padding:2px 8px;margin-left:6px;font-size:11px}
    #debug .ok{color:#10b981} #debug .warn{color:#f59e0b} #debug .err{color:#ef4444}
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁（需要 Google 登入才可進入 App） -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-blue-800">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">使用 Google 帳號登入以進入儀表板</p>

        <button id="btn-landing-login" onclick="signInWithGoogle()"
                class="mt-6 w-full py-3 rounded-xl bg-blue-800 hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>

        <div id="landing-loading" class="hidden mt-4 text-center text-sm text-gray-600">登入狀態還原中，請稍候…</div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- 應用殼（登入後顯示） -->
  <div id="app-shell" class="hidden">
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
          </button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="nav-icon"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="tasks" onclick="setView('tasks')"><i data-lucide="clipboard-check" class="nav-icon"></i><span class="nav-label">任務</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="nav-icon"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="file-text" class="nav-icon"></i><span class="nav-label">報告</span></button>
          <button class="nav-item group" data-view="community" onclick="setView('community')"><i data-lucide="messages-square" class="nav-icon"></i><span class="nav-label">資訊交流</span></button>
          <button class="nav-item group" data-view="details" onclick="setView('details')"><i data-lucide="layout-dashboard" class="nav-icon"></i><span class="nav-label">專案詳情</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm">U</div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()">
          <i data-lucide="log-out" class="nav-icon"></i><span class="nav-label">登出</span>
        </button>
      </div>
    </aside>

    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <!-- Debug 面板：網址加 ?debug=1 會顯示 -->
  <div id="debug">
    <header>
      <div>Auth Debug<span id="dbg-state" class="pill">init</span></div>
      <button style="color:#9ca3af" onclick="document.getElementById('debug').style.display='none'">✕</button>
    </header>
    <pre id="dbg-log"></pre>
  </div>

  <!-- App 腳本 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      initializeAuth,
      indexedDBLocalPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      onAuthStateChanged,
      onIdTokenChanged,
      signInWithRedirect,
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // ============ Debug 工具 ============
    const debugMode = /[?&]debug=1/.test(location.search);
    const dbgEl = document.getElementById('debug');
    const dbgLogEl = document.getElementById('dbg-log');
    const dbgStateEl = document.getElementById('dbg-state');
    if (debugMode) { dbgEl.style.display='block'; }
    function logDbg(type, msg, obj){
      if(!debugMode) return;
      const now = new Date().toISOString().slice(11,19);
      const line = `[${now}] [${type}] ${msg}${obj?`: ${typeof obj==='string'?obj:JSON.stringify(obj)}`:''}\n`;
      dbgLogEl.textContent += line;
      dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
    }
    function setDbgState(s, cls){ if(!debugMode) return; dbgStateEl.textContent = s; dbgStateEl.className = 'pill ' + (cls||''); }

    // 全域狀態
    let db, auth, storage;
    let currentUserId = "";
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const SHAREPOINT_FLOW_URL   = window.__sharepoint_flow_url || "";
    const AI_SUMMARY_WEBAPP_URL = window.__ai_summary_webapp_url || "";

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;

    // DOM 快取
    const landing = document.getElementById("landing");
    const landingLoading=document.getElementById("landing-loading");
    const appShell = document.getElementById("app-shell");

    // 小工具
    function showModal(title, message){
      alert((title||"提示") + (message?("\n\n" + message):""));
    }
    function n(v){ return Number(v)||0; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function escapeHtml(str){ if(str==null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function tsToDateStr(v){ try{ if(!v) return ""; if (typeof v==="string") return v.slice(0,10); if (v?.toDate) return v.toDate().toISOString().slice(0,10); if (v instanceof Date) return v.toISOString().slice(0,10); return ""; }catch{ return ""; } }
    function overlapsRange(start,end,s,e){ if(!start && !end) return false; const aStart=start||end, aEnd=end||start, bStart=s||e, bEnd=e||s; if(!bStart && !bEnd) return true; if(!aStart||!aEnd||!bStart||!bEnd) return false; return (aStart<=bEnd)&&(bStart<=aEnd); }
    function inRange(d,s,e){ if(!d) return false; if(s && d<s) return false; if(e && d>e) return false; return true; }

    // 顯示/隱藏 App 殼與登入首頁
    function showAppShell(show){
      if(show){ landing.classList.add("hidden"); appShell.classList.remove("hidden"); }
      else{ appShell.classList.add("hidden"); landing.classList.remove("hidden"); }
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // 更新使用者 UI
    function updateUserChips(){
      const boxName = document.getElementById("user-display-name");
      const boxEmail= document.getElementById("user-email");
      const boxAvatar=document.getElementById("user-avatar");
      const boxInitial=document.getElementById("user-initial");

      const displayName = userProfile.displayName || userProfile.email?.split("@")[0] || "使用者";
      const email = userProfile.email || "";

      if(boxName) boxName.textContent = displayName;
      if(boxEmail) boxEmail.textContent = email;
      if(userProfile.photoURL){
        boxAvatar?.setAttribute("src", userProfile.photoURL);
        boxAvatar?.classList.remove("hidden");
        boxInitial?.classList.add("hidden");
      }else{
        boxAvatar?.classList.add("hidden");
        if(boxInitial){ boxInitial.textContent = (displayName[0]||"U").toUpperCase(); boxInitial.classList.remove("hidden"); }
      }
    }

    // 封裝：登入狀態套用並進入儀表板
    function applyUser(user){
      if(user){
        currentUserId = user.uid;
        userProfile = {
          displayName: user.displayName || "",
          email: user.email || "",
          photoURL: user.photoURL || ""
        };
        updateUserChips();
        showAppShell(true);
        if(!listenersStarted) initializeSystem(true);
        setDbgState('signed-in','ok'); logDbg('OK','applyUser signed-in',{uid:user.uid,email:user.email});
      }else{
        currentUserId = "";
        userProfile = { displayName:"", email:"", photoURL:"" };
        showAppShell(false);
        setDbgState('signed-out'); logDbg('INFO','applyUser signed-out');
      }
    }

    // Google 登入：固定 Redirect（最穩定）
    window.signInWithGoogle = async function(){
      try{
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        setDbgState('redirecting','warn'); logDbg('INFO','signInWithRedirect');
        await signInWithRedirect(auth, provider);
      }catch(e){
        setDbgState('redirect-failed','err'); logDbg('ERR','signInWithRedirect failed', {code:e?.code, message:e?.message});
        showModal("登入失敗", e?.message || String(e));
      }
    };

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); applyUser(null); }
      catch(e){ showModal("登出失敗", e?.message || String(e)); }
    };

    // 側欄展開/收合
    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const nextExpanded = (typeof force === 'boolean') ? force : !sb.classList.contains('expanded');
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){ btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="w-5 h-5"></i>' : '<i data-lucide="panel-left-open" class="w-5 h-5"></i>'; }
      if(window.lucide?.createIcons) lucide.createIcons();
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
    };

    // 初始化 Firebase/Auth（關鍵：initializeAuth + 多重持久化）
    async function initFirebase(){
      if(!firebaseConfig){ showModal("設定錯誤","缺少 Firebase 設定"); return; }
      const app = initializeApp(firebaseConfig);

      auth = initializeAuth(app, {
        persistence: [indexedDBLocalPersistence, browserLocalPersistence, browserSessionPersistence]
      });
      db = getFirestore(app);
      storage = getStorage(app);

      // 正在還原登入狀態時顯示提示
      landingLoading?.classList.remove("hidden");
      setDbgState('restoring','warn'); logDbg('INFO','init: restoring...');

      // 先處理 redirect 結果，再掛監聽（避免競態）
      try{
        const rr = await getRedirectResult(auth);
        if(rr?.user){
          logDbg('OK','getRedirectResult user', {uid:rr.user.uid, email:rr.user.email});
          applyUser(rr.user);
        }else{
          logDbg('INFO','getRedirectResult empty');
        }
      }catch(e){
        logDbg('ERR','getRedirectResult error', {code:e?.code, message:e?.message});
      }

      onAuthStateChanged(auth, (user) => {
        landingLoading?.classList.add("hidden");
        logDbg('INFO','onAuthStateChanged', !!user ? 'user present' : 'no user');
        applyUser(user);
      });
      onIdTokenChanged(auth, (user) => {
        logDbg('INFO','onIdTokenChanged', !!user ? 'user present' : 'no user');
        if(user && !currentUserId) applyUser(user);
      });
    }

    function isAuthorized(){ return !!currentUserId; }

    // ================== 資料與視圖 ==================
    let managers=[]; // [{id,name,email?,title?}]
    const DEFAULT_MANAGERS = ["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];

    let currentView="dashboard",selectedProjectId=null,calendarInstance=null;
    let projects=[],tasks=[],events=[],files=[],communityPosts=[],budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0};

    function setActiveByView(view){
      document.querySelectorAll('#app-sidebar .nav-item').forEach(el=>{
        el.classList.toggle('active', el.getAttribute('data-view') === view);
      });
      if(window.lucide?.createIcons) lucide.createIcons();
    }
    window.setView=function(view,arg){
      currentView=view; setActiveByView(view);
      if(view==="dashboard") renderDashboard();
      else if(view==="tasks") renderTaskManagement();
      else if(view==="calendar") renderCalendar();
      else if(view==="report") renderReport();
      else if(view==="community") renderCommunity();
      else if(view==="details"){ selectedProjectId=(typeof arg==="string"&&arg)?arg:(projects[0]?.id||null); renderProjectDetails(selectedProjectId); }
    };
    function rerenderByView(){ if(currentView==="dashboard") renderDashboard(); if(currentView==="tasks") renderTaskManagement(); if(currentView==="calendar") renderCalendar(); if(currentView==="report") renderReport(); if(currentView==="community") renderCommunity(); if(currentView==="details") renderProjectDetails(selectedProjectId); }

    function managerOptionsHtml(selected = ""){
      const list = (managers.length>0 ? managers.map(m=>m.name).filter(Boolean) : DEFAULT_MANAGERS);
      return list.map(m => `<option value="${escapeHtml(m)}" ${m===selected?'selected':''}>${escapeHtml(m)}</option>`).join("");
    }

    function initializeSystem(withData){
      currentView="dashboard"; renderDashboard(true);
      if(withData) startRealtimeListeners();

      // 側欄初始展開狀態
      const saved = (()=>{ try{ return localStorage.getItem('sidebarExpanded')!=='0'; }catch{return true} })();
      toggleSidebar(saved);
    }

    function startRealtimeListeners(){
      if(!db || listenersStarted) return; listenersStarted=true;

      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{
        projects=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView();
      });
      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{
        tasks=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView();
      });
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), s=>{
        events=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="calendar") renderCalendar();
      });
      onSnapshot(query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")), s=>{
        files=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="details") renderProjectDetails(selectedProjectId);
      });
      onSnapshot(doc(db, SETTINGS_DOC_PATH), snap=>{
        if(snap.exists()){
          const d=snap.data()||{}; budgetCaps={ personnelCap:n(d.personnelCap), operatingCap:n(d.operatingCap), equipmentCap:n(d.equipmentCap) };
        }else{
          budgetCaps={ personnelCap:0, operatingCap:0, equipmentCap:0 };
        }
        if(currentView==="dashboard") renderDashboard();
      });
      onSnapshot(query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")), s=>{
        managers=s.docs.map(d=>({id:d.id,...d.data()})); rerenderByView();
      });
      onSnapshot(query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{
        communityPosts=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="community") renderCommunity();
      });
    }

    // ================== 儀表板 ==================
    function renderDashboard(isBoot=false){
      const c=document.getElementById("main-content"); if(!c) return;

      const totalProjects=projects.length;
      const completed=projects.filter(p=>(n(p.progress))>=95).length;
      const totalBudget=projects.reduce((s,p)=>s+n(p.budget),0);
      const empty=totalProjects===0;

      let personnelUsed=0,operatingUsed=0,equipmentUsed=0;
      for(const p of projects){
        const pu=('personnelUsed' in p)?n(p.personnelUsed):n(p.personnelBudget);
        const ou=('operatingUsed' in p)?n(p.operatingUsed):n(p.operatingBudget);
        const eu=('equipmentUsed' in p)?n(p.equipmentUsed):n(p.equipmentBudget);
        personnelUsed+=pu; operatingUsed+=ou; equipmentUsed+=eu;
      }
      const pc=n(budgetCaps.personnelCap), oc=n(budgetCaps.operatingCap), ec=n(budgetCaps.equipmentCap);
      const pRate=pc>0?clamp01(personnelUsed/pc):0, oRate=oc>0?clamp01(operatingUsed/oc):0, eRate=ec>0?clamp01(equipmentUsed/ec):0;
      const pRemain=pc-personnelUsed, oRemain=oc-operatingUsed, eRemain=ec-equipmentUsed;
      const barClass=(rate,remain)=> remain>=0?(rate>=0.95?"bg-yellow-400":"bg-blue-800"):"bg-red-500";

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-blue-800"></i>專案儀表板</h2>
        ${ isBoot && !listenersStarted ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-pulse">
          ${[1,2,3].map(()=>`<div class="bg-white p-6 rounded-xl shadow-lg"><div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div><div class="h-8 bg-gray-200 rounded w-1/2"></div></div>`).join("")}
        </div>`:"" }

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800"><div class="flex items-center justify-between"><i data-lucide="layers" class="w-8 h-8 text-blue-800"></i><span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span></div><p class="text-gray-500 mt-2">總專案數</p></div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-600"><div class="flex items-center justify-between"><i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i><span class="text-3xl font-extrabold text-gray-900">${completed}</span></div><p class="text-gray-500 mt-2">接近完成專案數</p></div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-600"><div class="flex items-center justify-between"><i data-lucide="wallet" class="w-8 h-8 text-orange-600"></i><span class="text-xl font-extrabold text-gray-900">${fmtMoney(totalBudget)}</span></div><p class="text-gray-500 mt-2">所有專案的預算概算總計</p></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費總預算</div><div class="text-sm text-gray-500">${fmtMoney(pc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate,pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(personnelUsed)}</strong>（${(pRate*100).toFixed(0)}%）</span><span>${pRemain>=0?`餘額：<strong>${fmtMoney(pRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-pRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費總預算</div><div class="text-sm text-gray-500">${fmtMoney(oc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate,oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(operatingUsed)}</strong>（${(oRate*100).toFixed(0)}%）</span><span>${oRemain>=0?`餘額：<strong>${fmtMoney(oRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-oRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費總預算</div><div class="text-sm text-gray-500">${fmtMoney(ec)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate,eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(equipmentUsed)}</strong>（${(eRate*100).toFixed(0)}%）</span><span>${eRemain>=0?`餘額：<strong>${fmtMoney(eRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-eRemain)}</strong>`}</span></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          ${ empty ? `
            <div class="text-center py-10">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
              <p class="text-lg text-gray-600">目前沒有專案資料。</p>
              <button onclick="setView('tasks')" class="mt-4 px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 前往新增或分配任務
              </button>
            </div>` : `
            <div class="text-gray-700">已載入 ${totalProjects} 個專案。從左側選單瀏覽任務、行事曆與詳情。</div>
          `}
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // ================== 任務 ==================
    function renderTaskManagement(){
      const c=document.getElementById("main-content");
      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-blue-800"></i> 任務管理中心</h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">分配新任務</h3>
            <form id="new-task-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700">所屬專案</label>
                <select id="task-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||p.id)}</option>`).join("") : '<option value="">請先新增專案</option>'}</select>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">任務名稱</label><input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              <div><label class="block text-sm font-medium text-gray-700">分配給</label><select id="task-assignee" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ managerOptionsHtml() }</select></div>
              <div><label class="block text-sm font-medium text-gray-700">截止日期</label><input type="date" id="task-due-date" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              <button type="submit" class="w-full py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">分配任務</button>
            </form>
            <div id="task-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">所有任務追蹤</h3>

            <div class="flex space-x-3 mb-4 text-sm">
              <select id="task-filter-manager" class="rounded-md border-gray-300 p-2 border"><option value="">所有負責人</option>${ managerOptionsHtml() }</select>
              <select id="task-filter-status" class="rounded-md border-gray-300 p-2 border">
                <option value="">所有狀態</option><option value="待辦">待辦</option><option value="進行中">進行中</option><option value="完成">完成</option><option value="更新">即時更新</option>
              </select>
              <button onclick="renderTaskList()" class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">過濾</button>
            </div>

            <div id="current-tasks-list" class="space-y-2"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("new-task-form")?.addEventListener("submit", handleNewTaskSubmission);
      renderTaskList();
    }

    async function handleNewTaskSubmission(e){
      e.preventDefault();
      const feedback=document.getElementById("task-form-feedback");
      if(!isAuthorized()){ showModal("請先登入","請先登入後再分配任務。"); return; }

      const projectId=document.getElementById("task-project-id").value;
      const projectTitle=projects.find(p=>p.id===projectId)?.title || projectId;
      const taskName=document.getElementById("task-name").value;
      const assignee=document.getElementById("task-assignee").value;
      const dueDate=document.getElementById("task-due-date").value;

      if(!projectId){
        feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先選擇專案。"; return;
      }
      try{
        const taskRef = await addDoc(collection(db, TASKS_COLLECTION_PATH), {
          projectId, taskName, assignee, dueDate, status:"待辦",
          createdAt: serverTimestamp(), reporterId: currentUserId
        });

        await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
          projectId, title: taskName, assignee, startDate: dueDate, endDate: dueDate,
          description: `任務：${taskName}（自動建立於任務分配）`,
          createdFromTaskId: taskRef.id, createdAt: serverTimestamp(), reporterId: currentUserId
        });

        feedback.className="mt-4 text-sm text-green-600";
        feedback.textContent="任務分配成功！已同步建立行事曆事件。";
        document.getElementById("new-task-form").reset();
      }catch(err){
        console.error(err);
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent="任務分配失敗：資料庫錯誤。";
      }
    }

    function renderTaskList(){
      const list=document.getElementById("current-tasks-list"); if(!list) return;
      const fm=document.getElementById("task-filter-manager")?.value || "";
      const fs=document.getElementById("task-filter-status")?.value || "";
      const data=tasks
        .filter(t => (!fm || t.assignee===fm) && (!fs || t.status===fs))
        .sort((a,b)=> (a.status==="待辦" && b.status!=="待辦")?-1 : (a.status!=="待辦" && b.status==="待辦")?1 : (new Date(a.dueDate)-new Date(b.dueDate)));
      if(data.length===0){ list.innerHTML='<p class="text-gray-500 text-center py-8">沒有符合過濾條件的任務。</p>'; return; }
      list.innerHTML=data.map(t=>{
        const project=projects.find(p=>p.id===t.projectId);
        let badge="bg-gray-100 text-gray-700", actionText="標記完成", actionFn=`updateTaskStatus('${escapeHtml(t.id)}','完成')`;
        if(t.status==="待辦"){ badge="bg-red-100 text-red-800"; actionText="開始進行"; actionFn=`updateTaskStatus('${escapeHtml(t.id)}','進行中')`; }
        else if(t.status==="進行中"){ badge="bg-yellow-100 text-yellow-800"; }
        else if(t.status==="完成"){ badge="bg-green-100 text-green-800"; actionText="已完成"; actionFn=`showModal('已完成','此任務已標記完成，無法再操作。')`; }
        else if(t.status==="更新"){ badge="bg-blue-100 text-blue-800"; actionText="查看詳情"; actionFn=`setView('details','${escapeHtml(t.projectId)}')`; }
        return `
          <div class="project-card bg-gray-50 p-4 rounded-lg border-l-4 ${ t.status==="待辦"?"border-red-500": t.status==="進行中"?"border-yellow-500": t.status==="完成"?"border-green-500":"border-blue-500"}">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <p class="font-bold text-lg text-gray-900">${escapeHtml(t.taskName||"")}</p>
                <p class="text-xs text-gray-500">專案: <span class="font-medium text-blue-800 cursor-pointer hover:underline" onclick="setView('details','${escapeHtml(t.projectId)}')">${escapeHtml(project?.title || t.projectId || "")}</span></p>
              </div>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${badge}">${escapeHtml(t.status||"")}</span>
            </div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between items-center">
              <p><i data-lucide="user" class="w-4 h-4 inline mr-1"></i> 負責人: <span class="font-medium">${escapeHtml(t.assignee||"")}</span>
                 <span class="ml-4"><i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> 期限: ${escapeHtml(t.dueDate||"")}</span></p>
              <button onclick="${actionFn}" class="px-3 py-1 text-xs rounded-lg text-white ${ t.status!=="更新" ? "bg-green-600 hover:bg-green-700" : "bg-blue-600 hover:bg-blue-700"}">${actionText}</button>
            </div>
          </div>`;
      }).join("");
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    async function updateTaskStatus(taskId, newStatus){
      if(!isAuthorized()){ showModal("請先登入","請先登入後再操作。"); return; }
      try{
        await updateDoc(doc(db, TASKS_COLLECTION_PATH, taskId), { status:newStatus, updatedAt: serverTimestamp() });
      }catch(err){
        console.error(err); showModal("錯誤", `更新任務狀態失敗：${err.message}`);
      }
    }
    window.updateTaskStatus = updateTaskStatus;

    // ================== 行事曆 ==================
    function renderCalendar(){
      const c=document.getElementById("main-content");
      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="calendar" class="w-7 h-7 mr-3 text-blue-800"></i> 行事曆</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg"><div id="calendar"></div></div>
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增行事</h3>
            <form id="new-event-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700">所屬專案</label><select id="evt-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||p.id)}</option>`).join("") : '<option value="">請先新增專案</option>'}</select></div>
              <div><label class="block text-sm font-medium text-gray-700">標題</label><input type="text" id="evt-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              <div><label class="block text-sm font-medium text-gray-700">參與者/負責人</label><select id="evt-assignee" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ managerOptionsHtml() }</select></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">開始日期</label><input type="date" id="evt-start" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
                <div><label class="block text-sm font-medium text-gray-700">結束日期</label><input type="date" id="evt-end" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">說明（可選）</label><textarea id="evt-desc" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="補充說明"></textarea></div>
              <button type="submit" class="w-full py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">新增行事</button>
            </form>
            <div id="event-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>
        </div>`;
      if(window.lucide?.createIcons) lucide.createIcons();

      const calEl=document.getElementById("calendar");
      if(calEl && window.FullCalendar){
        if(calendarInstance){ calendarInstance.destroy(); calendarInstance=null; }
        calendarInstance = new FullCalendar.Calendar(calEl, {
          locale:"zh-tw", initialView:"dayGridMonth", height:700,
          headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek" },
          events: events.map(ev=>{
            const start=ev.startDate, end=(ev.endDate && ev.endDate!==ev.startDate)?ev.endDate:ev.startDate;
            return { id:ev.id, title:`${ev.title||""} (${ev.assignee||""})`, start, end, allDay:true,
                     extendedProps:{ projectId: ev.projectId, assignee: ev.assignee, description: ev.description||"" } };
          }),
          dateClick:(info)=>{ const s=document.getElementById("evt-start"); const e=document.getElementById("evt-end"); if(s) s.value=info.dateStr; if(e) e.value=info.dateStr; },
          eventClick:(info)=>{ const ev=info.event; const pId=ev.extendedProps?.projectId||""; const desc=ev.extendedProps?.description||""; showModal(ev.title, `專案: ${pId}\n負責: ${ev.extendedProps?.assignee||""}\n${desc?('說明: '+desc):''}`); }
        }); calendarInstance.render();
      }

      document.getElementById("new-event-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback=document.getElementById("event-form-feedback");
        if(!isAuthorized()){ showModal("請先登入","請先登入後再新增行事。"); return; }
        const projectId=document.getElementById("evt-project-id").value;
        const title=document.getElementById("evt-title").value;
        const assignee=document.getElementById("evt-assignee").value;
        const startDate=document.getElementById("evt-start").value;
        const endDate=document.getElementById("evt-end").value;
        const description=document.getElementById("evt-desc").value;
        if(!projectId){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先選擇專案。"; return; }
        try{
          await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
            projectId, title, assignee, startDate, endDate, description,
            createdAt: serverTimestamp(), reporterId: currentUserId
          });
          feedback.className="mt-4 text-sm text-green-600"; feedback.textContent="行事已新增！";
          (document.getElementById("new-event-form")).reset(); renderCalendar();
        }catch(err){
          console.error(err); feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="新增行事失敗：資料庫錯誤。";
        }
      });
    }

    // ================== 報告與 AI 彙整 ==================
    function renderReport(){
      const c=document.getElementById("main-content");

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="file-text" class="w-7 h-7 mr-3 text-blue-800"></i> 報告與下載</h2>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">匯出設定</h3>

          <form id="report-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">資料來源</label>
                <select id="report-source" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  <option value="projects">專案</option>
                  <option value="tasks">任務</option>
                  <option value="events">行事曆</option>
                </select>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">開始日期</label><input type="date" id="report-start" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" /></div>
              <div><label class="block text-sm font-medium text-gray-700">結束日期</label><input type="date" id="report-end" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" /></div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
              <label class="inline-flex items-center text-sm text-gray-700"><input type="checkbox" id="report-all" class="mr-2" checked />全部（不篩選日期）</label>

              <button type="button" id="btn-preview" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-800 flex items-center"><i data-lucide="eye" class="w-4 h-4 mr-1"></i> 預覽</button>
              <button type="button" id="btn-download" class="px-3 py-2 bg-blue-800 hover:bg-blue-700 rounded-lg text-white flex items-center"><i data-lucide="download" class="w-4 h-4 mr-1"></i> 下載 CSV</button>
            </div>
          </form>

          <div id="report-preview" class="mt-6"></div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-2 border-b pb-2">AI 專案彙整報導</h3>
          <div class="flex items-center gap-3 mb-3">
            <button type="button" id="btn-ai-week" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">生成本週報導</button>
            <button type="button" id="btn-ai-month" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">生成本月報導</button>
            <button type="button" id="btn-ai-download" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg" disabled>下載 Markdown</button>
          </div>
          <pre id="ai-summary-box" class="whitespace-pre-wrap text-sm text-gray-800 bg-gray-50 p-3 rounded-lg overflow-x-auto"></pre>
        </div>
      `;

      if(window.lucide?.createIcons) lucide.createIcons();

      const allEl   = document.getElementById("report-all");
      const startEl = document.getElementById("report-start");
      const endEl   = document.getElementById("report-end");

      const toggleDateInputs = ()=>{
        const dis = allEl.checked;
        [startEl, endEl].forEach(el=>{
          el.disabled = dis; el.classList.toggle("bg-gray-100", dis);
        });
      };
      allEl.addEventListener("change", toggleDateInputs); toggleDateInputs();

      document.getElementById("btn-preview")?.addEventListener("click", ()=>{
        const res = buildDataset(); renderPreview(res);
      });

      document.getElementById("btn-download")?.addEventListener("click", ()=>{
        const res = buildDataset();
        const { source, rows, start, end, all } = res;
        if(rows.length===0){ showModal("沒有可匯出的資料", "請調整資料來源或日期區間再試。"); return; }
        const { headers } = getHeadersForSource(source);
        const csv = arrayToCsv(headers, rows);
        const stamp = new Date().toISOString().replace(/[-:.TZ]/g,"").slice(0,14);
        const range = all ? "all" : `${(start||"NA").replaceAll("-","")}_${(end||"NA").replaceAll("-","")}`;
        const filename = `${source}_${range}_${stamp}.csv`;
        triggerDownloadCsv(csv, filename);
      });

      document.getElementById("btn-ai-week")?.addEventListener("click", ()=> generateAIReport("week"));
      document.getElementById("btn-ai-month")?.addEventListener("click", ()=> generateAIReport("month"));

      function arrayToCsv(headers, rows){
        const esc=(val)=>{ const s=(val===undefined||val===null)?"":String(val); const needQuote=/[",\r\n]/.test(s); const q=s.replace(/"/g,'""'); return needQuote?`"${q}"`:q; };
        const head=headers.map(esc).join(",");
        const body=rows.map(r=>headers.map(h=>esc(r[h])).join(",")).join("\r\n");
        return head+"\r\n"+body;
      }
      function triggerDownloadCsv(csvText, filename){
        const blob=new Blob(["\ufeff"+csvText],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function getHeadersForSource(source){
        if(source==="projects"){ return { headers:["id","title","manager","budget","personnelBudget","operatingBudget","equipmentBudget","progress","status","createdAt","reporterId"] }; }
        if(source==="tasks"){ return { headers:["id","projectId","taskName","assignee","dueDate","status","createdAt","updatedAt"] }; }
        return { headers:["id","projectId","title","assignee","startDate","endDate","description"] };
      }
      function buildDataset(){
        const source=document.getElementById("report-source").value;
        const all=document.getElementById("report-all").checked;
        const start=startEl.value||""; const end=endEl.value||"";
        let rows=[];
        if(source==="projects"){
          rows=projects.map(p=>({ id:p.id,title:p.title||"",manager:p.manager||"",budget:n(p.budget),personnelBudget:n(p.personnelBudget),operatingBudget:n(p.operatingBudget),equipmentBudget:n(p.equipmentBudget),progress:n(p.progress),status:p.status||"",createdAt:tsToDateStr(p.createdAt),reporterId:p.reporterId||"" }));
          if(!all) rows=rows.filter(r=> inRange(r.createdAt, start, end));
        }else if(source==="tasks"){
          rows=tasks.map(t=>({ id:t.id,projectId:t.projectId||"",taskName:t.taskName||"",assignee:t.assignee||"",dueDate:t.dueDate||"",status:t.status||"",createdAt:tsToDateStr(t.createdAt),updatedAt:tsToDateStr(t.updatedAt) }));
          if(!all) rows=rows.filter(r=> inRange(r.dueDate, start, end));
        }else{
          rows=events.map(ev=>({ id:ev.id,projectId:ev.projectId||"",title:ev.title||"",assignee:ev.assignee||"",startDate:ev.startDate||"",endDate:ev.endDate||"",description:ev.description||"" }));
          if(!all) rows=rows.filter(r=> overlapsRange(r.startDate, r.endDate, start, end));
        }
        return { source, rows, start, end, all };
      }
      function renderPreview(result){
        const box=document.getElementById("report-preview");
        const { source, rows }=result;
        if(rows.length===0){ box.innerHTML='<div class="text-gray-500 text-sm py-4">沒有符合條件的資料。</div>'; return; }
        const { headers }=getHeadersForSource(source); const sample=rows.slice(0,20);
        box.innerHTML=`
          <div class="flex items-center justify-between"><p class="text-sm text-gray-600">共 <span class="font-semibold">${rows.length}</span> 筆，以下僅預覽前 <span class="font-semibold">${sample.length}</span> 筆。</p></div>
          <div class="overflow-x-auto mt-3">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50"><tr>${headers.map(h=>`<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">${escapeHtml(h)}</th>`).join("")}</tr></thead>
              <tbody class="bg-white divide-y divide-gray-200 text-sm">
                ${ sample.map(r=>`<tr>${headers.map(h=>`<td class="px-3 py-2 whitespace-nowrap">${escapeHtml(String(r[h]??""))}</td>`).join("")}</tr>`).join("") }
              </tbody>
            </table>
          </div>`;
      }

      // AI 彙整
      async function generateAIReport(mode){ // "week" | "month"
        const url = AI_SUMMARY_WEBAPP_URL;
        if(!url || /REPLACE/.test(url)) { showModal("未設定 AI 端點", "請先部署 AI Web App URL 後再使用。"); return; }
        const box = document.getElementById("ai-summary-box");
        const dl  = document.getElementById("btn-ai-download");
        box.textContent = "AI 生成中，請稍候..."; dl.disabled = true;

        const today = new Date(); let start, end;
        if(mode==="week"){
          const d = new Date(today); const dow = d.getDay()||7; d.setDate(d.getDate()-(dow-1));
          start = d.toISOString().slice(0,10); const e = new Date(d); e.setDate(e.getDate()+6); end = e.toISOString().slice(0,10);
        }else{
          const d = new Date(today.getFullYear(), today.getMonth(), 1); start = d.toISOString().slice(0,10);
          const e = new Date(today.getFullYear(), today.getMonth()+1, 0); end = e.toISOString().slice(0,10);
        }

        const ps = projects.map(p=>({ id:p.id, title:p.title||"", manager:p.manager||"", budget:n(p.budget), progress:n(p.progress), status:p.status||"" }));
        const ts = tasks.filter(t=> inRange(t.dueDate||"", start, end)).map(t=>({ id:t.id, projectId:t.projectId||"", taskName:t.taskName||"", assignee:t.assignee||"", dueDate:t.dueDate||"", status:t.status||"" }));
        const es = events.filter(ev=> overlapsRange(ev.startDate||"", ev.endDate||ev.startDate||"", start, end)).map(ev=>({ id:ev.id, projectId:ev.projectId||"", title:ev.title||"", assignee:ev.assignee||"", startDate:ev.startDate||"", endDate:ev.endDate||ev.startDate||"", description:ev.description||"" }));

        const payload = { action:"ai_summary", mode, start, end, projects:ps, tasks:ts, events:es };

        try{
          const resp = await fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
          const data = await resp.json().catch(()=> ({}));
          const md = data?.summary || data?.text || "(無法產生報導)";
          box.textContent = md;
          dl.disabled = false;
          dl.onclick = ()=>{
            const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
            const u = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = u; a.download = `project_report_${mode}_${start}_${end}.md`;
            a.click(); URL.revokeObjectURL(u);
          };
        }catch(e){
          console.error(e);
          box.textContent = "AI 產生失敗：" + (e?.message||String(e));
        }
      }
      window.generateAIReport = generateAIReport;
    }

    // ================== 資訊交流（貼文 + 圖片） ==================
    async function uploadCommunityImages(fileList, onProgress){
      const uploaded=[];
      for(const file of fileList){
        if(!file.type?.startsWith("image/")) continue;
        const safeName=file.name.replace(/[^\w.\-() ]+/g,"_");
        const storagePath=`artifacts/${APP_ID}/uploads/community/${currentUserId}/${Date.now()}_${safeName}`;
        const refObj=sRef(storage, storagePath);
        const task=uploadBytesResumable(refObj, file, { contentType:file.type||"image/*", customMetadata:{ ownerUid:currentUserId } });
        await new Promise((resolve,reject)=>{
          task.on("state_changed",
            snap=>{ if(onProgress){ const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100); onProgress(pct,file.name); } },
            reject, resolve
          );
        });
        const url=await getDownloadURL(refObj);
        uploaded.push({ url, storagePath, name:file.name, size:file.size||0, contentType:file.type||"" });
      }
      return uploaded;
    }
    async function createCommunityPost({ text, files }){
      if(!currentUserId){ showModal("請先登入","請先使用 Google 登入再發佈貼文。"); return; }
      const images = files && files.length ? await uploadCommunityImages(files) : [];
      await addDoc(collection(db, COMMUNITY_COLLECTION_PATH), {
        authorUid: currentUserId,
        authorName: userProfile.displayName || userProfile.email || "使用者",
        authorPhotoURL: userProfile.photoURL || "",
        text: text || "",
        images,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }
    async function deleteCommunityPost(postId){
      const post=communityPosts.find(p=>p.id===postId);
      if(!post){ return; }
      if(post.authorUid !== currentUserId){
        showModal("權限不足","只能刪除自己發佈的貼文。"); return;
      }
      if(!confirm("確定要刪除此貼文與其圖片？")) return;
      try{
        for(const img of (post.images||[])){ if(img.storagePath){ await deleteObject(sRef(storage, img.storagePath)); } }
      }catch(e){ console.warn("刪圖警告", e); }
      await deleteDoc(doc(db, COMMUNITY_COLLECTION_PATH, postId));
    }
    window.deleteCommunityPost = deleteCommunityPost;

    function timeAgo(ts){
      const d = ts?.toDate ? ts.toDate() : (typeof ts==='string'? new Date(ts) : new Date());
      const diff = (Date.now() - d.getTime())/1000;
      if(diff<60) return `${Math.floor(diff)} 秒前`;
      if(diff<3600) return `${Math.floor(diff/60)} 分鐘前`;
      if(diff<86400) return `${Math.floor(diff/3600)} 小時前`;
      return d.toLocaleString("zh-TW");
    }

    function renderCommunity(){
      const c=document.getElementById("main-content");
      const canPost=!!currentUserId;

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="messages-square" class="w-7 h-7 mr-3 text-blue-800"></i> 資訊交流</h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1">
            <div class="bg-white p-5 rounded-xl shadow-lg">
              <h3 class="text-lg font-semibold text-gray-800 mb-3">發佈貼文</h3>
              ${ canPost ? `
                <form id="post-form" class="space-y-3">
                  <textarea id="post-text" rows="4" class="w-full rounded-md border-gray-300 p-2 border" placeholder="分享你的想法、文章連結或說明"></textarea>
                  <div>
                    <input type="file" id="post-images" accept="image/*" multiple class="block w-full text-sm text-gray-700"/>
                    <div id="post-upload-progress" class="text-xs text-gray-600 mt-1"></div>
                  </div>
                  <button type="submit" class="w-full py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">發佈</button>
                </form>
              ` : `
                <div class="text-sm text-gray-600">
                  請先登入後即可發佈貼文。
                  <button onclick="signInWithGoogle()" class="ml-2 px-3 py-1 text-white bg-blue-800 rounded-md">使用 Google 登入</button>
                </div>
              `}
            </div>
          </div>

          <div class="lg:col-span-2">
            <div id="post-feed" class="space-y-4">
              ${ communityPosts.length===0 ? `
                <div class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500">目前沒有貼文，成為第一個分享的人吧！</div>
              ` : communityPosts.map(p=>`
                <div class="bg-white p-5 rounded-xl shadow-lg">
                  <div class="flex items-center mb-3">
                    <div class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden mr-3">
                      ${ p.authorPhotoURL ? `<img src="${escapeHtml(p.authorPhotoURL)}" alt="" class="w-full h-full object-cover">` : '' }
                    </div>
                    <div class="flex-1">
                      <div class="font-semibold text-gray-800">${escapeHtml(p.authorName||"使用者")}</div>
                      <div class="text-xs text-gray-500">${timeAgo(p.createdAt)}</div>
                    </div>
                    ${ p.authorUid===currentUserId ? `<button class="text-red-600 text-sm hover:underline" onclick="deleteCommunityPost('${escapeHtml(p.id)}')">刪除</button>` : ``}
                  </div>
                  <div class="text-gray-800 whitespace-pre-wrap mb-3">${escapeHtml(p.text||"")}</div>
                  ${ (p.images||[]).length ? `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                      ${ p.images.map(img=>`<a href="${escapeHtml(img.url)}" target="_blank" class="block"><img src="${escapeHtml(img.url)}" alt="${escapeHtml(img.name||'')}" class="w-full h-32 object-cover rounded-md hover:opacity-90 transition"></a>`).join("") }
                    </div>` : ``}
                </div>`).join("")}
            </div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const form=document.getElementById("post-form");
      if(form){
        form.addEventListener("submit", async (e)=>{
          e.preventDefault();
          if(!currentUserId){ showModal("請先登入","請先使用 Google 登入再發佈貼文。"); return; }
          const text=document.getElementById("post-text").value.trim();
          const files=document.getElementById("post-images").files;
          const progEl=document.getElementById("post-upload-progress");
          try{
            progEl.textContent = files?.length ? "上傳中..." : "";
            await createCommunityPost({ text, files });
            progEl.textContent = "完成";
            form.reset();
            setTimeout(()=>{ progEl.textContent = ""; }, 800);
          }catch(err){
            console.error(err);
            progEl.textContent = `失敗：${err.message}`;
          }
        });
      }
    }

    // ================== 專案詳情（含附件） ==================
    function renderProjectDetails(projectId){
      const container=document.getElementById("main-content");
      if(!projects || projects.length===0){
        container.innerHTML=`
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-blue-800"></i> 專案詳情</h2>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
            <p class="text-gray-700 mb-4">目前沒有任何專案資料。</p>
            <button onclick="setView('dashboard')" class="px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">回儀表板</button>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        return;
      }
      if(!projectId){
        container.innerHTML=`
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-blue-800"></i> 專案詳情</h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-gray-700 mb-4">請選擇要查看的專案：</p>
            <div class="flex items-center gap-3">
              <select id="details-project-select" class="rounded-md border-gray-300 p-2 border flex-1">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||p.id)}</option>`).join("")}
              </select>
              <button id="details-go-btn" class="px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">查看詳情</button>
            </div>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        document.getElementById('details-go-btn')?.addEventListener('click',()=>{
          const sel=document.getElementById('details-project-select'); const val=sel?.value||null;
          if(val) setView('details', val);
        });
        return;
      }

      const project=projects.find(p=>p.id===projectId);
      if(!project){
        container.innerHTML=`
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-blue-800"></i> 專案詳情</h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-red-600 mb-4">找不到專案「${escapeHtml(String(projectId))}」。</p>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        return;
      }

      const progress=Number(project.progress)||0;
      const barColor=progress>=95?"bg-green-600":(progress<50?"bg-orange-600":"bg-blue-800");
      const projectFiles=files.filter(f=>f.projectId===projectId);

      container.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-blue-800"></i> 專案詳情: ${escapeHtml(project.title||project.id)}</h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-3">
            <h3 class="text-xl font-semibold text-blue-800 mb-4 border-b pb-2">基本資訊</h3>
            <p class="text-sm"><strong class="text-gray-600">專案編號:</strong> ${escapeHtml(project.id)}</p>
            <p class="text-sm"><strong class="text-gray-600">專案管理人:</strong> <span class="text-lg font-bold text-green-700">${escapeHtml(project.manager||"")}</span></p>
            <p class="text-sm"><strong class="text-gray-600">預算概算:</strong> ${fmtMoney(project.budget)}</p>
            <div class="text-sm text-gray-700 pl-1">
              <p>・人事費：${fmtMoney(project.personnelBudget||0)}</p>
              <p>・業務費：${fmtMoney(project.operatingBudget||0)}</p>
              <p>・設備費：${fmtMoney(project.equipmentBudget||0)}</p>
            </div>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-blue-800 mb-4 border-b pb-2">流程進度與相關文件</h3>
            <div class="flex items-center space-x-4 mb-4">
              <span class="text-gray-600 font-medium">總進度:</span>
              <div class="flex-grow bg-gray-200 rounded-full h-4">
                <div class="progress-bar h-4 rounded-full ${barColor}" style="width:${progress}%"></div>
              </div>
              <span class="font-bold text-lg ${progress>=95?'text-green-700':'text-blue-800'}">${progress}%</span>
            </div>
            <p class="text-sm text-gray-700">目前狀態: <span class="font-medium text-lg text-red-500">${escapeHtml(project.status||"")}</span></p>

            <div class="mt-6">
              <h4 class="text-md font-semibold text-gray-700">附件上傳</h4>
              <div class="flex items-center gap-2">
                <input type="file" id="file-input" multiple class="block w-full text-sm text-gray-700"/>
                <button id="file-upload-btn" class="px-3 py-2 text-sm bg-blue-800 text-white rounded-lg hover:bg-blue-700">上傳</button>
              </div>
              <div id="file-upload-progress" class="text-xs text-gray-600 mt-2"></div>

              <h4 class="text-md font-semibold text-gray-700 mt-4">附件列表</h4>
              <ul id="file-list" class="list-disc list-inside text-sm text-blue-800 space-y-1 ml-4 mt-2">
                ${
                  projectFiles.length
                  ? projectFiles.map(f=>`
                      <li>
                        <a href="${escapeHtml(f.url)}" target="_blank" class="hover:underline">${escapeHtml(f.name)}</a>
                        <span class="text-gray-500">(${Math.round((Number(f.size)||0)/1024)} KB)</span>
                        ${ (f.reporterId||"")===currentUserId ? `<button class="ml-2 text-red-600 text-xs hover:underline" onclick="deleteProjectFile('${escapeHtml(f.id)}')">刪除</button>` : "" }
                      </li>
                    `).join("")
                  : '<li class="text-gray-500">尚無附件</li>'
                }
              </ul>
            </div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("file-upload-btn")?.addEventListener("click", async ()=>{
        const inp=document.getElementById("file-input");
        const progressEl=document.getElementById("file-upload-progress");
        const fl=inp?.files;

        if(!fl || fl.length===0){ showModal("未選擇檔案","請先選擇檔案再上傳。"); return; }
        if(!isAuthorized()){ showModal("請先登入","請先登入後再上傳。"); return; }

        try{
          progressEl.textContent="上傳中...";
          await uploadProjectFiles(projectId, fl, (pct, name)=>{ progressEl.textContent=`上傳 ${name}：${pct}%`; });
          progressEl.textContent="上傳完成。";
          inp.value="";
        }catch(err){
          console.error(err);
          progressEl.textContent=`上傳失敗：${err.message}`;
        }
      });
    }

    async function uploadProjectFiles(projectId, fileList, onProgress){
      for(const file of fileList){
        const safeName = file.name.replace(/[^\w.\-() ]+/g, "_");
        const storagePath = `artifacts/${APP_ID}/uploads/project_files/${projectId}/${Date.now()}_${safeName}`;
        const refObj = sRef(storage, storagePath);
        const task = uploadBytesResumable(refObj, file, {
          contentType: file.type || "application/octet-stream",
          customMetadata: { ownerUid: currentUserId }
        });
        await new Promise((resolve, reject)=>{
          task.on("state_changed",
            snap => { if(onProgress){ const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100); onProgress(pct, file.name); } },
            reject, resolve
          );
        });
        const url = await getDownloadURL(refObj);
        await addDoc(collection(db, FILES_COLLECTION_PATH), {
          projectId, name: file.name, size: file.size || 0, contentType: file.type || "",
          url, storagePath, uploadedAt: serverTimestamp(), reporterId: currentUserId
        });
      }
    }
    async function deleteProjectFile(fileId){
      if(!isAuthorized()){ showModal("請先登入","請先登入後再操作。"); return; }
      const f = files.find(x=>x.id===fileId); if(!f){ showModal("找不到檔案",""); return; }
      if((f.reporterId||"") !== currentUserId){ showModal("權限限制","僅上傳者可刪除此檔案。"); return; }
      try{
        if(f.storagePath){ await deleteObject(sRef(storage, f.storagePath)); }
        await deleteDoc(doc(db, FILES_COLLECTION_PATH, fileId));
        showModal("刪除成功", f.name);
      }catch(err){
        console.error(err); showModal("錯誤", `刪除檔案失敗：${err.message}`);
      }
    }
    window.deleteProjectFile = deleteProjectFile;

    // 匯出 CSV 共用
    function arrayToCsv(headers, rows){
      const esc=(val)=>{ const s=(val===undefined||val===null)?"":String(val); const needQuote=/[",\r\n]/.test(s); const q=s.replace(/"/g,'""'); return needQuote?`"${q}"`:q; };
      const head=headers.map(esc).join(",");
      const body=rows.map(r=>headers.map(h=>esc(r[h])).join(",")).join("\r\n");
      return head+"\r\n"+body;
    }
    function triggerDownloadCsv(csvText, filename){
      const blob=new Blob(["\ufeff"+csvText],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // 啟動
    window.addEventListener('DOMContentLoaded', ()=>{
      showAppShell(false);
      initFirebase().catch(e=>logDbg('ERR','init failed', e?.message||e));
      if(window.lucide?.createIcons) lucide.createIcons();

      // 開啟 debug 面板快捷鍵（Ctrl+D）
      window.addEventListener('keydown', (ev)=>{
        if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='d'){
          const el=document.getElementById('debug');
          el.style.display = (el.style.display==='block' ? 'none' : 'block');
        }
      });
    });
  </script>
</body>
</html>
