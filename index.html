<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net https://www.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://firebaseinstallations.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src https://www.google.com https://www.gstatic.com https://accounts.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    // Firebase/基本設定
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.appspot.com", // 修正為 appspot.com
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__auth_mode = "password";
    // Power Automate（SharePoint 備份）
    window.__sharepoint_flow_url = "REPLACE_WITH_YOUR_POWER_AUTOMATE_HTTP_TRIGGER_URL";
    // Apps Script Web App（AI 摘要）
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzWaAm7NkrSoj08pkY5YPsPDaN314_QlKrMvlGz76M7-8oXU2IVWyXjeZqAKmOUBqj6qA/exec";
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","Noto Sans TC","sans-serif"] },
          colors: { "primary-blue":"#1e40af","secondary-green":"#059669","accent-orange":"#ea580c" }
        }
      }
    }
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}
    .landing-bg{
      background:
        radial-gradient(1200px 600px at 85% 85%, rgba(124,58,237,0.18), transparent 60%),
        radial-gradient(1000px 500px at 0% 100%, rgba(236,72,153,0.18), transparent 55%),
        linear-gradient(180deg,#ffffff 0%,#f7f7fb 100%);
    }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body class="font-sans bg-gray-100">
  <!-- 登入頁 -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-primary-blue">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>
      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">請先註冊 Email/密碼帳號，之後即可用帳密登入</p>

        <div id="landing-user" class="hidden mt-6">
          <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border">
            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
              <img id="landing-avatar" alt="" class="w-full h-full object-cover hidden">
              <div id="landing-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold">U</div>
            </div>
            <div class="min-w-0">
              <div id="landing-name" class="font-semibold truncate"></div>
              <div id="landing-email" class="text-xs text-gray-500 truncate"></div>
            </div>
          </div>
        </div>

        <div id="email-auth-box" class="mt-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">電子郵件</label>
            <input id="auth-email" type="email" autocomplete="email"
                   class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="you@example.com">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">密碼</label>
            <input id="auth-password" type="password" autocomplete="current-password"
                   class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="至少 6 個字元">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button id="btn-email-signin" type="button"
                    class="w-full py-3 rounded-xl bg-primary-blue hover:bg-blue-700 text-white font-semibold">
              以帳號密碼登入
            </button>
            <button id="btn-email-signup" type="button"
                    class="w-full py-3 rounded-xl bg-secondary-green hover:bg-green-700 text-white font-semibold">
              註冊新帳號
            </button>
          </div>
          <div id="auth-error" class="text-sm text-red-600"></div>
          <div id="landing-loading" class="hidden mt-2 text-center text-sm text-gray-600">處理中，請稍候…</div>
        </div>
      </div>
      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth 進行登入；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- 應用主殼 -->
  <div id="app-shell" class="hidden">
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()"><i data-lucide="panel-left-close" class="w-5 h-5"></i></button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="w-5 h-5"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="tasks" onclick="setView('tasks')"><i data-lucide="calendar-days" class="w-5 h-5"></i><span class="nav-label">Planner</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="w-5 h-5"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="brain" class="w-5 h-5"></i><span class="nav-label">Brain</span></button>
          <button class="nav-item group" data-view="community" onclick="setView('community')"><i data-lucide="messages-square" class="w-5 h-5"></i><span class="nav-label">資訊交流</span></button>
          <button class="nav-item group" data-view="details" onclick="setView('details')"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="nav-label">專案詳情</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm"></div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()"><i data-lucide="log-out" class="w-5 h-5"></i><span class="nav-label">登出</span></button>
      </div>
    </aside>

    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end"><button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">確認</button></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import {
      getAuth, onAuthStateChanged,
      signOut, setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, getDoc, getDocFromServer, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    let db, auth, storage;
    let currentUserId = "";
    let isAuthReady = false;
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const APP_CHECK_SITE_KEY = window.__app_check_site_key || "";
    const AUTH_MODE = (window.__auth_mode || "password").toLowerCase();

    const SHAREPOINT_FLOW_URL   = window.__sharepoint_flow_url || "";
    const AI_SUMMARY_WEBAPP_URL = window.__ai_summary_webapp_url || "";

    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;
    const WATCHERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_watchers`;

    const DEFAULT_MANAGERS = ["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];
    const ROLE_OPTIONS = [
      "行政管理員","物理治療師","研究助理","個案管理師","專責值班主治醫師",
      "程式設計師","臨床心理師","醫檢師","護理師"
    ];
    let managers = [];

    let currentView = "dashboard";
    let projects = [];
    let tasks = [];
    let events = [];
    let files = [];
    let communityPosts = [];
    let budgetCaps = { personnelCap: 0, operatingCap: 0, equipmentCap: 0 };
    let selectedProjectId = null;
    let calendarInstance = null;
    let miniCalendarInstance = null;
    let detailsWatchersUnsub = null;

    // 專案詳情主持人篩選狀態
    let detailsFilterPM = "";

    // 小工具
    function escapeHtml(str){
      if(str==null) return "";
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;")
                        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function showModal(title, message){
      document.getElementById("modal-title").textContent = title || "提示";
      document.getElementById("modal-message").textContent = message || "";
      const modal = document.getElementById("custom-modal");
      const wrapper = document.getElementById("modal-content-wrapper");
      document.getElementById("modal-confirm-btn").onclick = () => {
        wrapper.classList.remove("scale-100","opacity-100");
        wrapper.classList.add("scale-95","opacity-0");
        setTimeout(()=>modal.classList.add("hidden"),300);
      };
      modal.classList.remove("hidden"); modal.classList.add("flex");
      setTimeout(()=>{ wrapper.classList.remove("scale-95","opacity-0"); wrapper.classList.add("scale-100","opacity-100"); },50);
    }
    function n(v){ return Number(v)||0; }
    function toCleanText(v){ return (v ?? "").toString().trim(); }
    function toNonNegativeNumber(v){
      const num = Number(v);
      if(!Number.isFinite(num)) return 0;
      return Math.max(0, num);
    }
    function toProgressPercent(v){
      const num = Number(v);
      if(!Number.isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    }
    function numbersEqual(a, b, epsilon = 0.0001){
      return Math.abs((Number(a) || 0) - (Number(b) || 0)) <= epsilon;
    }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function managerOptionsHtml(selected = ""){
      const list = (managers.length>0 ? managers.map(m=>m.name).filter(Boolean) : DEFAULT_MANAGERS);
      return list.map(m => `<option value="${escapeHtml(m)}" ${m===selected?'selected':''}>${escapeHtml(m)}</option>`).join("");
    }
    function rolesCheckboxesHtml(selectedArr){
      const set = new Set((selectedArr||[]).map(String));
      return ROLE_OPTIONS.map(r => `
        <label class="inline-flex items-center gap-2 mr-4 mb-2">
          <input type="checkbox" name="proj-role" value="${escapeHtml(r)}" ${set.has(r)?"checked":""}>
          <span class="text-sm">${escapeHtml(r)}</span>
        </label>
      `).join("");
    }
    function isoToLocale(s){
      if(!s) return "";
      try{ return new Date(s).toLocaleString(); }catch{ return s; }
    }
    function arrayToCsv(headers, rows){
      const esc = (val)=>{ const s = (val===undefined || val===null) ? "" : String(val);
        const needQuote = /[",\r\n]/.test(s); const q = s.replace(/"/g, '""'); return needQuote ? `"${q}"` : q; };
      const head = headers.map(esc).join(",");
      const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\r\n");
      return head + "\r\n" + body;
    }
    function triggerDownloadCsv(csvText, filename){
      const blob = new Blob(["\ufeff" + csvText], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Teams 通知（可略）
    const IS_PAGES = location.hostname.endsWith(".github.io");
    async function sendTeamsNotification(title,text,color="0078D4"){
      if(IS_PAGES) return;
      try{
        const resp = await fetch("/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title,text,themeColor:color})});
        if(!resp.ok){ console.warn("notify failed", resp.status, await resp.text()); }
      }catch(e){ console.warn("notify error", e); }
    }

    // SharePoint 備份：新增專案後呼叫（非阻斷）
    async function backupProjectToSharePoint(p){
      if(!SHAREPOINT_FLOW_URL || /REPLACE/.test(SHAREPOINT_FLOW_URL)) return;
      const body = {
        id: p.id, title: p.title, manager: p.manager,
        personnelBudget: n(p.personnelBudget), operatingBudget: n(p.operatingBudget), equipmentBudget: n(p.equipmentBudget),
        budget: n(p.budget), progress: n(p.progress), status: String(p.status||""),
        reporterId: currentUserId, createdAt: new Date().toISOString()
      };
      try{
        await fetch(SHAREPOINT_FLOW_URL,{ method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" }, mode:"no-cors", body: JSON.stringify(body) });
      }catch(e){ console.warn("SharePoint backup failed:", e); }
    }

    // AI 摘要（Brain）
    async function generateAIReport(mode){
      const url = AI_SUMMARY_WEBAPP_URL;
      if(!url || /REPLACE/.test(url)) { showModal("未設定 AI 端點", "請先部署 AI Web App URL 後再使用。"); return; }
      const box = document.getElementById("ai-summary-box");
      const dl  = document.getElementById("btn-ai-download");
      if (box) box.textContent = "AI 生成中，請稍候...";
      if (dl) dl.disabled = true;

      const today = new Date(); let start, end;
      if(mode==="week"){
        const d = new Date(today); const dow = d.getDay()||7; d.setDate(d.getDate()-(dow-1));
        start = d.toISOString().slice(0,10); const e = new Date(d); e.setDate(e.getDate()+6); end = e.toISOString().slice(0,10);
      }else{
        const d = new Date(today.getFullYear(), today.getMonth(), 1); start = d.toISOString().slice(0,10);
        const e = new Date(today.getFullYear(), today.getMonth()+1, 0); end = e.toISOString().slice(0,10);
      }

      const ps = projects.map(p=>({ id:p.id, title:p.title||"", manager:p.manager||"", budget:n(p.budget), progress:n(p.progress), status:p.status||"" }));
      const ts = tasks.filter(t=> (t.dueDate||"")>=start && (t.dueDate||"")<=end).map(t=>({
        id:t.id, projectId:t.projectId||"", taskName:t.taskName||"",
        assignee: (projects.find(p=>p.id===t.projectId)?.manager || ""), // 負責人=專案管理人
        projectManager: t.projectManager||"", dueDate:t.dueDate||"", status:t.status||""
      }));
      const es = events.filter(ev=>{
        const s = ev.startDate || ev.date || ""; const e = ev.endDate || ev.startDate || ev.date || s;
        return (!start||s<=end)&&(!end||e>=start);
      }).map(ev=>({ id:ev.id, projectId:ev.projectId||"", title:ev.title||"", assignee:ev.assignee||"", startDate:ev.startDate||ev.date||"", endDate:ev.endDate||ev.startDate||ev.date||"" }));

      try{
        const payload = { action:"ai_summary", mode, start, end, projects:ps, tasks:ts, events:es };
        const resp = await fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=> ({}));
        const md = data?.summary || data?.text || "(無法產生報導)";
        if (box) box.textContent = md;
        if (dl){
          dl.disabled = false;
          dl.onclick = ()=>{
            const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
            const u = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = u; a.download = `project_report_${mode}_${start}_${end}.md`; a.click(); URL.revokeObjectURL(u);
          };
        }
      }catch(e){
        console.error(e); if (box) box.textContent = "AI 產生失敗：" + (e?.message||String(e));
      }
    }

    // 初始化 Firebase
    async function initFirebase(){
      if(!firebaseConfig) { console.error("缺少 Firebase 設定"); return; }
      const app = initializeApp(firebaseConfig);
      if(APP_CHECK_SITE_KEY){
        initializeAppCheck(app, { provider: new ReCaptchaV3Provider(APP_CHECK_SITE_KEY), isTokenAutoRefreshEnabled: true });
      }
      db = getFirestore(app);
      auth = getAuth(app);
      storage = getStorage(app);

      await setPersistence(auth, browserLocalPersistence);

      document.getElementById("btn-email-signin")?.addEventListener("click", signInWithEmailPassword);
      document.getElementById("btn-email-signup")?.addEventListener("click", signUpWithEmailPassword);

      onAuthStateChanged(auth, async (user)=>{
        isAuthReady = true;
        if(user){
          currentUserId = user.uid;
          userProfile = { displayName: user.displayName || "", email: user.email || "", photoURL: user.photoURL || "" };
          updateUserUI();
          showAppShell();
          if(!listenersStarted) startRealtimeListeners();
        }else{
          currentUserId = ""; userProfile = { displayName:"", email:"", photoURL:"" }; showLanding();
        }
      });

      // 診斷工具（於 Console 呼叫）
      window.__debugTestWrite = async () => {
        try {
          const id = String(Date.now());
          const ref = doc(db, `artifacts/${APP_ID}/public/debug/test_writes`, id);
          await setDoc(ref, { ok: true, at: serverTimestamp(), uid: currentUserId || null });
          console.log("[debugTestWrite] OK:", ref.path);
          alert("寫入成功：" + ref.path);
        } catch (e) {
          console.error("[debugTestWrite] FAIL:", e);
          alert("寫入失敗：" + (e?.message || String(e)));
        }
      };
      window.__debugTestStorage = async ()=>{
        try{
          if(!currentUserId) throw new Error("未登入");
          const blob = new Blob(["hello"], {type:"text/plain"});
          const f = new File([blob], "debug.txt", {type:"text/plain"});
          const url = await uploadImageAndGetUrl(f);
          alert("Storage OK，URL = " + url);
        }catch(e){
          alert("Storage 測試失敗：" + (e?.message || String(e)));
        }
      };
    }

    // 登入/註冊
    function setAuthLoading(loading) {
      const loadingEl = document.getElementById("landing-loading");
      const btnIn = document.getElementById("btn-email-signin");
      const btnUp = document.getElementById("btn-email-signup");
      if (loadingEl) loadingEl.classList.toggle("hidden", !loading);
      if (btnIn) btnIn.disabled = loading;
      if (btnUp) btnUp.disabled = loading;
    }
    function showAuthError(msg) {
      const box = document.getElementById("auth-error");
      if (box) box.textContent = msg || "";
    }
    async function signUpWithEmailPassword() {
      const email = (document.getElementById("auth-email")?.value || "").trim();
      const password = document.getElementById("auth-password")?.value || "";
      showAuthError("");
      if (!email || !password) { showAuthError("請輸入 email 與密碼"); return; }
      if (password.length < 6) { showAuthError("密碼需至少 6 個字元"); return; }
      try {
        setAuthLoading(true);
        await createUserWithEmailAndPassword(auth, email, password);
        showModal("註冊成功", "已成功建立帳號並登入。");
      } catch (e) {
        console.error(e);
        if ((e?.code || "").includes("email-already-in-use")) showAuthError("此 Email 已被註冊，請直接登入");
        else if ((e?.code || "").includes("invalid-email")) showAuthError("Email 格式不正確");
        else if ((e?.code || "").includes("weak-password")) showAuthError("密碼強度不足，請至少 6 個字元");
        else showAuthError(`註冊失敗：${e?.message || String(e)}`);
      } finally { setAuthLoading(false); }
    }
    async function signInWithEmailPassword() {
      const email = (document.getElementById("auth-email")?.value || "").trim();
      const password = document.getElementById("auth-password")?.value || "";
      showAuthError("");
      if (!email || !password) { showAuthError("請輸入 email 與密碼"); return; }
      try {
        setAuthLoading(true);
        await signInWithEmailAndPassword(auth, email, password);
        showModal("登入成功", "歡迎回來！正在載入您的專案資料...");
      } catch (e) {
        console.error(e);
        if ((e?.code || "").includes("user-not-found")) showAuthError("找不到此帳號，請先註冊");
        else if ((e?.code || "").includes("wrong-password")) showAuthError("密碼錯誤");
        else if ((e?.code || "").includes("invalid-credential")) showAuthError("帳號或密碼不正確");
        else if ((e?.code || "").includes("invalid-email")) showAuthError("Email 格式不正確");
        else showAuthError(`登入失敗：${e?.message || String(e)}`);
      } finally { setAuthLoading(false); }
    }

    // 顯示切換
    function updateUserUI(){
      const name = userProfile.displayName || userProfile.email || "使用者";
      const email = userProfile.email || "";
      const photoURL = userProfile.photoURL || "";
      const initial = name.charAt(0).toUpperCase();

      const landingUser = document.getElementById("landing-user");
      const landingName = document.getElementById("landing-name");
      const landingEmail = document.getElementById("landing-email");
      const landingAvatar = document.getElementById("landing-avatar");
      const landingInitial = document.getElementById("landing-initial");

      if(currentUserId){
        if(landingUser) landingUser.classList.remove("hidden");
        if(landingName) landingName.textContent = name;
        if(landingEmail) landingEmail.textContent = email;
        if(photoURL){
          if(landingAvatar){ landingAvatar.src = photoURL; landingAvatar.classList.remove("hidden"); }
          if(landingInitial) landingInitial.classList.add("hidden");
        }else{
          if(landingAvatar) landingAvatar.classList.add("hidden");
          if(landingInitial){ landingInitial.textContent = initial; landingInitial.classList.remove("hidden"); }
        }
      }

      const userDisplayName = document.getElementById("user-display-name");
      const userEmail = document.getElementById("user-email");
      const userAvatar = document.getElementById("user-avatar");
      const userInitial = document.getElementById("user-initial");

      if(userDisplayName) userDisplayName.textContent = name;
      if(userEmail) userEmail.textContent = email;
      if(photoURL){
        if(userAvatar){ userAvatar.src = photoURL; userAvatar.classList.remove("hidden"); }
        if(userInitial) userInitial.classList.add("hidden");
      }else{
        if(userAvatar) userAvatar.classList.add("hidden");
        if(userInitial){ userInitial.textContent = initial; userInitial.classList.remove("hidden"); }
      }

      if(window.lucide?.createIcons) lucide.createIcons();
    }
    function showLanding(){
      document.getElementById("landing")?.classList.remove("hidden");
      document.getElementById("app-shell")?.classList.add("hidden");
      if(window.lucide?.createIcons) lucide.createIcons();
    }
    function showAppShell(){
      document.getElementById("landing")?.classList.add("hidden");
      document.getElementById("app-shell")?.classList.remove("hidden");
      if(currentView!=="dashboard") currentView = "dashboard";
      renderDashboard();
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // 登出
    window.appSignOut = async function(){ try{ await signOut(auth); }catch(e){ console.error(e); } };

    // 側欄切換
    window.toggleSidebar = function(){
      const sidebar = document.getElementById("app-sidebar");
      const main = document.getElementById("app-main");
      if(!sidebar || !main) return;
      const expanded = sidebar.classList.contains("expanded");
      sidebar.classList.toggle("expanded", !expanded);
      sidebar.classList.toggle("collapsed", expanded);
      main.style.marginLeft = expanded ? "72px" : "240px";
    };

    // 即時監聽
    function startRealtimeListeners(){
      if(!db || listenersStarted) return;
      listenersStarted = true;

      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{
        projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
        rerenderByView();
      });
      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{
        tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        rerenderByView();
      });
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), (snap)=>{
        events = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(currentView==="calendar") renderCalendar();
        if(currentView==="dashboard") renderDashboard();
      });
      onSnapshot(query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")), (snap)=>{
        files = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(currentView==="details") renderProjectDetails(selectedProjectId);
      });
      onSnapshot(doc(db, SETTINGS_DOC_PATH), (snap)=>{
        if(snap.exists()){
          const d = snap.data()||{}; budgetCaps = { personnelCap:n(d.personnelCap), operatingCap:n(d.operatingCap), equipmentCap:n(d.equipmentCap) };
        }else{
          budgetCaps = { personnelCap:0, operatingCap:0, equipmentCap:0 };
        }
        if(currentView==="dashboard") renderDashboard();
      });
      onSnapshot(query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")), (snap)=>{
        managers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        rerenderByView();
      });
      onSnapshot(query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{
        communityPosts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        if(currentView==="community") renderCommunity();
        if(typeof window.__rerenderCommunityFeed === 'function') window.__rerenderCommunityFeed();
      });
    }

    // 視圖切換
    window.setView = function(view, arg){
      currentView = view;
      setActiveByView(view);
      if(view==="dashboard"){ renderDashboard(); }
      else if(view==="creation"){ renderProjectCreation(); }
      else if(view==="details"){
        selectedProjectId = (typeof arg === "string" && arg) ? arg : (projects[0]?.id || null);
        const proj = projects.find(p=>p.id===selectedProjectId);
        detailsFilterPM = proj?.manager || "";
        renderProjectDetails(selectedProjectId);
      }
      else if(view==="tasks"){ renderTaskManagement(); }
      else if(view==="calendar"){ renderCalendar(); }
      else if(view==="report"){ renderReport(); }
      else if(view==="community"){ renderCommunity(); }
    };
    function setActiveByView(view){
      document.querySelectorAll("#app-sidebar .nav-item").forEach(btn=>{
        const v = btn.getAttribute("data-view");
        if(v){ btn.classList.toggle("active", v===view); }
      });
    }
    function rerenderByView(){
      if(currentView==="dashboard") renderDashboard();
      if(currentView==="creation") renderProjectCreation();
      if(currentView==="details") renderProjectDetails(selectedProjectId);
      if(currentView==="tasks") renderTaskManagement();
      if(currentView==="calendar") renderCalendar();
      if(currentView==="report") renderReport();
      if(currentView==="community") renderCommunity();
    }

    // 儀表板
    function renderDashboard(){
      const c = document.getElementById("main-content");
      if(!c) return;

      if (miniCalendarInstance) { try { miniCalendarInstance.destroy(); } catch(_) {} miniCalendarInstance = null; }

      const totalProjects = projects.length;
      const completed = projects.filter(p => (n(p.progress)) >= 95).length;
      const totalBudget = projects.reduce((s,p)=>s+n(p.budget),0);

      let personnelUsed = 0, operatingUsed = 0, equipmentUsed = 0;
      for(const p of projects){
        const pu = ('personnelUsed' in p) ? n(p.personnelUsed) : 0;
        const ou = ('operatingUsed' in p) ? n(p.operatingUsed) : 0;
        const eu = ('equipmentUsed' in p) ? n(p.equipmentUsed) : 0;
        personnelUsed += pu; operatingUsed += ou; equipmentUsed += eu;
      }
      const pc = n(budgetCaps.personnelCap), oc = n(budgetCaps.operatingCap), ec = n(budgetCaps.equipmentCap);
      const pRate = pc>0 ? clamp01(personnelUsed/pc) : 0;
      const oRate = oc>0 ? clamp01(operatingUsed/oc) : 0;
      const eRate = ec>0 ? clamp01(equipmentUsed/ec) : 0;
      const pRemain = pc - personnelUsed, oRemain = oc - operatingUsed, eRemain = ec - equipmentUsed;
      const barClass = (rate, remain)=> remain>=0 ? (rate>=0.95 ? "bg-yellow-400" : "bg-primary-blue") : "bg-red-500";

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案儀表板
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between">
              <i data-lucide="layers" class="w-8 h-8 text-primary-blue"></i>
              <span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span>
            </div>
            <p class="text-gray-500 mt-2">總專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-green">
            <div class="flex items-center justify-between">
              <i data-lucide="check-circle" class="w-8 h-8 text-secondary-green"></i>
              <span class="text-3xl font-extrabold text-gray-900">${completed}</span>
            </div>
            <p class="text-gray-500 mt-2">接近完成專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-accent-orange">
            <div class="flex items-center justify-between">
              <i data-lucide="wallet" class="w-8 h-8 text-accent-orange"></i>
              <span class="text-xl font-extrabold text-gray-900">${fmtMoney(totalBudget)}</span>
            </div>
            <p class="text-gray-500 mt-2">所有專案的預算概算總計</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費已用</div><div class="text-sm text-gray-500">${fmtMoney(personnelUsed)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate, pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>占上限 ${(pRate*100).toFixed(0)}%</span><span>${pRemain>=0 ? `剩餘：${fmtMoney(pRemain)}` : `超支：${fmtMoney(-pRemain)}`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費已用</div><div class="text-sm text-gray-500">${fmtMoney(operatingUsed)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate, oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>占上限 ${(oRate*100).toFixed(0)}%</span><span>${oRemain>=0 ? `剩餘：${fmtMoney(oRemain)}` : `超支：${fmtMoney(-oRemain)}`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費已用</div><div class="text-sm text-gray-500">${fmtMoney(equipmentUsed)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate, eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>占上限 ${(eRate*100).toFixed(0)}%</span><span>${eRemain>=0 ? `剩餘：${fmtMoney(eRemain)}` : `超支：${fmtMoney(-eRemain)}`}</span></div>
          </div>
        </div>

        <div class="project-card bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i data-lucide="calendar" class="w-5 h-5 mr-2 text-primary-blue"></i> 行事曆（本月）
          </h3>
          <div id="mini-calendar" class="rounded-lg border bg-white" style="min-height:520px;"></div>
          <div class="mt-3 text-right">
            <button class="inline-flex items-center gap-2 text-primary-blue hover:text-blue-700 text-sm" onclick="setView('calendar')">
              <i data-lucide="arrow-right" class="w-4 h-4"></i> 前往完整行事曆
            </button>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">所有專案概覽</h3>
          ${
            totalProjects===0 ? `
            <div class="text-center py-10">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
              <p class="text-lg text-gray-600">目前沒有專案資料。</p>
              <button onclick="setView('creation')" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 新增第一個專案
              </button>
            </div>` : `
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號/名稱</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專案管理人</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">進度</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">即時狀態</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${projects.map(p=>{
                    const prog = n(p.progress);
                    const bar = prog>=95 ? "bg-secondary-green" : (prog<50?"bg-accent-orange":"bg-primary-blue");
                    const badge = prog>=95 ? "bg-secondary-green/10 text-secondary-green" : (prog<50?"bg-accent-orange/10 text-accent-orange":"bg-primary-blue/10 text-primary-blue");
                    return `
                    <tr>
                      <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-blue hover:underline cursor-pointer" onclick="setView('details','${escapeHtml(p.id)}')">
                        <div class="text-xs text-gray-500">${escapeHtml(p.id)}</div>${escapeHtml(p.title||"")}
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800">${escapeHtml(p.manager||"")}</td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <div class="w-32 bg-gray-200 rounded-full h-2.5"><div class="progress-bar h-2.5 rounded-full ${bar}" style="width:${prog}%"></div></div>
                        <span class="text-xs text-gray-500 mt-1 inline-block">${prog}%</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badge}">${escapeHtml(p.status||"")}</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <button onclick="setView('details','${escapeHtml(p.id)}')" class="text-primary-blue hover:text-blue-700 text-sm">查看詳情</button>
                      </td>
                    </tr>`;}).join("")}
                </tbody>
              </table>
            </div>`}
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      // 迷你行事曆
      const calEl = document.getElementById("mini-calendar");
      if (calEl && window.FullCalendar?.Calendar) {
        const evs = (events||[]).map(ev => ({
          id: ev.id,
          title: `${ev.title || "事件"}${ev.projectId ? `（${ev.projectId}）` : ""}`,
          start: ev.startDate || ev.date || "",
          end: ev.endDate || ev.startDate || ev.date || "",
          allDay: true
        }));

        miniCalendarInstance = new FullCalendar.Calendar(calEl, {
          initialView: "dayGridMonth",
          height: "auto",
          headerToolbar: { left: "prev,next today", center: "title", right: "" },
          events: evs, locale: "zh-tw", buttonIcons: false,
          buttonText: { today: "本月", prev: "上個月", next: "下個月" }, firstDay: 1
        });
        miniCalendarInstance.render();
      }
    }

    // 新增專案：加入 needIT / requiredRoles；強化錯誤顯示與成功驗證
    function isValidProjectId(id){ return /^[A-Za-z0-9_-]{3,64}$/.test(id||""); }
    async function handleNewProjectSubmission(e){
      e.preventDefault();
      const feedback = document.getElementById("project-form-feedback");
      feedback.className = "text-sm";
      feedback.textContent = "";
      if(!currentUserId){
        feedback.className="text-sm text-red-600";
        feedback.textContent="請先登入後再新增專案。";
        showModal("請先登入","請先登入後再新增專案。");
        return;
      }

      const projectId = toCleanText(document.getElementById("proj-id")?.value);
      const title = toCleanText(document.getElementById("proj-title")?.value);
      const selectedManager = toCleanText(document.getElementById("proj-manager")?.value);
      const typedManager = toCleanText(document.getElementById("proj-manager-new")?.value);
      const manager = toCleanText(typedManager || selectedManager);

      const personnelBudget = toNonNegativeNumber(document.getElementById("proj-personnel")?.value);
      const operatingBudget = toNonNegativeNumber(document.getElementById("proj-operating")?.value);
      const equipmentBudget = toNonNegativeNumber(document.getElementById("proj-equipment")?.value);
      const budget = personnelBudget + operatingBudget + equipmentBudget;
      const progress = toProgressPercent(document.getElementById("proj-progress")?.value);
      const status = toCleanText(document.getElementById("proj-status")?.value);
      const needIT = !!document.getElementById("proj-needit")?.checked;
      const requiredRoles = Array.from(document.querySelectorAll("#new-project-form input[name='proj-role']:checked"))
        .map(el => toCleanText(el.value))
        .filter(Boolean);

      const personnelField = document.getElementById("proj-personnel");
      if(personnelField) personnelField.value = personnelBudget;
      const operatingField = document.getElementById("proj-operating");
      if(operatingField) operatingField.value = operatingBudget;
      const equipmentField = document.getElementById("proj-equipment");
      if(equipmentField) equipmentField.value = equipmentBudget;
      const budgetField = document.getElementById("proj-budget");
      if(budgetField) budgetField.value = budget;
      const progressField = document.getElementById("proj-progress");
      if(progressField) progressField.value = progress;

      if(!isValidProjectId(projectId)){
        feedback.className="mt-2 text-sm text-red-600"; feedback.textContent="格式錯誤：專案編號僅能包含英數字、底線、連字號，長度 3–64。"; return;
      }
      if(projects.some(p=>p.id===projectId)){
        feedback.className="mt-2 text-sm text-red-600"; feedback.textContent=`錯誤：專案編號 ${projectId} 已存在！`; return;
      }
      if(!title){
        feedback.className="mt-2 text-sm text-red-600"; feedback.textContent="請輸入專案名稱。"; return;
      }
      if(!manager){
        feedback.className="mt-2 text-sm text-red-600"; feedback.textContent="請選擇或輸入主持人。"; return;
      }

      try{
        // 新主持人自動加入名單
        if(typedManager){
          const exists = managers.some(m => (m.name||"") === typedManager);
          if(!exists){
            await addDoc(collection(db, MANAGERS_COLLECTION_PATH), {
              name: typedManager, email:"", title:"", createdAt: serverTimestamp(), reporterId: currentUserId
            });
          }
        }

        const payload = {
          id: projectId, title, manager,
          budget, personnelBudget, operatingBudget, equipmentBudget,
          personnelUsed: 0, operatingUsed: 0, equipmentUsed: 0,
          needIT, requiredRoles,
          progress, status, proposer: manager, manpower: 0, type:"手動輸入",
          createdAt: serverTimestamp(), reporterId: currentUserId
        };

        const target = doc(db, PROJECTS_COLLECTION_PATH, projectId);
        await setDoc(target, payload);
        console.log("[createProject] setDoc OK:", target.path, payload);

        // 回讀驗證
        let check;
        try{
          check = await getDocFromServer(target);
        }catch(serverErr){
          console.warn("[createProject] getDocFromServer failed, fallback to cache", serverErr);
          check = await getDoc(target);
        }
        if(!check.exists()){
          throw new Error("寫入後驗證失敗：資料庫未讀到新專案。請檢查 Firestore 規則或網路。");
        }

        let saved = check.data() || {};
        const desired = {
          title,
          manager,
          personnelBudget,
          operatingBudget,
          equipmentBudget,
          budget,
          progress,
          status,
          needIT,
          requiredRoles: requiredRoles.slice()
        };
        const mismatchNames = [];
        const fixPayload = {};
        if(toCleanText(saved.title) !== desired.title){ mismatchNames.push("專案名稱"); fixPayload.title = desired.title; }
        if(toCleanText(saved.manager) !== desired.manager){ mismatchNames.push("專案管理人"); fixPayload.manager = desired.manager; }
        if(!numbersEqual(toNonNegativeNumber(saved.personnelBudget), desired.personnelBudget)){ mismatchNames.push("人事費預算"); fixPayload.personnelBudget = desired.personnelBudget; }
        if(!numbersEqual(toNonNegativeNumber(saved.operatingBudget), desired.operatingBudget)){ mismatchNames.push("業務費預算"); fixPayload.operatingBudget = desired.operatingBudget; }
        if(!numbersEqual(toNonNegativeNumber(saved.equipmentBudget), desired.equipmentBudget)){ mismatchNames.push("設備費預算"); fixPayload.equipmentBudget = desired.equipmentBudget; }
        if(!numbersEqual(toNonNegativeNumber(saved.budget), desired.budget)){ mismatchNames.push("預算概算"); fixPayload.budget = desired.budget; }
        if(!numbersEqual(toProgressPercent(saved.progress), desired.progress)){ mismatchNames.push("進度"); fixPayload.progress = desired.progress; }
        if(toCleanText(saved.status) !== desired.status){ mismatchNames.push("狀態"); fixPayload.status = desired.status; }
        if(!!saved.needIT !== desired.needIT){ mismatchNames.push("是否需要資訊人員"); fixPayload.needIT = desired.needIT; }
        const savedRoles = Array.isArray(saved.requiredRoles) ? saved.requiredRoles.map(String).sort() : [];
        const expectedRoles = desired.requiredRoles.map(String).sort();
        if(savedRoles.join("|") !== expectedRoles.join("|")){
          mismatchNames.push("需要的人力");
          fixPayload.requiredRoles = desired.requiredRoles.slice();
        }

        if(mismatchNames.length){
          await updateDoc(target, fixPayload);
          try{
            saved = (await getDocFromServer(target)).data() || saved;
          }catch(retryErr){
            console.warn("[createProject] post-fix verification failed, fallback to cache", retryErr);
            const retry = await getDoc(target);
            if(retry.exists()) saved = retry.data() || saved;
          }

          const stillMismatch = [];
          if(toCleanText(saved.title) !== desired.title) stillMismatch.push("專案名稱");
          if(toCleanText(saved.manager) !== desired.manager) stillMismatch.push("專案管理人");
          if(!numbersEqual(toNonNegativeNumber(saved.personnelBudget), desired.personnelBudget)) stillMismatch.push("人事費預算");
          if(!numbersEqual(toNonNegativeNumber(saved.operatingBudget), desired.operatingBudget)) stillMismatch.push("業務費預算");
          if(!numbersEqual(toNonNegativeNumber(saved.equipmentBudget), desired.equipmentBudget)) stillMismatch.push("設備費預算");
          if(!numbersEqual(toNonNegativeNumber(saved.budget), desired.budget)) stillMismatch.push("預算概算");
          if(!numbersEqual(toProgressPercent(saved.progress), desired.progress)) stillMismatch.push("進度");
          if(toCleanText(saved.status) !== desired.status) stillMismatch.push("狀態");
          if(!!saved.needIT !== desired.needIT) stillMismatch.push("是否需要資訊人員");
          const savedRolesAfter = Array.isArray(saved.requiredRoles) ? saved.requiredRoles.map(String).sort() : [];
          if(savedRolesAfter.join("|") !== expectedRoles.join("|")) stillMismatch.push("需要的人力");

          if(stillMismatch.length){
            throw new Error(`寫入後驗證失敗：欄位仍不一致（${stillMismatch.join("、")}）。`);
          }
        }

        // SharePoint 備份（非阻斷）
        backupProjectToSharePoint(payload);

        const correctedSummary = mismatchNames.length ? `（已自動校正：${mismatchNames.join("、")}）` : "";
        showModal("成功",`專案新增成功！已同步備份（SharePoint Flow），並通過欄位驗證。${correctedSummary}`);
        feedback.className="mt-2 text-sm text-green-600";
        feedback.textContent = `專案新增成功並驗證無誤。${mismatchNames.length ? `已自動修正欄位：${mismatchNames.join("、")}` : ""}`;
        (document.getElementById("new-project-form"))?.reset();
        document.getElementById("proj-budget").value = 0;
        const savedProject = {
          ...saved,
          id: projectId,
          title,
          manager,
          budget,
          personnelBudget,
          operatingBudget,
          equipmentBudget,
          progress,
          status,
          needIT,
          requiredRoles
        };
        projects = [savedProject, ...projects.filter(p => p.id !== projectId)];
        rerenderByView();

      }catch(err){
        console.error("[createProject] ERROR:", err);
        const msg = (err?.code ? `[${err.code}] ` : "") + (err?.message || String(err));
        feedback.className="mt-2 text-sm text-red-600";
        feedback.textContent = `專案新增失敗：${msg}。請開啟 Console/Network 截圖錯誤給我。`;
      }
    }

    // 新增/編輯專案頁（含 needIT / requiredRoles）
    function renderProjectCreation(){
      const c = document.getElementById("main-content");
      if(!c) return;
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="folder-plus" class="w-7 h-7 mr-3 text-primary-blue"></i> 新增/編輯專案資料
        </h2>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增專案</h3>
          <form id="new-project-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">專案編號（唯一）</label>
              <input type="text" id="proj-id" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="例如 P-2025-001"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">專案名稱</label>
              <input type="text" id="proj-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">專案管理人（= 任務負責人）</label>
              <select id="proj-manager" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${ managerOptionsHtml() }
              </select>
              <label class="block text-xs font-medium text-gray-500 mt-2">新增主持人（選填；若填寫則優先採用此值並加入人員名單）</label>
              <input type="text" id="proj-manager-new" placeholder="輸入主持人姓名" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">人事費預算 (NTD)</label>
                <input type="number" id="proj-personnel" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">業務費預算 (NTD)</label>
                <input type="number" id="proj-operating" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">設備費預算 (NTD)</label>
                <input type="number" id="proj-equipment" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">預算概算（自動合計）</label>
              <input type="number" id="proj-budget" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border bg-gray-100" readonly/>
              <p class="text-xs text-gray-500 mt-1">預算概算 = 人事 + 業務 + 設備</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">初始進度 (%)</label>
                <input type="number" id="proj-progress" min="0" max="100" value="0" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">初始狀態描述</label>
                <input type="text" id="proj-status" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="例如：啟動、規劃中、進行中"/>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">是否需要資訊人員</label>
                <label class="inline-flex items-center gap-2 mt-2">
                  <input type="checkbox" id="proj-needit">
                  <span class="text-sm">需要資訊人員</span>
                </label>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">需要的人力（可複選）</label>
                <div id="proj-roles-box" class="mt-2 flex flex-wrap">
                  ${ rolesCheckboxesHtml([]) }
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">新增專案</button>
            </div>
            <div id="project-form-feedback" class="text-sm"></div>
          </form>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("new-project-form")?.addEventListener("submit", handleNewProjectSubmission);

      const recalc = ()=>{
        const a = n(document.getElementById("proj-personnel").value);
        const b = n(document.getElementById("proj-operating").value);
        const c2 = n(document.getElementById("proj-equipment").value);
        document.getElementById("proj-budget").value = (a+b+c2);
      };
      ["proj-personnel","proj-operating","proj-equipment"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", recalc);
      });
      recalc();
    }

    // Brain
    function renderReport(){
      const c = document.getElementById("main-content");
      if(!c) return;
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="brain" class="w-7 h-7 mr-3 text-primary-blue"></i> Brain - AI 摘要
        </h2>
        <div class="project-card bg-white p-6 rounded-xl shadow-lg">
          <p class="text-sm text-gray-500 mb-3">依據當月/當週的專案、任務與行事曆資料，自動生成摘要報告。</p>
          <div class="flex flex-wrap gap-3 mb-3">
            <button class="px-3 py-2 rounded-lg bg-primary-blue text-white hover:bg-blue-700 text-sm" onclick="generateAIReport('week')">產生本週摘要</button>
            <button class="px-3 py-2 rounded-lg bg-secondary-green text-white hover:bg-green-700 text-sm" onclick="generateAIReport('month')">產生本月摘要</button>
            <button id="btn-ai-download" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm" disabled>下載摘要</button>
          </div>
          <div class="border rounded-lg p-3 bg-gray-50">
            <pre id="ai-summary-box" class="whitespace-pre-wrap text-sm text-gray-800">點擊上方按鈕生成 AI 摘要...</pre>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // 行事曆
    function renderCalendar(){
      const c = document.getElementById("main-content");
      if(!c) return;
      if (calendarInstance) { try { calendarInstance.destroy(); } catch(_) {} calendarInstance = null; }

      const projectOptions = projects.length>0
        ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||"")}</option>`).join("")
        : '<option value="">尚無專案</option>';

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="calendar" class="w-7 h-7 mr-3 text-primary-blue"></i> 行事曆
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <div class="lg:col-span-1 project-card bg-white p-5 rounded-xl shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              <i data-lucide="plus" class="w-5 h-5 mr-2 text-primary-blue"></i> 新增事項
            </h3>
            <form id="new-event-form" class="space-y-3">
              <div>
                <label class="block text-sm text-gray-700">標題</label>
                <input id="ev-title" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="輸入事件標題" required>
              </div>
              <div>
                <label class="block text-sm text-gray-700">所屬專案</label>
                <select id="ev-project" class="mt-1 w-full rounded-md border-gray-300 p-2 border">${projectOptions}</select>
              </div>
              <div>
                <label class="block text-sm text-gray-700">負責人</label>
                <select id="ev-assignee" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                  ${ managerOptionsHtml() }
                </select>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-gray-700">開始日期</label>
                  <input id="ev-start" type="date" class="mt-1 w-full rounded-md border-gray-300 p-2 border" required>
                </div>
                <div>
                  <label class="block text-sm text-gray-700">結束日期</label>
                  <input id="ev-end" type="date" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                </div>
              </div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">新增</button>
              <div id="event-form-feedback" class="text-sm mt-2"></div>
            </form>
            <p class="text-xs text-gray-500 mt-3">提示：點選右側行事曆日期可自動帶入開始/結束日。</p>
          </div>
          <div class="lg:col-span-3 project-card bg-white p-5 rounded-xl shadow">
            <div id="full-calendar"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const calEl = document.getElementById("full-calendar");
      if (calEl && window.FullCalendar?.Calendar) {
        const evs = (events||[]).map(ev => ({
          id: ev.id,
          title: `${ev.title || "事件"}${ev.projectId ? `（${ev.projectId}）` : ""}`,
          start: ev.startDate || ev.date || "",
          end: ev.endDate || ev.startDate || ev.date || "",
          allDay: true
        }));

        calendarInstance = new FullCalendar.Calendar(calEl, {
          initialView: "dayGridMonth",
          height: "auto",
          headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,dayGridWeek" },
          events: evs, locale: "zh-tw", buttonIcons: false,
          buttonText: { today: "本月", prev: "上個月", next: "下個月" }, firstDay: 1,
          dateClick: (info)=>{ const s = document.getElementById("ev-start"); const e = document.getElementById("ev-end"); if(s) s.value = info.dateStr; if(e) e.value = info.dateStr; }
        });
        calendarInstance.render();
      }

      document.getElementById("new-event-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback = document.getElementById("event-form-feedback");
        if(!currentUserId){ feedback.className="text-sm mt-2 text-red-600"; feedback.textContent="請先登入再新增事件。"; return; }
        const title = document.getElementById("ev-title").value.trim();
        const projectId = document.getElementById("ev-project").value || "";
        const assignee = document.getElementById("ev-assignee").value || "";
        const startDate = document.getElementById("ev-start").value;
        const endDate = document.getElementById("ev-end").value || startDate;
        if(!title || !startDate){ feedback.className="text-sm mt-2 text-red-600"; feedback.textContent="請填寫標題與開始日期。"; return; }
        try{
          await addDoc(collection(db, EVENTS_COLLECTION_PATH), { title, projectId, assignee, startDate, endDate, createdAt: serverTimestamp(), reporterId: currentUserId });
          feedback.className="text-sm mt-2 text-secondary-green"; feedback.textContent=`新增成功。`;
          (document.getElementById("new-event-form"))?.reset();
        }catch(err){
          console.error(err); feedback.className="text-sm mt-2 text-red-600"; feedback.textContent="新增失敗：資料庫錯誤。";
        }
      });
    }

    // Planner（負責人=專案管理人、主持人=自行輸入）
    function renderTaskManagement(){
      const c = document.getElementById("main-content");
      if(!c) return;

      const projectOptions = projects.length>0
        ? `<option value="">選擇專案（可空）</option>` + projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||"")}</option>`).join("")
        : '<option value="">尚無專案</option>';

      const computedAssignee = (t)=> (projects.find(p=>p.id===t.projectId)?.manager || "");

      const assigneeSet = new Set(tasks.map(t => computedAssignee(t).trim()).filter(Boolean));
      const assigneeOptions = ['全部負責人', ...Array.from(assigneeSet).filter(Boolean)];
      const pmSet = new Set(tasks.map(t => (t.projectManager||"").trim()).filter(Boolean).concat(projects.map(p=>p.manager||"")));
      const pmOptions = ['全部主持人', ...Array.from(pmSet).filter(Boolean)];
      const statusSet = new Set(tasks.map(t => (t.status||"").trim()).filter(Boolean));
      const statusOptions = ['全部狀態', ...Array.from(statusSet).filter(Boolean)];

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items中心">
          <i data-lucide="calendar-days" class="w-7 h-7 mr-3 text-primary-blue"></i> Planner（任務管理）
        </h2>

        <div class="project-card bg-white p-6 rounded-xl shadow mb-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i data-lucide="plus" class="w-5 h-5 mr-2 text-primary-blue"></i> 新增任務
          </h3>
          <form id="new-task-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">專案</label>
              <select id="task-project" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${projectOptions}
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">任務名稱</label>
              <input id="task-name" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border" required>
            </div>
            <div class="md:col-span-1">
              <label class="block text-sm text-gray-700">負責人（= 專案管理人）</label>
              <input id="task-assignee" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border bg-gray-100" placeholder="依專案自動帶入" readonly>
            </div>
            <div class="md:col-span-1">
              <label class="block text-sm text-gray-700">主持人（自行輸入）</label>
              <input id="task-pm" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="例如：王小明">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">到期日</label>
              <input id="task-due" type="date" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">狀態</label>
              <input id="task-status" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="例如：未開始/進行中/完成">
            </div>
            <div class="md:col-span-6">
              <label class="block text-sm text-gray-700">描述</label>
              <textarea id="task-desc" rows="2" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="任務描述（選填）"></textarea>
            </div>
            <div class="md:col-span-6 flex justify-end">
              <button type="submit" class="px-4 py-2 bg-primary-blue text白 rounded-lg hover:bg-blue-700">新增</button>
            </div>
            <div id="task-form-feedback" class="text-sm md:col-span-6"></div>
          </form>
        </div>

        <div class="project-card bg-white p-4 rounded-xl shadow mb-4">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
            <div>
              <label class="block text-xs text-gray-600">專案</label>
              <select id="flt-project" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                <option value="">全部專案</option>
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title||"")}</option>`).join("")}
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600">負責人（= 專案管理人）</label>
              <select id="flt-assignee" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${ assigneeOptions.map(a => `<option value="${escapeHtml(a==='全部負責人'?'':a)}">${escapeHtml(a)}</option>`).join("") }
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600">主持人</label>
              <select id="flt-pm" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${ pmOptions.map(pm => `<option value="${escapeHtml(pm==='全部主持人'?'':pm)}">${escapeHtml(pm)}</option>`).join("") }
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600">狀態</label>
              <select id="flt-status" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${ statusOptions.map(s => `<option value="${escapeHtml(s==='全部狀態'?'':s)}">${escapeHtml(s)}</option>`).join("") }
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600">從</label>
              <input id="flt-from" type="date" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
            </div>
            <div>
              <label class="block text-xs text-gray-600">到</label>
              <input id="flt-to" type="date" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
            </div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <input id="flt-search" type="text" class="flex-1 rounded-md border-gray-300 p-2 border" placeholder="搜尋任務名稱/描述">
            <button id="flt-reset" class="px-3 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">重置</button>
          </div>
        </div>

        <div id="task-list" class="space-y-3"></div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      function updateAssigneeByProject(){
        const pid = document.getElementById("task-project").value || "";
        const pm = projects.find(p=>p.id===pid)?.manager || "";
        const a = document.getElementById("task-assignee");
        if(a) a.value = pm;
      }
      document.getElementById("task-project")?.addEventListener("change", updateAssigneeByProject);
      updateAssigneeByProject();

      document.getElementById("new-task-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback = document.getElementById("task-form-feedback");
        if(!currentUserId){ feedback.className="text-sm text-red-600"; feedback.textContent="請先登入再新增任務。"; return; }
        const projectId = document.getElementById("task-project").value || "";
        const taskName = document.getElementById("task-name").value.trim();
        const projectManager = document.getElementById("task-pm").value.trim(); // 主持人（自填）
        const dueDate = document.getElementById("task-due").value || "";
        const status = document.getElementById("task-status").value.trim() || "未開始";
        const description = document.getElementById("task-desc").value || "";
        if(!taskName){ feedback.className="text-sm text-red-600"; feedback.textContent="請輸入任務名稱。"; return; }
        const assignee = projects.find(p=>p.id===projectId)?.manager || ""; // 負責人=專案管理人
        try{
          const ref = await addDoc(collection(db, TASKS_COLLECTION_PATH), { projectId, taskName, description, assignee, projectManager, dueDate, status, createdAt: serverTimestamp(), reporterId: currentUserId });
          feedback.className="text-sm text-secondary-green"; feedback.textContent=`新增成功 (ID: ${ref.id})。`;
          (document.getElementById("new-task-form"))?.reset();
          updateAssigneeByProject();
          renderRows();
        }catch(err){
          console.error(err);
          feedback.className="text-sm text-red-600"; feedback.textContent="新增失敗：資料庫錯誤。";
        }
      });

      function getFilters(){
        return {
          project: document.getElementById("flt-project").value || "",
          assignee: document.getElementById("flt-assignee").value || "",
          pm: document.getElementById("flt-pm").value || "",
          status: document.getElementById("flt-status").value || "",
          from: document.getElementById("flt-from").value || "",
          to: document.getElementById("flt-to").value || "",
          q: (document.getElementById("flt-search").value||"").toLowerCase()
        };
      }
      function applyFilters(list){
        const f = getFilters();
        return list.filter(t=>{
          if(f.project && t.projectId !== f.project) return false;
          const displayAssignee = computedAssignee(t);
          if(f.assignee && displayAssignee !== f.assignee) return false;
          const displayPm = t.projectManager || "";
          if(f.pm && displayPm !== f.pm) return false;
          if(f.status && (t.status||"") !== f.status) return false;
          if(f.from && (t.dueDate||"") < f.from) return false;
          if(f.to && (t.dueDate||"") > f.to) return false;
          if(f.q){ const hay = `${t.taskName||""} ${t.description||""}`.toLowerCase(); if(!hay.includes(f.q)) return false; }
          return true;
        });
      }

      let editingId = null;
      function badgeClass(status){
        const s = (status||"").toLowerCase();
        if(s.includes("完成")) return "bg-secondary-green/10 text-secondary-green";
        if(s.includes("未") || s.includes("todo")) return "bg-gray-200 text-gray-700";
        if(s.includes("延") || s.includes("風險")) return "bg-accent-orange/10 text-accent-orange";
        return "bg-primary-blue/10 text-primary-blue";
      }

      function renderRows(){
        const container = document.getElementById("task-list");
        if(!container) return;
        const sorted = [...tasks].sort((a,b)=> (a.createdAt?.toMillis?.()||0) > (b.createdAt?.toMillis?.()||0) ? -1 : 1);
        const list = applyFilters(sorted);
        container.innerHTML = list.map(t=>{
          const proj = projects.find(p=>p.id===t.projectId);
          const displayAssignee = proj?.manager || "";
          const displayPm = t.projectManager || "";
          if(editingId === t.id){
            return `
              <div class="project-card bg-white p-4 rounded-xl shadow">
                <div class="flex items-start justify-between">
                  <div class="text-sm text-gray-500">${escapeHtml(t.projectId||"")} ${proj?`- ${escapeHtml(proj.title||"")}`:""}</div>
                  <div class="text-xs text-gray-400">${escapeHtml(t.createdAt?.toDate? t.createdAt.toDate().toLocaleString() : "")}</div>
                </div>
                <div class="mt-2 grid grid-cols-1 md:grid-cols-6 gap-3">
                  <div class="md:col-span-3">
                    <label class="block text-xs text-gray-600">任務名稱</label>
                    <input id="ed-name-${t.id}" type="text" class="w-full rounded-md border-gray-300 p-2 border" value="${escapeHtml(t.taskName||'')}">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">負責人（= 專案管理人）</label>
                    <input id="ed-assignee-${t.id}" type="text" class="w-full rounded-md border-gray-300 p-2 border bg-gray-100" value="${escapeHtml(displayAssignee)}" readonly>
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">主持人（自行輸入）</label>
                    <input id="ed-pm-${t.id}" type="text" class="w-full rounded-md border-gray-300 p-2 border" value="${escapeHtml(displayPm)}">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">到期日</label>
                    <input id="ed-due-${t.id}" type="date" class="w-full rounded-md border-gray-300 p-2 border" value="${escapeHtml(t.dueDate||'')}">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">狀態</label>
                    <input id="ed-status-${t.id}" type="text" class="w-full rounded-md border-gray-300 p-2 border" value="${escapeHtml(t.status||'')}">
                  </div>
                  <div class="md:col-span-6">
                    <label class="block text-xs text-gray-600">描述</label>
                    <textarea id="ed-desc-${t.id}" rows="2" class="w-full rounded-md border-gray-300 p-2 border">${escapeHtml(t.description||'')}</textarea>
                  </div>
                </div>
                <div class="mt-3 flex gap-3">
                  <button class="px-3 py-1.5 rounded-md bg-secondary-green text-white" onclick="window.__saveTask('${t.id}')">儲存</button>
                  <button class="px-3 py-1.5 rounded-md bg-gray-200 text-gray-700" onclick="window.__cancelEditTask()">取消</button>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="project-card bg-white p-4 rounded-xl shadow">
                <div class="flex items-start justify-between">
                  <div class="text-sm text-primary-blue font-semibold">${escapeHtml(t.taskName||"任務")}</div>
                  <div class="text-xs text-gray-400">${escapeHtml(t.createdAt?.toDate? t.createdAt.toDate().toLocaleString() : "")}</div>
                </div>
                <div class="mt-1 text-xs text-gray-500">${escapeHtml(t.projectId||"")} ${proj?`- ${escapeHtml(proj.title||"")}`:""}</div>
                <div class="mt-2 text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(t.description||"")}</div>
                <div class="mt-3 flex flex-wrap items-center gap-3 text-sm">
                  <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">負責人：${escapeHtml(displayAssignee)}</span>
                  <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">主持人：${escapeHtml(displayPm)}</span>
                  <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">到期：${escapeHtml(t.dueDate||"-")}</span>
                  <span class="px-2 py-0.5 rounded-full ${badgeClass(t.status)}">${escapeHtml(t.status||"")||"未設定"}</span>
                </div>
                <div class="mt-3 flex gap-3">
                  <button class="px-3 py-1.5 rounded-md bg-primary-blue/10 text-primary-blue" onclick="window.__editTask('${t.id}')">編輯</button>
                  <button class="px-3 py-1.5 rounded-md bg-red-50 text-red-600" onclick="window.__deleteTask('${t.id}')">刪除</button>
                </div>
              </div>
            `;
          }
        }).join("") || `<div class="text-center text-gray-500 text-sm py-8">沒有符合條件的任務</div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
      }

      window.__editTask = function(id){ editingId = id; renderRows(); };
      window.__cancelEditTask = function(){ editingId = null; renderRows(); };
      window.__saveTask = async function(id){
        const t = tasks.find(x=>x.id===id);
        const taskName = document.getElementById(`ed-name-${id}`).value.trim();
        const description = document.getElementById(`ed-desc-${id}`).value;
        const projectManager = document.getElementById(`ed-pm-${id}`).value; // 主持人
        const dueDate = document.getElementById(`ed-due-${id}`).value;
        const status = document.getElementById(`ed-status-${id}`).value.trim();
        const displayAssignee = projects.find(p=>p.id===t.projectId)?.manager || "";
        try{
          await updateDoc(doc(db, TASKS_COLLECTION_PATH, id), { taskName, description, projectManager, dueDate, status, assignee: displayAssignee });
          editingId = null; renderRows();
        }catch(err){
          console.error(err); showModal("更新失敗","任務更新時發生錯誤。");
        }
      };
      window.__deleteTask = async function(id){
        if(!confirm("確定刪除此任務？")) return;
        try{ await deleteDoc(doc(db, TASKS_COLLECTION_PATH, id)); renderRows(); }
        catch(err){ console.error(err); showModal("刪除失敗","任務刪除時發生錯誤。"); }
      };

      ["flt-project","flt-assignee","flt-pm","flt-status","flt-from","flt-to","flt-search"].forEach(id=>{
        document.getElementById(id)?.addEventListener("input", renderRows);
        document.getElementById(id)?.addEventListener("change", renderRows);
      });
      document.getElementById("flt-reset")?.addEventListener("click", ()=>{
        ["flt-project","flt-assignee","flt-pm","flt-status","flt-from","flt-to","flt-search"].forEach(id=>{
          const el = document.getElementById(id); if(el) el.value = "";
        });
        renderRows();
      });

      renderRows();
    }

    // 追蹤專案（專案詳情）
    async function toggleFollowProject(projectId){
      if(!currentUserId){ showModal("未登入","請先登入再追蹤專案。"); return; }
      const id = `${projectId}__${currentUserId}`;
      const ref = doc(db, WATCHERS_COLLECTION_PATH, id);
      try{
        await deleteDoc(ref); showModal("已取消追蹤", "已取消追蹤此專案。");
      }catch(_){
        try{ await setDoc(ref, { projectId, userId: currentUserId, createdAt: serverTimestamp() }); showModal("追蹤成功", "您已追蹤此專案。"); }
        catch(e){ console.error(e); showModal("操作失敗","更新追蹤狀態時發生錯誤。"); }
      }
    }

    // 匯出專案 CSV（含 needIT/requiredRoles）
    window.exportProjectCsv = function(projectId){
      const p = projects.find(x=>x.id===projectId);
      if(!p){ showModal("匯出失敗","找不到專案。"); return; }
      const headers = [
        "type","projectId","projectTitle","manager","budget","progress","status",
        "personnelBudget","operatingBudget","equipmentBudget",
        "personnelUsed","operatingUsed","equipmentUsed",
        "needIT","requiredRoles",
        "taskId","taskName","taskAssignee","taskDueDate","taskStatus",
        "eventId","eventTitle","eventAssignee","eventStartDate","eventEndDate"
      ];
      const rows = [];
      rows.push({
        type:"project", projectId:p.id, projectTitle:p.title||"", manager:p.manager||"",
        budget:n(p.budget), progress:n(p.progress), status:p.status||"",
        personnelBudget:n(p.personnelBudget), operatingBudget:n(p.operatingBudget), equipmentBudget:n(p.equipmentBudget),
        personnelUsed:n(p.personnelUsed), operatingUsed:n(p.operatingUsed), equipmentUsed:n(p.equipmentUsed),
        needIT: !!p.needIT, requiredRoles: (p.requiredRoles||[]).join("；")
      });
      const tks = tasks.filter(t=>t.projectId===projectId);
      for(const t of tks){
        rows.push({
          type:"task", projectId:p.id, projectTitle:p.title||"", manager:p.manager||"",
          budget:n(p.budget), progress:n(p.progress), status:p.status||"",
          personnelBudget:n(p.personnelBudget), operatingBudget:n(p.operatingBudget), equipmentBudget:n(p.equipmentBudget),
          personnelUsed:n(p.personnelUsed), operatingUsed:n(p.operatingUsed), equipmentUsed:n(p.equipmentUsed),
          needIT: !!p.needIT, requiredRoles:(p.requiredRoles||[]).join("；"),
          taskId:t.id||"", taskName:t.taskName||"", taskAssignee:(p.manager||""), taskDueDate:t.dueDate||"", taskStatus:t.status||""
        });
      }
      const evs = events.filter(e=>e.projectId===projectId);
      for(const ev of evs){
        rows.push({
          type:"event", projectId:p.id, projectTitle:p.title||"", manager:p.manager||"",
          budget:n(p.budget), progress:n(p.progress), status:p.status||"",
          personnelBudget:n(p.personnelBudget), operatingBudget:n(p.operatingBudget), equipmentBudget:n(p.equipmentBudget),
          personnelUsed:n(p.personnelUsed), operatingUsed:n(p.operatingUsed), equipmentUsed:n(p.equipmentUsed),
          needIT: !!p.needIT, requiredRoles:(p.requiredRoles||[]).join("；"),
          eventId:ev.id||"", eventTitle:ev.title||"", eventAssignee:ev.assignee||"",
          eventStartDate:ev.startDate||ev.date||"", eventEndDate:ev.endDate||ev.startDate||ev.date||""
        });
      }
      const csv = arrayToCsv(headers, rows);
      triggerDownloadCsv(csv, `project_${p.id}.csv`);
    };

    // 專案詳情（可更新金額與人力 + 主持人/專案對應篩選）
    function renderProjectDetails(projectId){
      const c = document.getElementById("main-content"); if(!c) return;

      if (projectId) {
        const projForArg = projects.find(p=>p.id===projectId);
        if (projForArg && detailsFilterPM !== (projForArg.manager || "")) detailsFilterPM = projForArg.manager || "";
      }
      const pmList = Array.from(new Set(projects.map(p=>(p.manager||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      const candidateProjects = (detailsFilterPM ? projects.filter(p=>(p.manager||"")===detailsFilterPM) : projects).slice().sort((a,b)=>a.id.localeCompare(b.id));
      if (!projectId || !candidateProjects.some(p=>p.id===projectId)) selectedProjectId = candidateProjects[0]?.id || projects[0]?.id || null;
      else selectedProjectId = projectId;

      const p = projects.find(x=>x.id===selectedProjectId);
      if(!p){ c.innerHTML = `<p class="text-gray-500">找不到該專案。</p>`; return; }

      const projectTasks = tasks.filter(t => t.projectId===selectedProjectId).slice(0,20);
      const projectEvents = events.filter(e => e.projectId===selectedProjectId).slice(0,20);
      const projectFiles = files.filter(f => f.projectId===selectedProjectId).slice(0,20);

      if(detailsWatchersUnsub){ try{ detailsWatchersUnsub(); }catch{} detailsWatchersUnsub = null; }
      detailsWatchersUnsub = onSnapshot(
        query(collection(db, WATCHERS_COLLECTION_PATH), where("projectId","==", selectedProjectId)),
        (snap)=>{
          const indicator = document.getElementById("follow-indicator");
          const btn = document.getElementById("btn-follow-project");
          const following = snap.docs.some(d => (d.data().userId||"") === currentUserId);
          if(indicator) indicator.textContent = `追蹤者：${snap.size} 人${following?"（你已追蹤）":""}`;
          if(btn) btn.textContent = following ? "取消追蹤" : "追蹤此專案";
        }
      );

      // 進度條資料
      const cat = [
        { key:"personnel", title:"人事費", budget:n(p.personnelBudget), used:n(p.personnelUsed) },
        { key:"operating", title:"業務費", budget:n(p.operatingBudget), used:n(p.operatingUsed) },
        { key:"equipment", title:"設備費", budget:n(p.equipmentBudget), used:n(p.equipmentUsed) }
      ];
      const budgetCards = cat.map(x=>{
        const remain = x.budget - x.used;
        const rate = x.budget>0 ? clamp01(x.used/x.budget) : 0;
        const bar = remain>=0 ? (rate>=0.95 ? "bg-yellow-400" : "bg-primary-blue") : "bg-red-500";
        return `
          <div class="project-card bg-white p-4 rounded-xl shadow">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-gray-800">${escapeHtml(x.title)}</div>
              <div class="text-sm text-gray-500">預算：${fmtMoney(x.budget)}</div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
              <div class="progress-bar h-3 rounded-full ${bar}" style="width:${(rate*100).toFixed(0)}%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between">
              <span>已用：<strong>${fmtMoney(x.used)}</strong>（${(rate*100).toFixed(0)}%）</span>
              <span>${remain>=0 ? `剩餘：${fmtMoney(remain)}` : `超支：${fmtMoney(-remain)}`}</span>
            </div>
          </div>
        `;
      }).join("");

      // 篩選列 HTML
      const pmOptionsHtml = [`<option value="">全部主持人</option>`].concat(pmList.map(pm => `<option value="${escapeHtml(pm)}" ${detailsFilterPM===pm?'selected':''}>${escapeHtml(pm)}</option>`)).join("");
      const projectOptionsHtml = candidateProjects.map(cp => `<option value="${escapeHtml(cp.id)}" ${cp.id===selectedProjectId?'selected':''}>${escapeHtml(cp.id)} - ${escapeHtml(cp.title||"")}</option>`).join("");

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
        </h2>

        <!-- 主持人/專案 對應篩選列 -->
        <div class="project-card bg-white p-4 rounded-xl shadow mb-4">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div class="md:col-span-2">
              <label class="block text-xs text-gray-600">主持人</label>
              <select id="details-pm-select" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${pmOptionsHtml}
              </select>
            </div>
            <div class="md:col-span-3">
              <label class="block text-xs text-gray-600">專案</label>
              <select id="details-project-select" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                ${projectOptionsHtml || `<option value="">（無專案）</option>`}
              </select>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="details-reset" class="px-3 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">重置</button>
            <div class="text-xs text-gray-500 self-center">共 ${candidateProjects.length} 個專案${detailsFilterPM?`（主持人：${escapeHtml(detailsFilterPM)}）`:""}</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div class="project-card bg-white p-6 rounded-xl shadow">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-lg font-semibold text-primary-blue">${escapeHtml(p.title||"")}</div>
                  <div class="text-sm text-gray-500 mt-1">編號：${escapeHtml(p.id||"")}</div>
                </div>
                <div class="text-right">
                  <div id="follow-indicator" class="text-sm text-gray-600">追蹤者：-- 人</div>
                  <div class="mt-2 flex gap-2 justify-end">
                    <button id="btn-follow-project" class="px-3 py-1.5 text-sm rounded-md bg-primary-blue text-white hover:bg-blue-700" onclick="toggleFollowProject('${escapeHtml(selectedProjectId)}')">追蹤此專案</button>
                    <button id="btn-export-project" class="px-3 py-1.5 text-sm rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200" onclick="exportProjectCsv('${escapeHtml(selectedProjectId)}')">下載專案 CSV</button>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm">
                <div><div class="text-gray-500">主持人</div><div class="font-medium">${escapeHtml(p.manager||"")}</div></div>
                <div><div class="text-gray-500">進度</div><div class="font-medium">${n(p.progress)}%</div></div>
                <div><div class="text-gray-500">狀態</div><div class="font-medium">${escapeHtml(p.status||"")}</div></div>
                <div><div class="text-gray-500">預算概算</div><div class="font-medium">${fmtMoney(n(p.budget))}</div></div>
              </div>
            </div>

            <!-- 金額使用概況 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              ${budgetCards}
            </div>

            <!-- 可更新：金額與人力設定 -->
            <div class="project-card bg-white p-6 rounded-xl shadow">
              <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center"><i data-lucide="coins" class="w-5 h-5 mr-2 text-primary-blue"></i> 金額與人力設定</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs text-gray-600">人事費 預算 / 已用</label>
                  <div class="flex gap-2 mt-1">
                    <input id="edit-personnel-budget" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.personnelBudget)}" min="0">
                    <input id="edit-personnel-used" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.personnelUsed)}" min="0">
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-gray-600">業務費 預算 / 已用</label>
                  <div class="flex gap-2 mt-1">
                    <input id="edit-operating-budget" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.operatingBudget)}" min="0">
                    <input id="edit-operating-used" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.operatingUsed)}" min="0">
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-gray-600">設備費 預算 / 已用</label>
                  <div class="flex gap-2 mt-1">
                    <input id="edit-equipment-budget" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.equipmentBudget)}" min="0">
                    <input id="edit-equipment-used" type="number" class="w-1/2 rounded-md border-gray-300 p-2 border" value="${n(p.equipmentUsed)}" min="0">
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="md:col-span-1">
                  <label class="block text-sm font-medium text-gray-700">是否需要資訊人員</label>
                  <label class="inline-flex items-center gap-2 mt-2">
                    <input type="checkbox" id="edit-needit" ${p.needIT ? "checked":""}>
                    <span class="text-sm">需要資訊人員</span>
                  </label>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-700">需要的人力（可複選）</label>
                  <div id="edit-roles-box" class="mt-2 flex flex-wrap">
                    ${ rolesCheckboxesHtml(p.requiredRoles||[]) }
                  </div>
                </div>
              </div>

              <div class="mt-4 flex justify-end gap-3">
                <button id="btn-update-finance" class="px-4 py-2 rounded-lg bg-primary-blue text-white hover:bg-blue-700">儲存變更</button>
              </div>
              <div id="update-finance-feedback" class="text-sm mt-2"></div>
            </div>

            <!-- 任務列表 -->
            <div class="project-card bg-white p-6 rounded-xl shadow">
              <div class="text-sm text-gray-500 mb-2">近期任務（最多 20 筆）</div>
              <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">任務</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">負責人</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">主持人</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">到期</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">狀態</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 bg-white">
                    ${
                      projectTasks.length ? projectTasks.map(t=>{
                        const assigneeDisplay = p.manager || "";
                        const pm = t.projectManager || "";
                        return `
                          <tr>
                            <td class="px-3 py-2 text-sm">
                              <div class="font-medium">${escapeHtml(t.taskName||"")}</div>
                              ${t.description? `<div class="text-xs text-gray-500">${escapeHtml(t.description)}</div>`:""}
                            </td>
                            <td class="px-3 py-2 text-sm">${escapeHtml(assigneeDisplay)}</td>
                            <td class="px-3 py-2 text-sm">${escapeHtml(pm)}</td>
                            <td class="px-3 py-2 text-sm">${escapeHtml(t.dueDate||"")}</td>
                            <td class="px-3 py-2 text-sm">${escapeHtml(t.status||"")}</td>
                          </tr>
                        `;
                      }).join("") : `<tr><td class="px-3 py-4 text-center text-gray-500 text-sm" colspan="5">此專案尚無任務</td></tr>`
                    }
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 行事列表 -->
            <div class="project-card bg-white p-6 rounded-xl shadow">
              <div class="text-sm text-gray-500 mb-2">近期行事（最多 20 筆）</div>
              <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">標題</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">日期</th>
                      <th class="px-3 py-2 text-left text-xs text-gray-500 uppercase">負責人</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 bg-white">
                    ${
                      projectEvents.length ? projectEvents.map(ev=>`
                        <tr>
                          <td class="px-3 py-2 text-sm">${escapeHtml(ev.title||"事件")}</td>
                          <td class="px-3 py-2 text-sm">${escapeHtml(ev.startDate||"")} ${ev.endDate && ev.endDate!==ev.startDate ? `~ ${escapeHtml(ev.endDate)}`:""}</td>
                          <td class="px-3 py-2 text-sm">${escapeHtml(ev.assignee||"")}</td>
                        </tr>
                      `).join("") : `<tr><td class="px-3 py-4 text-center text-gray-500 text-sm" colspan="3">此專案尚無行事</td></tr>`
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="lg:col-span-1 project-card bg-white p-6 rounded-xl shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              <i data-lucide="paperclip" class="w-5 h-5 mr-2 text-primary-blue"></i> 近期檔案
            </h3>
            <div class="space-y-2">
              ${
                projectFiles.length ? projectFiles.map(f=>`
                  <div class="border rounded-md p-2">
                    <div class="text-sm font-medium truncate">${escapeHtml(f.fileName||"檔案")}</div>
                    <div class="text-xs text-gray-500">${isoToLocale(f.uploadedAt?.toDate ? f.uploadedAt.toDate().toISOString() : f.uploadedAt || "")}</div>
                    ${f.url ? `<a class="text-xs text-primary-blue hover:underline" href="${escapeHtml(f.url)}" target="_blank" rel="noopener">下載/查看</a>` : ""}
                  </div>
                `).join("") : `<div class="text-sm text-gray-500">尚無檔案</div>`
              }
            </div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      // 綁定：主持人/專案選單與重置
      document.getElementById("details-pm-select")?.addEventListener("change", (e)=>{
        detailsFilterPM = e.target.value || "";
        const list = (detailsFilterPM ? projects.filter(p=>(p.manager||"")===detailsFilterPM) : projects).slice().sort((a,b)=>a.id.localeCompare(b.id));
        selectedProjectId = list[0]?.id || null;
        renderProjectDetails(selectedProjectId);
      });
      document.getElementById("details-project-select")?.addEventListener("change", (e)=>{
        selectedProjectId = e.target.value || null;
        const proj = projects.find(p=>p.id===selectedProjectId);
        detailsFilterPM = proj?.manager || "";
        renderProjectDetails(selectedProjectId);
      });
      document.getElementById("details-reset")?.addEventListener("click", ()=>{
        detailsFilterPM = "";
        selectedProjectId = projects[0]?.id || null;
        renderProjectDetails(selectedProjectId);
      });

      // 綁定：更新金額與人力
      document.getElementById("btn-update-finance")?.addEventListener("click", async ()=>{
        if(!currentUserId){ showModal("未登入","請先登入再更新。"); return; }
        const feedback = document.getElementById("update-finance-feedback");
        feedback.className = "text-sm text-gray-600"; feedback.textContent = "儲存中…";

        const personnelBudget = n(document.getElementById("edit-personnel-budget").value);
        const operatingBudget = n(document.getElementById("edit-operating-budget").value);
        const equipmentBudget = n(document.getElementById("edit-equipment-budget").value);
        const personnelUsed = n(document.getElementById("edit-personnel-used").value);
        const operatingUsed = n(document.getElementById("edit-operating-used").value);
        const equipmentUsed = n(document.getElementById("edit-equipment-used").value);
        const needIT = !!document.getElementById("edit-needit").checked;
        const requiredRoles = Array.from(document.querySelectorAll("#edit-roles-box input[name='proj-role']:checked")).map(x=>x.value);
        const budget = personnelBudget + operatingBudget + equipmentBudget;

        try{
          await updateDoc(doc(db, PROJECTS_COLLECTION_PATH, selectedProjectId), {
            personnelBudget, operatingBudget, equipmentBudget,
            personnelUsed, operatingUsed, equipmentUsed,
            needIT, requiredRoles, budget
          });
          feedback.className = "text-sm text-green-600"; feedback.textContent = "已更新。";
          renderProjectDetails(selectedProjectId);
        }catch(err){
          console.error(err);
          feedback.className = "text-sm text-red-600"; feedback.textContent = "更新失敗：" + (err?.message || String(err));
        }
      });
    }

    // ---- 資訊交流（含刪除） ----
    function tryGetStoragePathFromUrl(url){
      try{
        if(!url) return "";
        const m = String(url).match(/\/o\/([^?]+)/);
        if(!m) return "";
        return decodeURIComponent(m[1]);
      }catch{ return ""; }
    }
    window.__deletePost = async function(postId, imageUrl){
      if(!currentUserId){ showModal("未登入","請先登入再刪除貼文。"); return; }
      if(!confirm("確定要刪除此貼文？此動作無法復原。")) return;
      try{
        await deleteDoc(doc(db, COMMUNITY_COLLECTION_PATH, postId));
        if(imageUrl){
          const path = tryGetStoragePathFromUrl(imageUrl);
          if(path){ try{ await deleteObject(sRef(storage, path)); }catch(e){ console.warn("刪除圖片失敗：", e); } }
        }
        showModal("已刪除","貼文已刪除。");
      }catch(e){
        console.error(e); showModal("刪除失敗", e?.message || "執行刪除時發生錯誤。");
      }
    };

    async function uploadImageAndGetUrl(file){
      if(!file) throw new Error("未選擇檔案");
      const safeName = encodeURIComponent(file.name.replace(/\s+/g,'_'));
      const path = `community_uploads/${currentUserId || 'anonymous'}/${Date.now()}_${safeName}`;
      const ref = sRef(storage, path);
      const meta = { contentType: file.type || 'application/octet-stream' };

      return await new Promise((resolve, reject)=>{
        const fb = document.getElementById("post-feedback");
        const task = uploadBytesResumable(ref, file, meta);

        task.on('state_changed',
          (snap)=>{
            const pct = snap.totalBytes ? Math.round(snap.bytesTransferred*100/snap.totalBytes) : 0;
            if (fb) { fb.className="text-sm text-gray-600"; fb.textContent = `圖片上傳中… ${pct}%`; }
          },
          (err)=>{
            console.error("[uploadImageAndGetUrl] failed:", err);
            reject(err);
          },
          async ()=>{
            try{
              const url = await getDownloadURL(ref);
              resolve(url);
            }catch(e){
              console.error("[uploadImageAndGetUrl] getDownloadURL failed:", e);
              reject(e);
            }
          }
        );
      });
    }

    function renderPostCards(list){
      if(!list || !list.length) return `<div class="text-sm text-gray-500">目前沒有貼文，搶先分享第一則！</div>`;
      return list.map(p=>{
        const when = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : (p.createdAt || "");
        const canDelete = (p.reporterId && p.reporterId === currentUserId);
        return `
          <div class="project-card bg-white p-4 rounded-xl shadow">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                  ${ p.authorPhotoURL ? `<img src="${escapeHtml(p.authorPhotoURL)}" class="w-full h-full object-cover">`
                                      : `<div class="w-full h-full flex items-center justify-center text黑/70 font-bold text-xs">${escapeHtml((p.authorName||'U').charAt(0).toUpperCase())}</div>` }
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-semibold">${escapeHtml(p.authorName||"使用者")}</div>
                  <div class="text-xs text-gray-500">${escapeHtml(when)}</div>
                </div>
              </div>
              <div class="ml-3">
                ${ canDelete ? `<button class="text-xs px-2 py-1 rounded bg-red-50 text-red-600 hover:bg-red-100"
                                   onclick="window.__deletePost('${escapeHtml(p.id)}','${escapeHtml(p.imageUrl||"")}')">
                                   刪除
                                 </button>` : "" }
              </div>
            </div>
            <div class="mt-3 text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(p.text||"")}</div>
            ${ (p.postType==="article" && p.title) ? `<div class="mt-2 text-base font-semibold">${escapeHtml(p.title)}</div>` : "" }
            ${ (p.postType==="link" && p.url) ? `<div class="mt-2"><a class="text-primary-blue hover:underline break-all" href="${escapeHtml(p.url)}" target="_blank" rel="noopener">${escapeHtml(p.title||p.url)}</a></div>` : "" }
            ${ (p.postType==="image" && p.imageUrl) ? `<div class="mt-3"><img src="${escapeHtml(p.imageUrl)}" alt="" class="rounded-lg max-h-80 object-contain"></div>` : "" }
          </div>
        `;
      }).join("");
    }
    function renderCommunity(){
      const c = document.getElementById("main-content");
      if(!c) return;
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="messages-square" class="w-7 h-7 mr-3 text-primary-blue"></i> 資訊交流
        </h2>
        <div class="project-card bg-white p-6 rounded-xl shadow mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">分享內容</h3>
          <form id="post-form" class="space-y-3">
            <div>
              <label class="block text-sm text-gray-700">內容類型</label>
              <select id="post-type" class="mt-1 w-full rounded-md border-gray-300 p-2 border">
                <option value="text">文字</option>
                <option value="link">連結</option>
                <option value="image">圖片</option>
                <option value="article">文章</option>
              </select>
            </div>
            <div id="field-title" class="hidden">
              <label class="block text-sm text-gray-700">標題</label>
              <input id="post-title" type="text" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="文章/連結標題">
            </div>
            <div id="field-url" class="hidden">
              <label class="block text-sm text-gray-700">連結網址</label>
              <input id="post-url" type="url" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="https://">
            </div>
            <div id="field-image" class="hidden">
              <label class="block text-sm text-gray-700">上傳圖片</label>
              <input id="post-image" type="file" accept="image/*" class="mt-1 w-full text-sm">
            </div>
            <div id="field-text">
              <label class="block text-sm text-gray-700">內容</label>
              <textarea id="post-text" rows="3" class="mt-1 w-full rounded-md border-gray-300 p-2 border" placeholder="說點什麼..."></textarea>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">發佈</button>
            </div>
            <div id="post-feedback" class="text-sm"></div>
          </form>
        </div>
        <div class="space-y-4" id="post-feed">${ renderPostCards(communityPosts) }</div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const typeEl = document.getElementById("post-type");
      const fieldTitle = document.getElementById("field-title");
      const fieldUrl = document.getElementById("field-url");
      const fieldImage = document.getElementById("field-image");
      const fieldText = document.getElementById("field-text");
      function updateFields(){
        const t = typeEl.value;
        fieldTitle.classList.toggle("hidden", !(t==="article" || t==="link"));
        fieldUrl.classList.toggle("hidden", t!=="link");
        fieldImage.classList.toggle("hidden", t!=="image");
        fieldText.classList.toggle("hidden", false);
      }
      typeEl.addEventListener("change", updateFields);
      updateFields();

      document.getElementById("post-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback = document.getElementById("post-feedback");
        const type = document.getElementById("post-type").value;
        const title = (document.getElementById("post-title")?.value || "").trim();
        const url   = (document.getElementById("post-url")?.value || "").trim();
        const text  = (document.getElementById("post-text")?.value || "").trim();
        const file  = document.getElementById("post-image")?.files?.[0];

        if(!currentUserId){
          if (feedback){ feedback.className="text-sm text-red-600"; feedback.textContent="請先登入再發佈。"; }
          return;
        }

        try{
          let imageUrl = "";
          if(type === "link" && !url) throw new Error("請輸入連結網址");
          if(type === "image"){
            if(!file) throw new Error("請選擇圖片檔案");
            imageUrl = await uploadImageAndGetUrl(file);
          }
          if(!text && type!=="image" && type!=="link") throw new Error("請輸入內容");

          const payload = {
            postType: type, title, url, text, imageUrl,
            authorName: userProfile.displayName || userProfile.email || "使用者",
            authorEmail: userProfile.email || "",
            authorPhotoURL: userProfile.photoURL || "",
            createdAt: serverTimestamp(),
            reporterId: currentUserId
          };

          if (feedback){ feedback.className="text-sm text-gray-600"; feedback.textContent="發佈中…"; }
          const ref = await addDoc(collection(db, COMMUNITY_COLLECTION_PATH), payload);
          console.log("[community] created:", ref.id, payload);

          if (feedback){ feedback.className="text-sm text-green-600"; feedback.textContent="發佈成功！"; }
          (document.getElementById("post-form"))?.reset();
          updateFields();

        }catch(err){
          console.error("[community] create failed:", err);
          if (feedback){ feedback.className="text-sm text-red-600"; feedback.textContent = `發佈失敗：${err?.message || String(err)}`; }
        }
      });

      function rerenderFeed(){
        const feed = document.getElementById("post-feed");
        if(feed) feed.innerHTML = renderPostCards(communityPosts);
        if(window.lucide?.createIcons) lucide.createIcons();
      }
      window.__rerenderCommunityFeed = rerenderFeed;
      rerenderFeed();
    }

    // 啟動
    try { initFirebase(); } catch (e) {
      console.error("初始化失敗：", e);
      const box = document.getElementById("auth-error"); if (box) box.textContent = "初始化失敗：" + (e?.message || String(e));
    }
    window.addEventListener("error", (e) => {
      const box = document.getElementById("auth-error"); if (box && !box.textContent) box.textContent = "錯誤：" + (e?.message || String(e.error || e));
    });
    window.addEventListener("unhandledrejection", (e) => {
      const box = document.getElementById("auth-error"); if (box && !box.textContent) box.textContent = "執行失敗：" + (e?.reason?.message || String(e.reason || e));
    });
  </script>
</body>
</html>
