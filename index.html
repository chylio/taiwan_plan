<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <!-- UPDATED CSP: added accounts.google.com and apis.google.com to script-src/frame-src/connect-src -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net https://www.google.com https://accounts.google.com https://apis.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src https://www.google.com https://www.gstatic.com https://accounts.google.com https://apis.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    // Firebase 專案設定
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__auth_mode = "google"; // 僅允許 Google
    window.__sharepoint_flow_url = "REPLACE_WITH_YOUR_POWER_AUTOMATE_HTTP_TRIGGER_URL";
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzBaT08WiuMIpqVNrG70iTVMUFXY1X-1zSn0uKa3xgLa4KdUwFbL5q7xh5OwpJMAblAdQ/exec";
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","Noto Sans TC","sans-serif"] },
          colors: { "primary-blue":"#1e40af","secondary-green":"#059669","accent-orange":"#ea580c" }
        }
      }
    }
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}

    /* 側欄：展開/收合 */
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}

    /* 登入首頁背景 */
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁（未登入或尚在還原登入時顯示） -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-primary-blue">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">使用 Google 帳號登入以進入儀表板</p>

        <div id="landing-user" class="hidden mt-6">
          <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border">
            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
              <img id="landing-avatar" alt="" class="w-full h-full object-cover hidden">
              <div id="landing-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold">U</div>
            </div>
            <div class="min-w-0">
              <div id="landing-name" class="font-semibold truncate"></div>
              <div id="landing-email" class="text-xs text-gray-500 truncate"></div>
            </div>
          </div>
        </div>

        <button id="btn-landing-login" onclick="signInWithGoogle()"
                class="mt-6 w-full py-3 rounded-xl bg-primary-blue hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>

        <div id="landing-loading" class="hidden mt-6 text-center text-sm text-gray-600">登入狀態還原中，請稍候…</div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth 進行登入；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- App Shell（登入後才顯示） -->
  <div id="app-shell" class="hidden">
    <!-- ... existing markup unchanged ... -->
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end">
        <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">確認</button>
      </div>
    </div>
  </div>

  <!-- App 腳本 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // 全域狀態
    let db, auth, storage;
    let currentUserId = "";
    let isAuthReady = false;
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const APP_CHECK_SITE_KEY = window.__app_check_site_key || "";
    const AUTH_MODE = (window.__auth_mode || "google").toLowerCase();
    const SHAREPOINT_FLOW_URL   = window.__sharepoint_flow_url || "";
    const AI_SUMMARY_WEBAPP_URL = window.__ai_summary_webapp_url || "";

    // ... existing constants and DOM cache ...

    // Google 登入：在 iOS/Safari 先用 Redirect，其他瀏覽器先試 Popup → 失敗再 Redirect
    function isIOSorSafari(){
      const ua = navigator.userAgent;
      const isIOS = /iP(hone|ad|od)/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return isIOS || isSafari;
    }

    window.signInWithGoogle = async function(){
      try{
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        if (isIOSorSafari()) {
          await signInWithRedirect(auth, provider);
          return;
        }

        await signInWithPopup(auth, provider);
      }catch(e){
        const code = e?.code || "";
        const shouldRedirect = [
          "auth/popup-blocked",
          "auth/cancelled-popup-request",
          "auth/operation-not-supported-in-this-environment",
          "auth/idpiframe-initialization-failed",
          "auth/unauthorized-domain",
          "auth/internal-error"
        ].some(p => code.includes(p));
        if(shouldRedirect){
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });
          await signInWithRedirect(auth, provider);
        }else{
          showModal("登入失敗", e?.message || String(e));
        }
      }
    };

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); }
      catch(e){ showModal("登出失敗", e?.message || String(e)); }
    };

    // 初始化
    async function initFirebase(){
      const cfg = firebaseConfig;
      if(!cfg){ showModal("設定錯誤","缺少 Firebase 設定"); return; }
      const app = initializeApp(cfg);
      if(APP_CHECK_SITE_KEY){
        initializeAppCheck(app,{provider:new ReCaptchaV3Provider(APP_CHECK_SITE_KEY),isTokenAutoRefreshEnabled:true});
      }
      db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);

      await setPersistence(auth, browserLocalPersistence).catch(()=>{});

      landingLoading.classList.remove("hidden");

      onAuthStateChanged(auth, async (user)=>{
        isAuthReady = true;
        landingLoading.classList.add("hidden");
        if(user){
          currentUserId = user.uid;
          userProfile = { displayName:user.displayName||"", email:user.email||"", photoURL:user.photoURL||"" };
          updateUserChips();
          showAppShell(true);

          // Ensure dashboard is shown after login
          try { window.setView && setView('dashboard'); } catch {}

          if(!listenersStarted) initializeSystem(true);
          await getRedirectResult(auth).catch(()=>{});
        }else{
          currentUserId = ""; userProfile = { displayName:"", email:"", photoURL:"" };
          showAppShell(false);
          if(window.lucide?.createIcons) lucide.createIcons();
        }
      });
    }

    // ... rest of your code unchanged (renderers, listeners, etc.) ...

    window.addEventListener('DOMContentLoaded', ()=>{
      showAppShell(false);
      initFirebase();
      if(window.lucide?.createIcons) lucide.createIcons();
    });
  </script>
</body>
</html>
