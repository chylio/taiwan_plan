<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深耕計畫專案管理儀表板</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Icon: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 設定 Tailwind CSS 配置，使用 Inter 字體 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af', // Blue-700
                        'secondary-green': '#059669', // Emerald-600
                        'accent-orange': '#ea580c', // Orange-700
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定義樣式 */
        .project-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .project-card:hover {
            transform: translateY(-2px);
        }
        .nav-item.active {
            background-color: #1e40af; /* Primary Blue */
            color: white;
            border-left: 4px solid #f97316; /* Orange-500 for accent */
        }
        .nav-item {
            cursor: pointer;
            transition: all 0.15s;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans flex min-h-screen">

    <!-- 側邊導航欄 (Sidebar Navigation) -->
    <aside class="w-64 bg-white shadow-xl flex flex-col fixed h-full z-10">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-extrabold text-primary-blue">
                深耕計畫 <span class="text-secondary-green">PM</span>
            </h1>
            <p class="text-xs text-gray-500 mt-1">專案管理中心</p>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <div id="nav-dashboard" class="nav-item active p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('dashboard')">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">專案儀表板</span>
            </div>
            <div id="nav-creation" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('creation')">
                <i data-lucide="folder-plus" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">新增/編輯專案</span>
            </div>
            <div id="nav-details" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('details', projects.length > 0 ? projects[0].id : null)">
                <i data-lucide="folder-open" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">專案詳情 (範例)</span>
            </div>
            <div id="nav-tasks" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('tasks')">
                <i data-lucide="check-square" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">任務管理</span>
            </div>
            <div id="nav-report" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('report')">
                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">報告與下載</span>
            </div>
            <div id="nav-settings" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center border-t border-gray-100 mt-4 pt-4" onclick="setView('settings')">
                <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
                <span class="font-medium">系統設定</span>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-100 text-sm text-gray-600">
            <p class="text-xs">當前使用者 ID:</p>
            <p id="user-id-display" class="font-mono text-xs break-all text-primary-blue">連線中...</p>
        </div>
    </aside>

    <!-- 主要內容區域 (Main Content Area) -->
    <main class="flex-grow ml-64 p-8">
        <div id="main-content" class="w-full">
            <!-- 內容將由 JavaScript 動態加載 -->
        </div>
    </main>

    <!-- 模態視窗 (Modal for Custom Alert/Confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">確認</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript 邏輯 -->
    <script type="module">
        // =================================================================
        // 1. Firebase/Firestore 配置與初始化
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firestore 記錄級別
        setLogLevel('Debug');

        let db;
        let auth;
        let currentUserId = 'initializing';
        let isAuthReady = false; // 旗標：用於確保 Auth 流程已完成
        let isListenerStarted = false; // 旗標：用於防止重複啟動監聽器

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // 資料庫路徑定義 (公開，所有專案經理可見)
        const PROJECTS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/project_metadata`; // 新增專案資料路徑
        const TASKS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/project_tasks`;
        const SETTINGS_DOC_PATH = `/artifacts/${APP_ID}/public/data/settings/teams`; // 儲存 Teams Webhook URL 的路徑


        // 初始化 Firebase
        if (firebaseConfig && initialAuthToken) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // --- NEW: Sequential Authentication Function ---
            // 使用 async/await 確保登入流程完成後再啟動系統，避免時序錯誤。
            async function performAuth() {
                try {
                    // 1. Try Custom Token Sign-in
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    currentUserId = userCredential.user.uid;
                    console.log("Signed in with custom token successfully.");
                } catch (customTokenError) {
                    // 如果自定義 Token 登入失敗，嘗試匿名登入作為後備方案。
                    console.warn("Custom Token Sign-in failed, attempting anonymous fallback.");
                    
                    try {
                        // 2. Fallback to Anonymous Sign-in
                        const userCredential = await signInAnonymously(auth);
                        currentUserId = userCredential.user.uid;
                        console.log("Signed in anonymously successfully (Fallback).");
                    } catch (anonymousError) {
                        console.error("Anonymous Sign-in failed, Authentication FAILED.", anonymousError);
                        throw new Error("Final Auth Failure.");
                    }
                }
                
                // 3. Update UI and mark ready (guaranteed to run after successful sign-in)
                document.getElementById('user-id-display').textContent = currentUserId;
                isAuthReady = true;
                console.log("Firebase Auth is now fully READY.");

                // 4. Proceed with system initialization
                await initializeSystem(true);
            }

            // Start the sequential process
            performAuth().catch(e => {
                 console.error("System failed to initialize due to critical auth failure:", e);
                 document.getElementById('user-id-display').textContent = 'Error: Auth Failed';
                 isAuthReady = true; // Still mark ready to let non-db functions run
                 initializeSystem(false); // Run init without DB features
            });

        } else {
            console.error("Firebase Config or initialAuthToken is missing. Cannot initialize Firestore features.");
            document.getElementById('user-id-display').textContent = 'Error: Missing Config/Token';
            // 執行非資料庫相關的初始化
            initializeSystem(false);
        }

        // =================================================================
        // 2. 應用程式核心資料與狀態
        // =================================================================

        // 專案經理列表 (Project Managers)
        const projectManagers = ["蔡雅雯", "陳乃菁", "吳曉琪", "蘇琬淳", "楊穎潔"];
        
        // NEW: 權限檢查 - 由於所有用戶都是專案經理，此函數目前只檢查是否登入
        function isAuthorized(projectOwnerId) {
            // 在當前架構下，所有登入用戶 (isAuthReady=true) 都是專案經理，具有讀寫權限
            if (!isAuthReady || !currentUserId || currentUserId === 'initializing') {
                return false;
            }
            
            // 允許專案創建者刪除/修改
            if (projectOwnerId && projectOwnerId === currentUserId) {
                return true;
            }
            
            // 由於所有登入用戶都被視為專案經理，這裡允許所有登入用戶操作
            // 如果未來需要更細緻的控制 (例如只有特定用戶可以刪除)，需要在這裡調整邏輯
            return true;
        }

        // 專案列表 (將從 Firestore 動態載入，初始為空)
        let projects = []; 
        
        // 應用程式狀態
        let currentView = 'dashboard';
        let tasks = []; // 儲存從 Firestore 獲取的任務列表
        let teamsWebhookUrl = ''; // NEW: 儲存 Teams Webhook URL

        // =================================================================
        // 3. 核心功能與視圖渲染
        // =================================================================

        /**
         * 自定義模態視窗 (取代 alert/confirm)
         * @param {string} title - 標題
         * @param {string} message - 訊息內容
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('modal-confirm-btn').onclick = () => {
                const modal = document.getElementById('custom-modal');
                const wrapper = document.getElementById('modal-content-wrapper');
                wrapper.classList.remove('scale-100', 'opacity-100');
                wrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };
            const modal = document.getElementById('custom-modal');
            const wrapper = document.getElementById('modal-content-wrapper');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                wrapper.classList.remove('scale-95', 'opacity-0');
                wrapper.classList.add('scale-100', 'opacity-100');
            }, 50);
        }
        
        /**
         * 透過 Teams Webhook 發送通知
         * @param {string} title - 訊息標題
         * @param {string} text - 訊息內容
         * @param {string} color - 訊息顏色 (e.g., '0078D4' for Teams blue)
         */
        async function sendTeamsNotification(title, text, color = '0078D4') {
             if (!teamsWebhookUrl) {
                 console.warn("Teams Webhook URL is not configured. Notification skipped.");
                 return;
             }

             const payload = {
                 "@context": "https://schema.org/extensions",
                 "@type": "MessageCard",
                 "themeColor": color,
                 "title": title,
                 "text": text,
             };

             try {
                 const response = await fetch(teamsWebhookUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (response.ok) {
                     console.log("Teams notification sent successfully.");
                 } else {
                     console.error("Failed to send Teams notification:", response.status, await response.text());
                 }
             } catch (error) {
                 console.error("Error sending Teams notification:", error);
             }
        }


        /**
         * 渲染主儀表板 (專案儀表板)
         */
        function renderDashboard() {
            const container = document.getElementById('main-content');
            
            // 1. 概覽卡片數據計算
            const totalProjects = projects.length;
            const completedProjects = projects.filter(p => p.progress >= 95).length;
            const totalBudget = projects.reduce((sum, p) => sum + (p.budget || 0), 0);
            const isProjectListEmpty = totalProjects === 0;

            // 2. 儀表板 HTML 結構
            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">專案儀表板</h2>
                
                <!-- 概覽卡片區 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
                        <div class="flex items-center justify-between">
                            <i data-lucide="layers" class="w-8 h-8 text-primary-blue"></i>
                            <span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span>
                        </div>
                        <p class="text-gray-500 mt-2">總專案數</p>
                    </div>
                    <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-green">
                        <div class="flex items-center justify-between">
                            <i data-lucide="check-circle" class="w-8 h-8 text-secondary-green"></i>
                            <span class="text-3xl font-extrabold text-gray-900">${completedProjects}</span>
                        </div>
                        <p class="text-gray-500 mt-2">接近完成專案數</p>
                    </div>
                    <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-accent-orange">
                        <div class="flex items-center justify-between">
                            <i data-lucide="wallet" class="w-8 h-8 text-accent-orange"></i>
                            <span class="text-xl font-extrabold text-gray-900">$${totalBudget.toLocaleString()}</span>
                        </div>
                        <p class="text-gray-500 mt-2">總預算概算 (NTD)</p>
                    </div>
                </div>

                <!-- 專案列表與進度 (核心儀表) -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">所有專案概覽</h3>
                    
                    ${isProjectListEmpty ? `
                        <div class="text-center py-10">
                            <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
                            <p class="text-lg text-gray-600">目前沒有專案資料。</p>
                            <button onclick="setView('creation')" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 新增第一個專案
                            </button>
                        </div>
                    ` : `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號/名稱</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專案管理人</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">進度</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">即時狀態</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${projects.map(p => `
                                        <tr>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-blue hover:underline cursor-pointer" onclick="setView('details', '${p.id}')">
                                                <div class="text-xs text-gray-500">${p.id}</div>
                                                ${p.title}
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800">${p.manager}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                                <div class="w-32 bg-gray-200 rounded-full h-2.5">
                                                    <div class="progress-bar h-2.5 rounded-full ${p.progress >= 95 ? 'bg-secondary-green' : p.progress < 50 ? 'bg-accent-orange' : 'bg-primary-blue'}" style="width: ${p.progress}%;"></div>
                                                </div>
                                                <span class="text-xs text-gray-500 mt-1">${p.progress}%</span>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.progress >= 95 ? 'bg-secondary-green/10 text-secondary-green' : p.progress < 50 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${p.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                                <button onclick="setView('details', '${p.id}')" class="text-primary-blue hover:text-blue-700 text-sm">
                                                    查看詳情
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>

                <!-- 互動式串接表單 (即時更新/問題回報) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="send" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        即時更新/問題回報 (串接表單)
                    </h3>
                    <form id="integration-form" class="space-y-4">
                        <div>
                            <label for="update-project-id" class="block text-sm font-medium text-gray-700">選擇專案</label>
                            <select id="update-project-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                                ${projects.length > 0 ? projects.map(p => `<option value="${p.id}">${p.id} - ${p.title}</option>`).join('') : '<option value="">請先新增專案</option>'}
                            </select>
                        </div>
                        <div>
                            <label for="update-manager" class="block text-sm font-medium text-gray-700">負責人</label>
                            <select id="update-manager" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                                ${projectManagers.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="update-message" class="block text-sm font-medium text-gray-700">更新/問題描述</label>
                            <textarea id="update-message" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" placeholder="請輸入即時更新內容或遇到的問題..."></textarea>
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-accent-orange hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-orange" ${isProjectListEmpty ? 'disabled' : ''}>
                            提交更新
                        </button>
                    </form>
                    <div id="update-feedback" class="mt-4 text-sm font-medium"></div>
                </div>
            `;
            
            // 初始化 Lucide 圖標
            lucide.createIcons();

            // 綁定表單提交事件 (模擬即時更新提交到 Firestore 的 logic)
            document.getElementById('integration-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const projectId = document.getElementById('update-project-id').value;
                const projectTitle = projects.find(p => p.id === projectId)?.title || projectId;
                const manager = document.getElementById('update-manager').value;
                const message = document.getElementById('update-message').value;
                const feedback = document.getElementById('update-feedback');

                if (!message || !projectId) {
                    feedback.className = 'mt-4 text-sm font-medium text-red-500';
                    feedback.textContent = '請填寫完整的更新訊息。';
                    return;
                }
                
                // NEW: 在嘗試寫入前檢查權限
                if (!isAuthorized()) {
                    showModal('權限不足', '您沒有權限提交更新。請確認登入狀態。');
                    feedback.className = 'mt-4 text-sm font-medium text-red-500';
                    feedback.textContent = '權限不足，無法提交。';
                    return;
                }

                if (db && isAuthReady) { // 增加 isAuthReady 檢查
                    try {
                        // 1. 寫入 Firestore
                        const docRef = await addDoc(collection(db, TASKS_COLLECTION_PATH), {
                            projectId: projectId,
                            taskName: `即時更新: ${message.substring(0, 30)}...`,
                            description: message,
                            assignee: manager,
                            dueDate: new Date().toISOString().split('T')[0], // 以當前日期作為期限
                            status: '更新', // 使用 '更新' 狀態標記
                            createdAt: serverTimestamp(),
                            reporterId: currentUserId
                        });
                        
                        // 2. NEW: 發送 Teams 通知 (如果 Webhook 配置了)
                        const teamsTitle = `[專案更新] ${projectTitle}`;
                        const teamsText = `**回報人:** ${manager}\n\n**專案:** ${projectTitle} (${projectId})\n\n**訊息:** ${message}`;
                        sendTeamsNotification(teamsTitle, teamsText, 'ea580c'); // Accent Orange

                        feedback.className = 'mt-4 text-sm font-medium text-secondary-green';
                        feedback.textContent = `成功提交更新 (ID: ${docRef.id})。請至任務管理頁面查看。`;
                        document.getElementById('integration-form').reset();
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        feedback.className = 'mt-4 text-sm font-medium text-red-500';
                        feedback.textContent = '提交更新失敗：資料庫錯誤。';
                    }
                } else {
                    feedback.className = 'mt-4 text-sm font-medium text-yellow-600';
                    feedback.textContent = '資料庫未連接或認證尚未完成，無法提交。';
                }
            });
        }

        /**
         * 渲染專案建立/編輯頁面
         */
        function renderProjectCreation() {
            const container = document.getElementById('main-content');
            
            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                    <i data-lucide="folder-plus" class="w-7 h-7 mr-3 text-primary-blue"></i>
                    新增/編輯專案資料
                </h2>
                
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增專案</h3>
                    <form id="new-project-form" class="space-y-4">
                        <div>
                            <label for="proj-id" class="block text-sm font-medium text-gray-700">專案編號 (唯一)</label>
                            <input type="text" id="proj-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" placeholder="e.g. D3-O1-1-ABC">
                        </div>
                        <div>
                            <label for="proj-title" class="block text-sm font-medium text-gray-700">專案名稱</label>
                            <input type="text" id="proj-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" placeholder="e.g. 智慧醫療結合健康照護系統開發">
                        </div>
                        <div>
                            <label for="proj-manager" class="block text-sm font-medium text-gray-700">專案管理人</label>
                            <select id="proj-manager" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                                ${projectManagers.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="proj-budget" class="block text-sm font-medium text-gray-700">預算概算 (NTD)</label>
                                <input type="number" id="proj-budget" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                            </div>
                            <div>
                                <label for="proj-progress" class="block text-sm font-medium text-gray-700">初始進度 (%)</label>
                                <input type="number" id="proj-progress" min="0" max="100" value="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                            </div>
                        </div>
                        <div>
                            <label for="proj-status" class="block text-sm font-medium text-gray-700">初始狀態描述</label>
                            <input type="text" id="proj-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" value="待啟動 (文件準備)">
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-secondary-green hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-green">
                            儲存新專案
                        </button>
                    </form>
                    <div id="project-form-feedback" class="mt-4 text-sm font-medium"></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">已建立專案清單</h3>
                    <div id="existing-projects-list" class="space-y-3">
                        ${projects.length > 0 ? projects.map(p => {
                            // NEW: 檢查是否為專案創建者
                            const isOwner = p.reporterId === currentUserId; 
                            
                            return `
                                <div class="flex justify-between items-center p-3 border-b hover:bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-primary-blue cursor-pointer" onclick="setView('details', '${p.id}')">${p.title}</p>
                                        <p class="text-xs text-gray-500">${p.id} | 負責人: ${p.manager} 
                                        ${isOwner ? '<span class="text-xs font-semibold text-accent-orange ml-2"> (我的創建)</span>' : ''}
                                        </p>
                                    </div>
                                    <div>
                                        ${isOwner ? 
                                            `<button onclick="deleteProject('${p.id}')" class="text-red-500 hover:text-red-700 text-sm ml-4">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i> 刪除
                                            </button>` : 
                                            `<span class="text-xs text-gray-400">非創建者不可刪除</span>`
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-gray-500 text-center py-4">目前沒有任何專案資料。</p>'}
                    </div>
                </div>
            `;
            lucide.createIcons();
            document.getElementById('new-project-form')?.addEventListener('submit', handleNewProjectSubmission);
        }
        
        /**
         * 處理新增專案提交
         */
        async function handleNewProjectSubmission(e) {
            e.preventDefault();
            
            // NEW: 寫入前檢查權限
            if (!isAuthorized()) {
                showModal('權限不足', '您沒有權限新增專案。請確認登入狀態。');
                return;
            }
            
            if (!db || !isAuthReady) {
                showModal('錯誤', '資料庫未連線或認證尚未完成，無法新增專案。');
                return;
            }

            const projectId = document.getElementById('proj-id').value.trim();
            const title = document.getElementById('proj-title').value.trim();
            const manager = document.getElementById('proj-manager').value;
            const budget = parseInt(document.getElementById('proj-budget').value) || 0;
            const progress = parseInt(document.getElementById('proj-progress').value) || 0;
            const status = document.getElementById('proj-status').value.trim();
            const feedback = document.getElementById('project-form-feedback');

            if (projects.some(p => p.id === projectId)) {
                 feedback.className = 'mt-4 text-sm font-medium text-red-500';
                 feedback.textContent = `錯誤：專案編號 ${projectId} 已存在！`;
                 return;
            }

            try {
                // 使用 setDoc 並指定 ID，確保專案 ID 為文件 ID
                await setDoc(doc(db, PROJECTS_COLLECTION_PATH, projectId), {
                    id: projectId,
                    title: title,
                    manager: manager,
                    budget: budget,
                    progress: progress,
                    status: status,
                    proposer: manager, // 將專案管理人作為提案人 (可視為主要負責人)
                    manpower: 0, // 初始人力為 0
                    type: '手動輸入',
                    createdAt: serverTimestamp(),
                    reporterId: currentUserId // 紀錄創建者 ID (用於權限檢查)
                });
                
                // NEW: 發送 Teams 通知 (新增專案)
                const teamsTitle = `[新專案建立] ${title}`;
                const teamsText = `**專案編號:** ${projectId}\n\n**專案管理人:** ${manager}\n\n**初始進度:** ${progress}%`;
                sendTeamsNotification(teamsTitle, teamsText, '059669'); // Secondary Green

                feedback.className = 'mt-4 text-sm font-medium text-secondary-green';
                feedback.textContent = '專案新增成功！列表已即時更新。';
                document.getElementById('new-project-form').reset();
            } catch (e) {
                console.error("Error adding project document: ", e);
                feedback.className = 'mt-4 text-sm font-medium text-red-500';
                feedback.textContent = `專案新增失敗：${e.message}`;
            }
        }

        /**
         * 處理刪除專案
         */
        async function deleteProject(projectId) {
            
            const project = projects.find(p => p.id === projectId);
            
            // NEW: 刪除前檢查權限
            if (!project || project.reporterId !== currentUserId) {
                showModal('權限不足', '您只能刪除您自己創建的專案。');
                return;
            }
            
            if (!db || !isAuthReady) {
                showModal('錯誤', '資料庫未連線或認證尚未完成，無法刪除。');
                return;
            }
            
            if (confirm(`確定要刪除專案 ID: ${projectId} 嗎？此操作不可逆。`)) {
                try {
                    await deleteDoc(doc(db, PROJECTS_COLLECTION_PATH, projectId));
                    
                    // NEW: 發送 Teams 通知 (刪除專案)
                    const teamsTitle = `[專案已刪除] ${project?.title || projectId}`;
                    const teamsText = `專案 ${projectId} 已由使用者 ${currentUserId} 刪除。`;
                    sendTeamsNotification(teamsTitle, teamsText, 'DC2626'); // Red

                    showModal('刪除成功', `專案 ${projectId} 已被移除。`);
                    // onSnapshot 會自動處理列表更新
                } catch (e) {
                    console.error("Error deleting project:", e);
                    showModal('錯誤', `刪除專案失敗：${e.message}`);
                }
            }
        }
        window.deleteProject = deleteProject; // 暴露給 HTML 呼叫


        /**
         * 渲染專案詳情頁面 (Project Details)
         * @param {string} projectId - 專案 ID
         */
        function renderProjectDetails(projectId) {
            const project = projects.find(p => p.id === projectId);
            const container = document.getElementById('main-content');
            
            if (!project) {
                container.innerHTML = `<h2 class="text-2xl font-bold text-red-600">專案 ${projectId} 找不到。</h2>`;
                return;
            }

            // 過濾出與此專案相關的任務
            const projectTasks = tasks.filter(t => t.projectId === projectId);
            
            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                    <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i>
                    專案詳情: ${project.title}
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- 基本資訊卡片 -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-3">
                        <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">基本資訊</h3>
                        <p class="text-sm"><strong class="text-gray-600">專案編號:</strong> ${project.id}</p>
                        <p class="text-sm"><strong class="text-gray-600">提案單位:</strong> ${project.proposer || 'N/A'}</p>
                        <p class="text-sm"><strong class="text-gray-600">專案管理人:</strong> <span class="text-lg font-bold text-secondary-green">${project.manager}</span></p>
                        <p class="text-sm"><strong class="text-gray-600">預算概算:</strong> $${(project.budget || 0).toLocaleString()}</p>
                        <p class="text-sm"><strong class="text-gray-600">人力需求:</strong> ${project.manpower || 0} 位</p>
                    </div>

                    <!-- 流程進度與文件 -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">流程進度與相關文件</h3>
                        <div class="flex items-center space-x-4 mb-4">
                            <span class="text-gray-600 font-medium">總進度:</span>
                            <div class="flex-grow bg-gray-200 rounded-full h-4">
                                <div class="progress-bar h-4 rounded-full ${project.progress >= 95 ? 'bg-secondary-green' : project.progress < 50 ? 'bg-accent-orange' : 'bg-primary-blue'}" style="width: ${project.progress}%;"></div>
                            </div>
                            <span class="font-bold text-lg ${project.progress >= 95 ? 'text-secondary-green' : 'text-primary-blue'}">${project.progress}%</span>
                        </div>
                        
                        <div class="space-y-2 mt-6">
                            <h4 class="text-md font-semibold text-gray-700">任務與流程狀態</h4>
                            <p class="text-sm text-gray-600">目前狀態: <span class="font-medium text-lg text-red-500">${project.status}</span></p>
                            
                            <h4 class="text-md font-semibold text-gray-700 mt-4">相關文件 (模擬)</h4>
                            <ul class="list-disc list-inside text-sm text-primary-blue space-y-1 ml-4">
                                <li><a href="#" class="hover:underline">專案文件 (${project.id}).docx (模擬文件)</a></li>
                                <li><a href="#" class="hover:underline">階段性報告 v1.pdf (模擬文件)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 任務列表 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-primary-blue"></i>
                        專案任務列表
                    </h3>
                    <div id="project-tasks-list">
                        ${projectTasks.length > 0 ? projectTasks.map(t => `
                            <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800">${t.taskName}</p>
                                    <p class="text-xs text-gray-500">負責人: ${t.assignee} | 期限: ${t.dueDate}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${t.status === '完成' ? 'bg-secondary-green/20 text-secondary-green' : t.status === '進行中' ? 'bg-yellow-100 text-yellow-800' : t.status === '更新' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                    ${t.status}
                                </span>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">此專案目前沒有建立的任務。</p>'}
                    </div>
                    <button onclick="setView('tasks')" class="mt-4 text-sm text-primary-blue hover:underline flex items-center">
                        前往任務管理頁面新增任務 <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * 渲染任務管理頁面 (Task Management)
         */
        function renderTaskManagement() {
            const container = document.getElementById('main-content');
            
            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                    <i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-primary-blue"></i>
                    任務管理中心
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 任務分配表單 -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">分配新任務</h3>
                        <form id="new-task-form" class="space-y-4">
                            <div>
                                <label for="task-project-id" class="block text-sm font-medium text-gray-700">所屬專案</label>
                                <select id="task-project-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                                    ${projects.length > 0 ? projects.map(p => `<option value="${p.id}">${p.id} - ${p.title}</option>`).join('') : '<option value="">請先新增專案</option>'}
                                </select>
                            </div>
                            <div>
                                <label for="task-name" class="block text-sm font-medium text-gray-700">任務名稱</label>
                                <input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" placeholder="e.g. 設備採購文件準備">
                            </div>
                            <div>
                                <label for="task-assignee" class="block text-sm font-medium text-gray-700">分配給</label>
                                <select id="task-assignee" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                                    ${projectManagers.map(m => `<option value="${m}">${m}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="task-due-date" class="block text-sm font-medium text-gray-700">截止日期</label>
                                <input type="date" id="task-due-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border">
                            </div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue" ${projects.length === 0 ? 'disabled' : ''}>
                                分配任務
                            </button>
                        </form>
                        <div id="task-form-feedback" class="mt-4 text-sm font-medium"></div>
                    </div>

                    <!-- 任務列表與過濾 -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">所有任務追蹤</h3>
                        
                        <!-- 任務過濾器 -->
                        <div class="flex space-x-3 mb-4 text-sm">
                            <select id="task-filter-manager" class="rounded-md border-gray-300 p-2 border">
                                <option value="">所有負責人</option>
                                ${projectManagers.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                            <select id="task-filter-status" class="rounded-md border-gray-300 p-2 border">
                                <option value="">所有狀態</option>
                                <option value="待辦">待辦</option>
                                <option value="進行中">進行中</option>
                                <option value="完成">完成</option>
                                <option value="更新">即時更新</option>
                            </select>
                            <button onclick="renderTaskList()" class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">
                                過濾
                            </button>
                        </div>
                        
                        <!-- 任務實際列表 -->
                        <div id="current-tasks-list" class="space-y-2">
                            <!-- 任務列表將由 renderTaskList 渲染 -->
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            // 綁定表單提交事件
            document.getElementById('new-task-form')?.addEventListener('submit', handleNewTaskSubmission);
            
            // 首次渲染任務列表
            renderTaskList();
        }

        /**
         * 處理新增任務提交
         */
        async function handleNewTaskSubmission(e) {
            e.preventDefault();
            
            // NEW: 寫入前檢查權限
            if (!isAuthorized()) {
                showModal('權限不足', '您沒有權限分配任務。請確認登入狀態。');
                return;
            }
            
            if (!db || !isAuthReady) {
                showModal('錯誤', '資料庫未連線或認證尚未完成，無法新增任務。');
                return;
            }

            const projectId = document.getElementById('task-project-id').value;
            const projectTitle = projects.find(p => p.id === projectId)?.title || projectId;
            const taskName = document.getElementById('task-name').value;
            const assignee = document.getElementById('task-assignee').value;
            const dueDate = document.getElementById('task-due-date').value;
            const feedback = document.getElementById('task-form-feedback');
            
            if (projects.length === 0) {
                feedback.className = 'mt-4 text-sm font-medium text-red-500';
                feedback.textContent = '請先建立專案才能分配任務。';
                return;
            }

            try {
                await addDoc(collection(db, TASKS_COLLECTION_PATH), {
                    projectId: projectId,
                    taskName: taskName,
                    assignee: assignee,
                    dueDate: dueDate,
                    status: '待辦',
                    createdAt: serverTimestamp(),
                    reporterId: currentUserId
                });
                
                // NEW: 發送 Teams 通知 (新增任務)
                const teamsTitle = `[新任務分配] ${taskName}`;
                const teamsText = `**專案:** ${projectTitle} (${projectId})\n\n**負責人:** ${assignee}\n\n**截止日期:** ${dueDate}\n\n**狀態:** 待辦`;
                sendTeamsNotification(teamsTitle, teamsText, '1e40af'); // Primary Blue

                feedback.className = 'mt-4 text-sm font-medium text-secondary-green';
                feedback.textContent = '任務分配成功！';
                document.getElementById('new-task-form').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                feedback.className = 'mt-4 text-sm font-medium text-red-500';
                feedback.textContent = '任務分配失敗：資料庫錯誤。';
            }
        }

        /**
         * 渲染過濾後的任務列表
         */
        function renderTaskList() {
            const listContainer = document.getElementById('current-tasks-list');
            if (!listContainer) return; // 確保在正確的頁面
            
            const filterManager = document.getElementById('task-filter-manager')?.value || '';
            const filterStatus = document.getElementById('task-filter-status')?.value || '';

            const filteredTasks = tasks.filter(t => 
                (!filterManager || t.assignee === filterManager) &&
                (!filterStatus || t.status === filterStatus)
            ).sort((a, b) => {
                // 待辦優先，日期較早優先
                if (a.status === '待辦' && b.status !== '待辦') return -1;
                if (a.status !== '待辦' && b.status === '待辦') return 1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            if (filteredTasks.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-8">沒有符合過濾條件的任務。</p>';
                return;
            }
            
            listContainer.innerHTML = filteredTasks.map(t => {
                const project = projects.find(p => p.id === t.projectId);
                let badgeClass = 'bg-gray-100 text-gray-700';
                let actionText = '標記完成';
                let actionFn = `updateTaskStatus('${t.id}', '完成')`;

                if (t.status === '待辦') {
                    badgeClass = 'bg-red-100 text-red-800';
                    actionText = '開始進行';
                    actionFn = `updateTaskStatus('${t.id}', '進行中')`;
                } else if (t.status === '進行中') {
                    badgeClass = 'bg-yellow-100 text-yellow-800';
                } else if (t.status === '完成') {
                    badgeClass = 'bg-secondary-green/20 text-secondary-green';
                    actionText = '已完成';
                    actionFn = `showModal('已完成', '此任務已標記完成，無法再操作。');`;
                } else if (t.status === '更新') {
                     badgeClass = 'bg-blue-100 text-blue-800';
                     actionText = '查看詳情';
                     actionFn = `setView('details', '${t.projectId}')`;
                }

                return `
                    <div class="project-card bg-gray-50 p-4 rounded-lg border-l-4 ${t.status === '待辦' ? 'border-red-500' : t.status === '進行中' ? 'border-yellow-500' : t.status === '完成' ? 'border-secondary-green' : 'border-blue-500'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="font-bold text-lg text-gray-900">${t.taskName}</p>
                                <p class="text-xs text-gray-500">專案: <span class="font-medium text-primary-blue cursor-pointer hover:underline" onclick="setView('details', '${t.projectId}')">${project ? project.title : '未知專案'}</span></p>
                            </div>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${badgeClass}">${t.status}</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-700 flex justify-between items-center">
                            <p>
                                <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                負責人: <span class="font-medium">${t.assignee}</span>
                                <span class="ml-4">
                                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                    期限: ${t.dueDate}
                                </span>
                            </p>
                            ${t.status !== '更新' ? 
                                `<button onclick="${actionFn}" class="px-3 py-1 text-xs rounded-lg text-white bg-secondary-green hover:bg-green-700">
                                    ${actionText}
                                </button>` 
                                : 
                                `<button onclick="${actionFn}" class="px-3 py-1 text-xs rounded-lg text-white bg-blue-600 hover:bg-blue-700">
                                    ${actionText}
                                </button>`
                            }
                            
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        /**
         * 更新任務狀態
         * @param {string} taskId - 任務文檔 ID
         * @param {string} newStatus - 新狀態 ('進行中' 或 '完成')
         */
        async function updateTaskStatus(taskId, newStatus) {
            
            // NEW: 寫入前檢查權限
            if (!isAuthorized()) {
                showModal('權限不足', '您沒有權限更新任務狀態。請確認登入狀態。');
                return;
            }
            
            if (!db || !isAuthReady) {
                showModal('錯誤', '資料庫未連線或認證尚未完成，無法更新任務狀態。');
                return;
            }
            try {
                const taskRef = doc(db, TASKS_COLLECTION_PATH, taskId);
                await updateDoc(taskRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
                
                // NEW: 發送 Teams 通知 (任務狀態變更)
                const task = tasks.find(t => t.id === taskId);
                const projectTitle = projects.find(p => p.id === task?.projectId)?.title || task?.projectId;
                
                if (task) {
                    const teamsTitle = `[任務狀態更新] ${task.taskName}`;
                    const teamsText = `**專案:** ${projectTitle}\n\n**任務:** ${task.taskName}\n\n**負責人:** ${task.assignee}\n\n**新狀態:** **${newStatus}**`;
                    
                    let color = 'f97316'; // Orange for general update
                    if (newStatus === '完成') color = '059669'; // Green
                    if (newStatus === '進行中') color = 'facc15'; // Yellow
                    
                    sendTeamsNotification(teamsTitle, teamsText, color);
                }

                showModal('成功', `任務已更新為 [${newStatus}]。`);
                // onSnapshot 會自動更新列表
            } catch (e) {
                console.error("Error updating document: ", e);
                showModal('錯誤', `更新任務失敗：${e.message}`);
            }
        }

        /**
         * 渲染報告與下載頁面 (Reporting & Download)
         */
        function renderReporting() {
            const container = document.getElementById('main-content');
            
            // 報告數據 (基於 projects 和 tasks)
            const managerReport = projectManagers.map(manager => {
                const managedProjects = projects.filter(p => p.manager === manager);
                const managerTasks = tasks.filter(t => t.assignee === manager);
                const completedTasks = managerTasks.filter(t => t.status === '完成').length;
                
                return {
                    manager,
                    managedProjectsCount: managedProjects.length,
                    avgProgress: managedProjects.length > 0 
                        ? (managedProjects.reduce((sum, p) => sum + p.progress, 0) / managedProjects.length).toFixed(1) 
                        : 0,
                    totalTasks: managerTasks.length,
                    completedTasks: completedTasks,
                    taskCompletionRate: managerTasks.length > 0 
                        ? ((completedTasks / managerTasks.length) * 100).toFixed(1) 
                        : 0
                };
            });
            
            const isDataAvailable = projects.length > 0 || tasks.length > 0;

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                    <i data-lucide="trending-up" class="w-7 h-7 mr-3 text-primary-blue"></i>
                    專案報告與下載
                </h2>

                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">專案經理績效概覽</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專案經理</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">負責專案數</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均專案進度 (%)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總任務數</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任務完成率 (%)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${managerReport.map(r => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r.manager}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm">${r.managedProjectsCount}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-primary-blue">${r.avgProgress}%</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm">${r.totalTasks}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-secondary-green font-bold">${r.taskCompletionRate}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 下載功能區 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">報告下載 (.CSV 格式)</h3>
                    
                    ${!isDataAvailable ? 
                        `<p class="text-red-500 font-medium">警告：目前沒有任何專案或任務資料可供下載。</p>` : ''
                    }
                    
                    <div class="space-y-4 mt-4">
                        <div class="flex items-center space-x-4">
                            <button id="download-progress-btn" class="flex items-center px-4 py-2 bg-secondary-green text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-green" ${projects.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                下載專案進度總表 (CSV)
                            </button>
                            <span class="text-sm text-gray-500">包含所有專案的基本資訊與進度。</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="download-tasks-btn" class="flex items-center px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue" ${tasks.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                下載所有任務清單 (CSV)
                            </button>
                            <span class="text-sm text-gray-500">包含所有任務的狀態、負責人與截止日期。</span>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            // 綁定下載事件
            document.getElementById('download-progress-btn')?.addEventListener('click', () => downloadReportCSV(projects, ['id', 'title', 'manager', 'progress', 'status', 'budget', 'proposer', 'manpower'], ['編號', '名稱', '管理人', '進度(%)', '狀態', '預算', '提案人', '人力數'], '專案進度總表'));
            document.getElementById('download-tasks-btn')?.addEventListener('click', () => downloadReportCSV(tasks, ['projectId', 'taskName', 'assignee', 'dueDate', 'status', 'createdAt', 'reporterId'], ['專案編號', '任務名稱', '負責人', '截止日期', '狀態', '建立時間', '回報人ID'], '任務清單'));
        }
        
        /**
         * 渲染系統設定頁面 (新增)
         */
        function renderSettings() {
             const container = document.getElementById('main-content');
             
             container.innerHTML = `
                 <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                     <i data-lucide="settings" class="w-7 h-7 mr-3 text-primary-blue"></i>
                     系統設定與整合
                 </h2>
                 
                 <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                         <i data-lucide="message-square" class="w-5 h-5 mr-2"></i>
                         Microsoft Teams Webhook 配置
                     </h3>
                     <p class="text-sm text-gray-600 mb-4">
                         請貼入您的 Microsoft Teams 頻道傳入 Webhook URL，以啟用專案和任務的即時通知。
                     </p>
                     <form id="teams-config-form" class="space-y-4">
                         <div>
                             <label for="teams-webhook-url" class="block text-sm font-medium text-gray-700">Teams Webhook URL</label>
                             <input type="url" id="teams-webhook-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue/50 p-2 border" placeholder="https://outlook.office.com/webhook/...">
                             <p class="text-xs text-red-500 mt-1" id="webhook-status">${teamsWebhookUrl ? '狀態：已配置' : '狀態：尚未配置'}</p>
                         </div>
                         <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue">
                             儲存 Webhook 配置
                         </button>
                     </form>
                 </div>
             `;
             lucide.createIcons();
             
             document.getElementById('teams-webhook-url').value = teamsWebhookUrl;
             document.getElementById('teams-config-form').addEventListener('submit', handleTeamsConfigSubmission);
        }
        
        /**
         * 處理 Teams Webhook 配置提交
         */
        async function handleTeamsConfigSubmission(e) {
            e.preventDefault();
            
            // NEW: 寫入前檢查權限
            if (!isAuthorized()) {
                showModal('權限不足', '您沒有權限儲存系統設定。請確認登入狀態。');
                return;
            }
            
            if (!db || !isAuthReady) {
                showModal('錯誤', '資料庫未連線或認證尚未完成，無法儲存設定。');
                return;
            }

            const newUrl = document.getElementById('teams-webhook-url').value.trim();
            const statusElement = document.getElementById('webhook-status');

            try {
                // 將 Webhook URL 儲存到 Firestore 的單一文檔中
                await setDoc(doc(db, SETTINGS_DOC_PATH), {
                    url: newUrl,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUserId
                });

                // 更新本地狀態
                teamsWebhookUrl = newUrl;
                statusElement.textContent = newUrl ? '狀態：已配置並儲存成功' : '狀態：已清除配置';
                statusElement.className = 'text-xs text-secondary-green mt-1';
                
                showModal('配置成功', `Teams Webhook URL 已更新。所有即時更新將發送至此 URL。`);

            } catch (e) {
                console.error("Error saving Teams config:", e);
                statusElement.textContent = '狀態：儲存失敗';
                statusElement.className = 'text-xs text-red-500 mt-1';
                showModal('錯誤', `儲存配置失敗：${e.message}`);
            }
        }
        
        /**
         * 產生並下載 CSV 檔案
         * @param {Array<Object>} data - 要下載的數據
         * @param {Array<string>} keys - 數據對象中的鍵 (英文)
         * @param {Array<string>} headers - CSV 的標題 (中文)
         * @param {string} filename - 檔案名稱
         */
        function downloadReportCSV(data, keys, headers, filename) {
            if (data.length === 0) {
                showModal('錯誤', '沒有數據可以下載。');
                return;
            }

            // 處理標題行 (加入 BOM 以確保 Excel 正確顯示中文)
            let csv = '\ufeff' + headers.join(',') + '\n';
            
            // 處理數據行
            data.forEach(item => {
                const row = keys.map(key => {
                    let value = item[key] !== undefined && item[key] !== null ? item[key] : '';
                    
                    // 確保逗號和換行符號被正確處理
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    
                    // 處理日期格式 (Firestore Timestamp)
                    if (key === 'createdAt' && typeof value.toDate === 'function') {
                        value = value.toDate().toLocaleString('zh-TW');
                    }
                    
                    return value;
                }).join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showModal('下載完成', `${filename} 已成功產生並開始下載。`);
        }

        // =================================================================
        // 4. 系統初始化與導航
        // =================================================================

        /**
         * 設定當前視圖並更新導航欄
         * @param {string} viewName - 視圖名稱 ('dashboard', 'details', 'tasks', 'report', 'creation', 'settings')
         * @param {string} [projectId] - 專案 ID (僅適用於 details 視圖)
         */
        window.setView = function(viewName, projectId = null) {
            currentView = viewName;
            
            // 更新導航欄樣式
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${viewName}`)?.classList.add('active'); // 使用 ?. 避免找不到元素時出錯

            // 渲染對應視圖
            switch (viewName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'creation':
                    renderProjectCreation();
                    break; 
                case 'details':
                    // 如果沒有專案，或傳入的 ID 不存在，則回到儀表板
                    if (projects.length === 0 || (projectId && !projects.find(p => p.id === projectId))) {
                        showModal('提示', '請先建立專案，或選擇一個有效的專案 ID。');
                        setView('dashboard');
                        return;
                    }
                    renderProjectDetails(projectId || projects[0].id); // 預設顯示第一個專案
                    break;
                case 'tasks':
                    renderTaskManagement();
                    break;
                case 'report':
                    renderReporting();
                    break;
                case 'settings':
                    renderSettings();
                    break; // 新增設定視圖
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * 啟動 Firestore 實時監聽 (同時監聽專案、任務和設定)
         */
        function startDataListeners() {
            if (!db || !isAuthReady || isListenerStarted) { 
                return;
            }
            isListenerStarted = true; 

            // --- 1. 專案資料監聽 (PROJECTS) ---
            const projectsQuery = query(collection(db, PROJECTS_COLLECTION_PATH));
            onSnapshot(projectsQuery, (snapshot) => {
                projects = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate()?.toISOString().split('T')[0] || 'N/A'
                }));
                console.log("Projects updated in real-time:", projects.length);
                
                // 自動重新渲染當前視圖以反映變動
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'creation') renderProjectCreation();
                if (currentView === 'tasks') renderTaskManagement();
                if (currentView === 'report') renderReporting();
                
            }, (error) => {
                console.error("Project listener failed:", error);
            });


            // --- 2. 任務資料監聽 (TASKS) ---
            const tasksQuery = query(collection(db, TASKS_COLLECTION_PATH));
            onSnapshot(tasksQuery, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate()?.toISOString().split('T')[0] || 'N/A' // 簡化日期顯示
                }));
                console.log("Tasks updated in real-time:", tasks.length);

                // 如果當前在任務管理或專案詳情頁面，重新渲染
                if (currentView === 'tasks') {
                    renderTaskList();
                } else if (currentView === 'details') {
                    const detailElement = document.getElementById('main-content');
                    const projectIdElement = detailElement.querySelector('p strong.text-gray-600')?.nextSibling;
                    
                    if (projectIdElement) {
                         const currentProjectId = projectIdElement.textContent?.trim();
                         if (currentProjectId) {
                             renderProjectDetails(currentProjectId);
                         }
                    }
                }
                
                lucide.createIcons();
            }, (error) => {
                console.error("Task listener failed:", error);
            });
            
            // --- 3. 系統設定監聽 (TEAMS WEBHOOK) ---
             onSnapshot(doc(db, SETTINGS_DOC_PATH), (docSnapshot) => {
                 if (docSnapshot.exists()) {
                     teamsWebhookUrl = docSnapshot.data().url || '';
                     console.log("Teams Webhook URL loaded:", teamsWebhookUrl ? 'Configured' : 'Not configured');
                 } else {
                      teamsWebhookUrl = '';
                 }
                 // 如果在設定頁，重新渲染以顯示最新狀態
                 if (currentView === 'settings') renderSettings();
             }, (error) => {
                 console.error("Settings listener failed:", error);
             });
        }
        
        /**
         * 系統初始化主函數
         */
        async function initializeSystem(withDb = true) {
            // 只有在資料庫可用且認證完成時才啟動資料監聽
            if (withDb && isAuthReady) {
                startDataListeners();
            }
            
            // 首次渲染儀表板
            setView('dashboard');
        }
        
        // --- 啟動流程完全依賴 performAuth 函數 ---
        
        // 如果 Firebase Config 或 Token 缺失，則只執行非 DB 初始化
        if (!firebaseConfig || !initialAuthToken) {
             initializeSystem(false);
        }
        
    </script>
</body>
</html>
