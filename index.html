<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <!-- 修正後 CSP：允許 Firebase Auth 必需的 Google 子網域 -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline'
                            https://www.gstatic.com
                            https://*.gstatic.com
                            https://cdn.tailwindcss.com
                            https://unpkg.com
                            https://cdn.jsdelivr.net
                            https://www.google.com
                            https://*.google.com
                            https://apis.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src 'self'
                           https://www.google.com
                           https://*.google.com
                           https://www.gstatic.com
                           https://*.gstatic.com
                           https://accounts.google.com
                           https://apis.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <!-- UI 套件 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- 專案設定 -->
  <script>
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__ai_summary_webapp_url = "https://script.google.com/macros/s/AKfycbzBaT08WiuMIpqVNrG70iTVMUFXY1X-1zSn0uKa3xgLa4KdUwFbL5q7xh5OwpJMAblAdQ/exec";
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-icon{width:22px;height:22px;stroke-width:2.2}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
    /* debug 面板（?debug=1 顯示） */
    #debug{position:fixed;right:8px;bottom:8px;background:#111827;color:#e5e7eb;border-radius:10px;max-width:48rem;width:calc(100vw - 16px);font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
    #debug header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid #374151}
    #debug pre{margin:0;padding:8px 10px;max-height:40vh;overflow:auto;white-space:pre-wrap}
    #debug .pill{background:#374151;color:#9ca3af;border-radius:20px;padding:2px 8px;margin-left:6px;font-size:11px}
    #debug .ok{color:#10b981} #debug .warn{color:#f59e0b} #debug .err{color:#ef4444}
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁 -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-blue-800">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">使用 Google 登入以進入儀表板</p>
        <button id="btn-landing-login" onclick="signInWithGoogle()"
                class="mt-6 w-full py-3 rounded-xl bg-blue-800 hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>
        <div id="landing-loading" class="hidden mt-4 text-center text-sm text-gray-600">登入狀態還原中，請稍候…</div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- App 殼 -->
  <div id="app-shell" class="hidden">
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
          </button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="nav-icon"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="nav-icon"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="file-text" class="nav-icon"></i><span class="nav-label">報告</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm">U</div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()"><i data-lucide="log-out" class="nav-icon"></i><span class="nav-label">登出</span></button>
      </div>
    </aside>

    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <!-- Debug 面板：網址加 ?debug=1 會顯示 -->
  <div id="debug">
    <header>
      <div>Auth Debug<span id="dbg-state" class="pill">init</span></div>
      <button style="color:#9ca3af" onclick="document.getElementById('debug').style.display='none'">✕</button>
    </header>
    <pre id="dbg-log"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      initializeAuth,
      indexedDBLocalPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      GoogleAuthProvider,
      onAuthStateChanged,
      onIdTokenChanged,
      signInWithRedirect,
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, onSnapshot, collection, query, orderBy, doc, serverTimestamp, addDoc, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('error');

    // ============ Debug 工具 ============
    const debugMode = /[?&]debug=1/.test(location.search);
    const dbgEl = document.getElementById('debug');
    const dbgLogEl = document.getElementById('dbg-log');
    const dbgStateEl = document.getElementById('dbg-state');
    if (debugMode) { dbgEl.style.display='block'; }
    function logDbg(type, msg, obj){
      if(!debugMode) return;
      const now = new Date().toISOString().slice(11,19);
      const line = `[${now}] [${type}] ${msg}${obj?`: ${typeof obj==='string'?obj:JSON.stringify(obj)}`:''}\n`;
      dbgLogEl.textContent += line;
      dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
    }
    function setDbgState(s, cls){ if(!debugMode) return; dbgStateEl.textContent = s; dbgStateEl.className = 'pill ' + (cls||''); }

    // ============ 全域狀態 ============
    let db, auth;
    let currentUserId = "";
    let listenersStarted = false;
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object;

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;

    // DOM
    const landing = document.getElementById("landing");
    const appShell = document.getElementById("app-shell");
    const landingLoading=document.getElementById("landing-loading");

    // UI 輔助
    function showAppShell(show){
      if(show){ landing.classList.add("hidden"); appShell.classList.remove("hidden"); }
      else { appShell.classList.add("hidden"); landing.classList.remove("hidden"); }
      if(window.lucide?.createIcons) lucide.createIcons();
    }
    function updateUserChips(user){
      const name = user?.displayName || user?.email?.split("@")[0] || "使用者";
      const email = user?.email || "";
      const avatar = user?.photoURL || "";
      const nameEl = document.getElementById("user-display-name");
      const emailEl= document.getElementById("user-email");
      const avEl   = document.getElementById("user-avatar");
      const initEl = document.getElementById("user-initial");
      if(nameEl) nameEl.textContent = name;
      if(emailEl) emailEl.textContent = email;
      if(avatar){ avEl.src = avatar; avEl.classList.remove("hidden"); initEl.classList.add("hidden"); }
      else { avEl.classList.add("hidden"); initEl.classList.remove("hidden"); initEl.textContent = (name[0]||'U').toUpperCase(); }
    }
    function applyUser(user){
      if(user){
        currentUserId = user.uid;
        updateUserChips(user);
        showAppShell(true);
        setDbgState('signed-in', 'ok'); logDbg('OK','applyUser signed-in',{uid:user.uid,email:user.email});
        if(!listenersStarted) startRealtime();
      }else{
        currentUserId = "";
        showAppShell(false);
        setDbgState('signed-out'); logDbg('INFO','applyUser signed-out');
      }
    }

    // 側欄收合
    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const nextExpanded = (typeof force === 'boolean') ? force : !sb.classList.contains('expanded');
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){ btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="w-5 h-5"></i>' : '<i data-lucide="panel-left-open" class="w-5 h-5"></i>'; }
      if(window.lucide?.createIcons) lucide.createIcons();
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
    };

    // 登入：固定使用 Redirect（最穩定）
    window.signInWithGoogle = async function(){
      try{
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        setDbgState('redirecting','warn'); logDbg('INFO','signInWithRedirect start');
        await signInWithRedirect(auth, provider);
      }catch(e){
        setDbgState('redirect-failed','err'); logDbg('ERR','signInWithRedirect failed', {code:e?.code, message:e?.message});
        alert('登入失敗：' + (e?.message || e));
      }
    };

    window.appSignOut = async function(){
      try{ await signOut(auth); logDbg('OK','signed out'); }
      catch(e){ logDbg('ERR','signOut failed', e?.message || e); }
    };

    // 初始化
    async function init(){
      if(!firebaseConfig){ alert('缺少 Firebase 設定'); return; }
      const app = initializeApp(firebaseConfig);

      // 關鍵：使用 initializeAuth 並設定多重持久化，強韌化不同瀏覽器下的狀態還原
      auth = initializeAuth(app, {
        persistence: [indexedDBLocalPersistence, browserLocalPersistence, browserSessionPersistence]
      });

      // Firestore
      db = getFirestore(app);

      // 還原中提示
      landingLoading.classList.remove("hidden");
      setDbgState('restoring','warn'); logDbg('INFO','init: restoring...');

      // 先處理 redirect 結果，再掛監聽
      try{
        const rr = await getRedirectResult(auth);
        if(rr?.user){
          logDbg('OK','getRedirectResult user', {uid:rr.user.uid, email:rr.user.email});
          applyUser(rr.user);
        }else{
          logDbg('INFO','getRedirectResult empty');
        }
      }catch(e){
        logDbg('ERR','getRedirectResult error', {code:e?.code, message:e?.message});
      }

      // 雙保險：兩種監聽都接上
      onAuthStateChanged(auth, (user) => {
        landingLoading.classList.add("hidden");
        logDbg('INFO','onAuthStateChanged', !!user ? 'user present' : 'no user');
        applyUser(user);
      });
      onIdTokenChanged(auth, (user) => {
        logDbg('INFO','onIdTokenChanged', !!user ? 'user present' : 'no user');
        // 某些瀏覽器情境下，只有 onIdTokenChanged 會先到
        if(user && !currentUserId) applyUser(user);
      });
    }

    // ======== 簡化頁面渲染（重點是驗證 auth 能進到殼） ========
    let currentView = 'dashboard', events = [];
    function setView(v){ currentView=v; render(); }
    window.setView = setView;

    function render(){
      const c = document.getElementById('main-content');
      if(currentView==='dashboard'){
        c.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-blue-800"></i> 儀表板
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-gray-700">已成功登入，這裡是儀表板。</p>
            <p class="text-sm text-gray-500 mt-2">若你看到這個畫面，代表 Auth 流程已完全建立。</p>
          </div>`;
      } else if(currentView==='calendar'){
        c.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="calendar" class="w-7 h-7 mr-3 text-blue-800"></i> 行事曆
          </h2>
          <div class="bg-white p-4 rounded-xl shadow-lg"><div id="calendar"></div></div>`;
        if(window.FullCalendar){
          const el = document.getElementById('calendar');
          const cal = new FullCalendar.Calendar(el,{ initialView:'dayGridMonth', height:650, events });
          cal.render();
        }
      } else if(currentView==='report'){
        c.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="file-text" class="w-7 h-7 mr-3 text-blue-800"></i> 報告
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-gray-700">報告頁面（示範）。</p>
          </div>`;
      }
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    function startRealtime(){
      if(listenersStarted) return; listenersStarted = true;
      // 範例：監聽專案列表
      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), s=>{
        logDbg('INFO','projects snapshot', {count:s.size});
      });
      // 行事曆事件（示範）
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), s=>{
        events = s.docs.map(d=>({ id:d.id, title:d.data().title||'', start:d.data().startDate, end:d.data().endDate }));
        if(currentView==='calendar') render();
      });
      render();
    }

    // 啟動
    window.addEventListener('DOMContentLoaded', ()=>{
      const saved = (()=>{ try{ return localStorage.getItem('sidebarExpanded')!=='0'; }catch{return true} })();
      window.toggleSidebar(saved);
      showAppShell(false);
      init().catch(e=>logDbg('ERR','init failed', e?.message||e));
      if(window.lucide?.createIcons) lucide.createIcons();
    });
  </script>
</body>
</html>
