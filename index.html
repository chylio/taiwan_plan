<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <!-- 開發用 CSP（正式請以伺服器 HTTP Header 設定；若嵌入 Teams，請改以 Header 設定 frame-ancestors） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net;
                 connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 object-src 'none';
                 base-uri 'self';">

  <!-- Tailwind / Icons / FullCalendar（釘版本） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- Firebase 設定（已替換為你的實際值） -->
  <script>
    // 你的 Web App Firebase 組態（來自 Firebase Console）
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
      // measurementId: "G-T431K2TG7K" // 本專案未啟用 Analytics，可省略
    };
    // 用於切分 Firestore 路徑的 APP_ID（對應 artifacts/{APP_ID}/...）
    window.__app_id = "taiwanplan-f7566";
    // 若啟用 App Check（選用）：填入 reCAPTCHA v3 site key
    // window.__app_check_site_key = "YOUR_RECAPTCHA_V3_SITE_KEY";
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "Noto Sans TC", "sans-serif"] },
          colors: { "primary-blue":"#1e40af", "secondary-green":"#059669", "accent-orange":"#ea580c" }
        }
      }
    }
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .nav-item.active{background-color:#1e40af;color:#fff;border-left:4px solid #f97316}
    .nav-item{cursor:pointer;transition:all .15s}
    .progress-bar{transition:width .5s ease-in-out}
  </style>
</head>
<body class="bg-gray-50 font-sans flex min-h-screen">

  <!-- 側邊導航 -->
  <aside class="w-64 bg-white shadow-xl flex flex-col fixed h-full z-10">
    <div class="p-6 border-b border-gray-100">
      <h1 class="text-2xl font-extrabold text-primary-blue">
        深耕計畫 <span class="text-secondary-green">PM</span>
      </h1>
      <p class="text-xs text-gray-500 mt-1">專案管理中心</p>
    </div>
    <nav class="flex-grow p-4 space-y-2">
      <div id="nav-dashboard" class="nav-item active p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('dashboard')">
        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i><span class="font-medium">專案儀表板</span>
      </div>
      <div id="nav-creation" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('creation')">
        <i data-lucide="folder-plus" class="w-5 h-5 mr-3"></i><span class="font-medium">新增/編輯專案</span>
      </div>
      <div id="nav-details" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('details')">
        <i data-lucide="folder-open" class="w-5 h-5 mr-3"></i><span class="font-medium">專案詳情（範例）</span>
      </div>
      <div id="nav-tasks" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('tasks')">
        <i data-lucide="check-square" class="w-5 h-5 mr-3"></i><span class="font-medium">任務管理</span>
      </div>
      <div id="nav-calendar" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('calendar')">
        <i data-lucide="calendar" class="w-5 h-5 mr-3"></i><span class="font-medium">行事曆</span>
      </div>
      <div id="nav-report" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center" onclick="setView('report')">
        <i data-lucide="file-text" class="w-5 h-5 mr-3"></i><span class="font-medium">報告與下載</span>
      </div>
      <div id="nav-settings" class="nav-item p-3 rounded-lg text-gray-800 hover:bg-primary-blue hover:text-white flex items-center border-t border-gray-100 mt-4 pt-4" onclick="setView('settings')">
        <i data-lucide="settings" class="w-5 h-5 mr-3"></i><span class="font-medium">系統設定</span>
      </div>
    </nav>
    <div class="p-4 border-t border-gray-100 text-sm text-gray-600">
      <p class="text-xs">當前使用者 UID:</p>
      <p id="user-id-display" class="font-mono text-xs break-all text-primary-blue">連線中...</p>
    </div>
  </aside>

  <!-- 主內容 -->
  <main class="flex-grow ml-64 p-8">
    <div id="main-content" class="w-full"></div>
  </main>

  <!-- 模態 -->
  <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end space-x-3">
        <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">確認</button>
      </div>
    </div>
  </div>

  <!-- App 腳本（自動匿名登入，無登入頁） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firestore 日誌
    setLogLevel('error');

    // 全域狀態
    let db, auth;
    let currentUserId = "initializing";
    let isAuthReady = false;
    let listenersStarted = false;

    // 注入變數解析
    const APP_ID = typeof window.__app_id !== "undefined" ? window.__app_id : "default-app-id";

    let firebaseConfig = null;
    if (typeof window.__firebase_config === "string") {
      try { firebaseConfig = JSON.parse(window.__firebase_config); } catch {}
    } else if (typeof window.__firebase_config === "object" && window.__firebase_config) {
      firebaseConfig = window.__firebase_config;
    } else if (window.__firebase_config_object) {
      firebaseConfig = window.__firebase_config_object;
    }

    const APP_CHECK_SITE_KEY = typeof window.__app_check_site_key !== "undefined" ? window.__app_check_site_key : "";

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;

    // 範例人員名單（可改成從 DB 取得）
    const projectManagers = ["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];

    // App 資料
    let currentView = "dashboard";
    let projects = [];
    let tasks = [];
    let events = [];
    let selectedProjectId = null;
    let calendarInstance = null;

    // 工具
    function escapeHtml(str){
      if(str==null) return "";
      return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function showModal(title, message){
      document.getElementById("modal-title").textContent = title || "提示";
      document.getElementById("modal-message").textContent = message || "";
      const modal = document.getElementById("custom-modal");
      const wrapper = document.getElementById("modal-content-wrapper");
      document.getElementById("modal-confirm-btn").onclick = () => {
        wrapper.classList.remove("scale-100","opacity-100");
        wrapper.classList.add("scale-95","opacity-0");
        setTimeout(()=>modal.classList.add("hidden"),300);
      };
      modal.classList.remove("hidden"); modal.classList.add("flex");
      setTimeout(()=>{ wrapper.classList.remove("scale-95","opacity-0"); wrapper.classList.add("scale-100","opacity-100"); },50);
    }
    function isAuthorized(){ return !!(isAuthReady && currentUserId && currentUserId!=="initializing"); }
    function setActiveNav(id){
      document.querySelectorAll(".nav-item").forEach(el=>el.classList.remove("active"));
      const el = document.getElementById(id);
      if(el) el.classList.add("active");
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // Teams 通知（可選；未配置後端 /notify 時會僅警告，不影響 UX）
    async function sendTeamsNotification(title,text,color="0078D4"){
      try{
        const resp = await fetch("/notify",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({title,text,themeColor:color})
        });
        if(!resp.ok){ console.warn("notify failed", resp.status, await resp.text()); }
      }catch(e){ console.warn("notify error", e); }
    }

    // 初始化 Firebase（自動匿名登入）
    async function initFirebase(){
      try{
        if(!firebaseConfig) throw new Error("缺少 Firebase 設定（請填入 window.__firebase_config 或 __firebase_config_object）");
        const app = initializeApp(firebaseConfig);

        // 可選：App Check（建議在 Console 開啟並強制）
        if(APP_CHECK_SITE_KEY){
          initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider(APP_CHECK_SITE_KEY),
            isTokenAutoRefreshEnabled: true
          });
        }

        db = getFirestore(app);
        auth = getAuth(app);

        const cred = await signInAnonymously(auth);
        currentUserId = cred.user.uid;
        isAuthReady = true;
        document.getElementById("user-id-display").textContent = currentUserId + " (anonymous)";

        initializeSystem(true);
      }catch(e){
        console.error("初始化失敗：", e);
        document.getElementById("user-id-display").textContent = "初始化失敗（資料功能停用）";
        isAuthReady = false;
        initializeSystem(false);
      }
    }

    function startRealtimeListeners(){
      if(!db || listenersStarted) return;
      listenersStarted = true;

      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{
        projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
        rerenderByView();
      });

      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{
        tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        rerenderByView();
      });

      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), (snap)=>{
        events = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(currentView==="calendar") renderCalendar();
      });
    }

    // 視圖切換
    window.setView = function(view, arg){
      currentView = view;
      if(view==="dashboard"){ setActiveNav("nav-dashboard"); renderDashboard(); }
      else if(view==="creation"){ setActiveNav("nav-creation"); renderProjectCreation(); }
      else if(view==="details"){
        setActiveNav("nav-details");
        selectedProjectId = (typeof arg === "string" && arg) ? arg : (projects[0]?.id || null);
        renderProjectDetails(selectedProjectId);
      }
      else if(view==="tasks"){ setActiveNav("nav-tasks"); renderTaskManagement(); }
      else if(view==="calendar"){ setActiveNav("nav-calendar"); renderCalendar(); }
      else if(view==="report"){ setActiveNav("nav-report"); renderReport(); }
      else if(view==="settings"){ setActiveNav("nav-settings"); renderSettings(); }
    };
    function rerenderByView(){
      if(currentView==="dashboard") renderDashboard();
      if(currentView==="creation") renderProjectCreation();
      if(currentView==="details") renderProjectDetails(selectedProjectId);
      if(currentView==="tasks") renderTaskManagement();
      if(currentView==="calendar") renderCalendar();
      if(currentView==="report") renderReport();
      if(currentView==="settings") renderSettings();
    }

    // 儀表板
    function renderDashboard(){
      const c = document.getElementById("main-content");
      const totalProjects = projects.length;
      const completed = projects.filter(p => (Number(p.progress)||0) >= 95).length;
      const totalBudget = projects.reduce((s,p)=>s+(Number(p.budget)||0),0);
      const empty = totalProjects===0;

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">專案儀表板</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between">
              <i data-lucide="layers" class="w-8 h-8 text-primary-blue"></i>
              <span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span>
            </div>
            <p class="text-gray-500 mt-2">總專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-green">
            <div class="flex items-center justify-between">
              <i data-lucide="check-circle" class="w-8 h-8 text-secondary-green"></i>
              <span class="text-3xl font-extrabold text-gray-900">${completed}</span>
            </div>
            <p class="text-gray-500 mt-2">接近完成專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-accent-orange">
            <div class="flex items-center justify-between">
              <i data-lucide="wallet" class="w-8 h-8 text-accent-orange"></i>
              <span class="text-xl font-extrabold text-gray-900">$${totalBudget.toLocaleString()}</span>
            </div>
            <p class="text-gray-500 mt-2">總預算概算 (NTD)</p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">所有專案概覽</h3>
          ${ empty ? `
            <div class="text-center py-10">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
              <p class="text-lg text-gray-600">目前沒有專案資料。</p>
              <button onclick="setView('creation')" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 新增第一個專案
              </button>
            </div>` : `
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號/名稱</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專案管理人</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">進度</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">即時狀態</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${projects.map(p=>{
                    const prog = Number(p.progress)||0;
                    const bar = prog>=95 ? "bg-secondary-green" : (prog<50?"bg-accent-orange":"bg-primary-blue");
                    const badge = prog>=95 ? "bg-secondary-green/10 text-secondary-green" : (prog<50?"bg-accent-orange/10 text-accent-orange":"bg-primary-blue/10 text-primary-blue");
                    return `
                    <tr>
                      <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-blue hover:underline cursor-pointer" onclick="setView('details','${escapeHtml(p.id)}')">
                        <div class="text-xs text-gray-500">${escapeHtml(p.id)}</div>${escapeHtml(p.title)}
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800">${escapeHtml(p.manager||"")}</td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <div class="w-32 bg-gray-200 rounded-full h-2.5"><div class="progress-bar h-2.5 rounded-full ${bar}" style="width:${prog}%"></div></div>
                        <span class="text-xs text-gray-500 mt-1 inline-block">${prog}%</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badge}">${escapeHtml(p.status||"")}</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <button onclick="setView('details','${escapeHtml(p.id)}')" class="text-primary-blue hover:text-blue-700 text-sm">查看詳情</button>
                      </td>
                    </tr>`;}).join("")}
                </tbody>
              </table>
            </div>`}
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i data-lucide="send" class="w-5 h-5 mr-2 text-primary-blue"></i> 即時更新/問題回報
          </h3>
          <form id="integration-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">選擇專案</label>
              <select id="update-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>' }
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">負責人</label>
              <select id="update-manager" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${ projectManagers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("") }
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">更新/問題描述</label>
              <textarea id="update-message" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="請輸入更新內容"></textarea>
            </div>
            <button type="submit" class="w-full py-2 bg-accent-orange text-white rounded-lg hover:bg-orange-700">提交更新</button>
          </form>
          <div id="update-feedback" class="mt-4 text-sm font-medium"></div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("integration-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const projectId = document.getElementById("update-project-id").value;
        const projectTitle = projects.find(p=>p.id===projectId)?.title || projectId;
        const manager = document.getElementById("update-manager").value;
        const message = document.getElementById("update-message").value;
        const feedback = document.getElementById("update-feedback");

        if(!message || !projectId){
          feedback.className="mt-4 text-sm text-red-600";
          feedback.textContent="請填寫完整的更新訊息。"; return;
        }
        if(!isAuthorized()){
          feedback.className="mt-4 text-sm text-red-600";
          feedback.textContent="初始化未完成，請稍後再試。"; return;
        }
        try{
          const ref = await addDoc(collection(db, TASKS_COLLECTION_PATH), {
            projectId, taskName:`即時更新: ${message.substring(0,30)}...`,
            description: message, assignee: manager,
            dueDate: new Date().toISOString().split("T")[0],
            status:"更新", createdAt: serverTimestamp(), reporterId: currentUserId
          });
          sendTeamsNotification(`[專案更新] ${projectTitle}`, `**回報人:** ${manager}\n\n**專案:** ${projectTitle} (${projectId})\n\n**訊息:** ${message}`, "ea580c");
          feedback.className="mt-4 text-sm text-secondary-green";
          feedback.textContent=`成功提交更新 (ID: ${ref.id})。`;
          document.getElementById("integration-form").reset();
        }catch(err){
          console.error(err);
          feedback.className="mt-4 text-sm text-red-600";
          feedback.textContent="提交更新失敗：資料庫錯誤。";
        }
      });
    }

    // 新增/編輯專案
    function renderProjectCreation(){
      const c = document.getElementById("main-content");

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="folder-plus" class="w-7 h-7 mr-3 text-primary-blue"></i> 新增/編輯專案資料
        </h2>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增專案</h3>
          <form id="new-project-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">專案編號（唯一）</label>
              <input type="text" id="proj-id" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="例如 P-2025-001"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">專案名稱</label>
              <input type="text" id="proj-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">專案管理人</label>
              <select id="proj-manager" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${projectManagers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("")}
              </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">人事費 (NTD)</label>
                <input type="number" id="proj-personnel" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">業務費 (NTD)</label>
                <input type="number" id="proj-operating" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">設備費 (NTD)</label>
                <input type="number" id="proj-equipment" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">預算概算 (自動合計)</label>
              <input type="number" id="proj-budget" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border bg-gray-100" readonly/>
              <p class="text-xs text-gray-500 mt-1">預算概算 = 人事費 + 業務費 + 設備費</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">初始進度 (%)</label>
                <input type="number" id="proj-progress" min="0" max="100" value="0" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">初始狀態描述</label>
                <input type="text" id="proj-status" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
            </div>

            <button type="submit" class="w-full py-2 bg-secondary-green text-white rounded-lg hover:bg-green-700">儲存新專案</button>
          </form>
          <div id="project-form-feedback" class="mt-4 text-sm font-medium"></div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">已建立專案清單</h3>
          <div id="existing-projects-list" class="space-y-3">
            ${
              projects.length>0
                ? projects.map(p=>{
                    const isOwner = (p.reporterId||"") === currentUserId;
                    return `
                      <div class="flex justify-between items-center p-3 border-b hover:bg-gray-50 rounded-lg">
                        <div>
                          <p class="font-medium text-primary-blue cursor-pointer" onclick="setView('details','${escapeHtml(p.id)}')">${escapeHtml(p.title)}</p>
                          <p class="text-xs text-gray-500">${escapeHtml(p.id)} | 負責人: ${escapeHtml(p.manager||"")} ${isOwner?'<span class="text-xs font-semibold text-accent-orange ml-2">(我的專案)</span>':''}</p>
                        </div>
                        <div>
                          ${
                            isOwner
                              ? `<button onclick="deleteProject('${escapeHtml(p.id)}')" class="text-red-500 hover:text-red-700 text-sm ml-4"><i data-lucide="trash-2" class="w-4 h-4 inline"></i> 刪除</button>`
                              : `<span class="text-xs text-gray-400">非創建者不可刪除</span>`
                          }
                        </div>
                      </div>`;
                  }).join("")
                : '<p class="text-gray-500 text-center py-4">目前沒有任何專案資料。</p>'
            }
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      // 預算合計
      const inputs = ["proj-personnel","proj-operating","proj-equipment"].map(id=>document.getElementById(id));
      const totalEl = document.getElementById("proj-budget");
      const recalc = ()=>{ totalEl.value = inputs.map(el=>Number(el.value)||0).reduce((a,b)=>a+b,0); };
      inputs.forEach(el=>el?.addEventListener("input", recalc));
      recalc();

      document.getElementById("new-project-form")?.addEventListener("submit", handleNewProjectSubmission);
    }

    function isValidProjectId(id){ return /^[A-Za-z0-9_-]{3,64}$/.test(id||""); }

    async function handleNewProjectSubmission(e){
      e.preventDefault();
      const feedback = document.getElementById("project-form-feedback");
      if(!isAuthorized()){ showModal("初始化中","請稍後再試。"); return; }

      const projectId = document.getElementById("proj-id").value.trim();
      const title = document.getElementById("proj-title").value.trim();
      const manager = document.getElementById("proj-manager").value;
      const personnelBudget = Number(document.getElementById("proj-personnel").value)||0;
      const operatingBudget = Number(document.getElementById("proj-operating").value)||0;
      const equipmentBudget = Number(document.getElementById("proj-equipment").value)||0;
      const budget = Number(document.getElementById("proj-budget").value)||0;
      const progress = parseInt(document.getElementById("proj-progress").value)||0;
      const status = document.getElementById("proj-status").value.trim();

      if(!isValidProjectId(projectId)){
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent="格式錯誤：專案編號僅能包含英數字、底線、連字號，長度 3–64。"; return;
      }
      if(projects.some(p=>p.id===projectId)){
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent=`錯誤：專案編號 ${projectId} 已存在！`; return;
      }

      try{
        await setDoc(doc(db, PROJECTS_COLLECTION_PATH, projectId), {
          id: projectId, title, manager,
          budget, personnelBudget, operatingBudget, equipmentBudget,
          progress, status, proposer: manager, manpower: 0, type:"手動輸入",
          createdAt: serverTimestamp(), reporterId: currentUserId
        });

        sendTeamsNotification(
          `[新專案建立] ${title}`,
          `**專案編號:** ${projectId}\n\n**專案管理人:** ${manager}\n\n**預算：**$${budget.toLocaleString()}（人事${personnelBudget.toLocaleString()} / 業務${operatingBudget.toLocaleString()} / 設備${equipmentBudget.toLocaleString()}）`,
          "059669"
        );

        feedback.className="mt-4 text-sm text-secondary-green";
        feedback.textContent="專案新增成功！列表已即時更新。";
        document.getElementById("new-project-form").reset();
        document.getElementById("proj-budget").value = 0;
      }catch(err){
        console.error(err);
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent=`專案新增失敗：${err.message}`;
      }
    }

    async function deleteProject(projectId){
      const project = projects.find(p=>p.id===projectId);
      if(!project || project.reporterId!==currentUserId){
        showModal("權限限制","僅創建者可刪除此專案。"); return;
      }
      try{
        await deleteDoc(doc(db, PROJECTS_COLLECTION_PATH, projectId));
        sendTeamsNotification(`[專案已刪除] ${project?.title||projectId}`, `專案 ${projectId} 已由使用者 ${currentUserId} 刪除。`, "DC2626");
        showModal("刪除成功", `專案 ${projectId} 已被移除。`);
      }catch(err){
        console.error(err); showModal("錯誤", `刪除專案失敗：${err.message}`);
      }
    }
    window.deleteProject = deleteProject;

    // 專案詳情（含空狀態與選擇器）
    function renderProjectDetails(projectId){
      const container = document.getElementById("main-content");

      if(!projects || projects.length===0){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
            <p class="text-gray-700 mb-4">目前沒有任何專案資料。</p>
            <button onclick="setView('creation')" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">新增第一個專案</button>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        return;
      }

      if(!projectId){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-gray-700 mb-4">請選擇要查看的專案：</p>
            <div class="flex items-center gap-3">
              <select id="details-project-select" class="rounded-md border-gray-300 p-2 border flex-1">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("")}
              </select>
              <button id="details-go-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">查看詳情</button>
            </div>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        document.getElementById('details-go-btn')?.addEventListener('click',()=>{
          const sel = document.getElementById('details-project-select'); const val = sel?.value || null;
          if(val) setView('details', val);
        });
        return;
      }

      const project = projects.find(p=>p.id===projectId);
      if(!project){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-red-600 mb-4">找不到專案「${escapeHtml(String(projectId))}」。請重新選擇：</p>
            <div class="flex items-center gap-3">
              <select id="details-project-select" class="rounded-md border-gray-300 p-2 border flex-1">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("")}
              </select>
              <button id="details-go-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">查看詳情</button>
            </div>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        document.getElementById('details-go-btn')?.addEventListener('click',()=>{
          const sel = document.getElementById('details-project-select'); const val = sel?.value || null;
          if(val) setView('details', val);
        });
        return;
      }

      const projectTasks = tasks.filter(t=>t.projectId===projectId);
      const progress = Number(project.progress)||0;
      const barColor = progress>=95 ? "bg-secondary-green" : (progress<50?"bg-accent-orange":"bg-primary-blue");

      container.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i>
          專案詳情: ${escapeHtml(project.title)}
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-3">
            <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">基本資訊</h3>
            <p class="text-sm"><strong class="text-gray-600">專案編號:</strong> ${escapeHtml(project.id)}</p>
            <p class="text-sm"><strong class="text-gray-600">專案管理人:</strong> <span class="text-lg font-bold text-secondary-green">${escapeHtml(project.manager||"")}</span></p>
            <p class="text-sm"><strong class="text-gray-600">預算概算:</strong> $${(Number(project.budget)||0).toLocaleString()}</p>
            <div class="text-sm text-gray-700 pl-1">
              <p>・人事費：$${(Number(project.personnelBudget)||0).toLocaleString()}</p>
              <p>・業務費：$${(Number(project.operatingBudget)||0).toLocaleString()}</p>
              <p>・設備費：$${(Number(project.equipmentBudget)||0).toLocaleString()}</p>
            </div>
            <p class="text-sm"><strong class="text-gray-600">人力需求:</strong> ${Number(project.manpower)||0} 位</p>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">流程進度與相關文件</h3>
            <div class="flex items-center space-x-4 mb-4">
              <span class="text-gray-600 font-medium">總進度:</span>
              <div class="flex-grow bg-gray-200 rounded-full h-4">
                <div class="progress-bar h-4 rounded-full ${barColor}" style="width:${progress}%"></div>
              </div>
              <span class="font-bold text-lg ${progress>=95?'text-secondary-green':'text-primary-blue'}">${progress}%</span>
            </div>

            <div class="space-y-2 mt-6">
              <h4 class="text-md font-semibold text-gray-700">任務與流程狀態</h4>
              <p class="text-sm text-gray-600">目前狀態: <span class="font-medium text-lg text-red-500">${escapeHtml(project.status||"")}</span></p>

              <h4 class="text-md font-semibold text-gray-700 mt-4">相關文件 (模擬)</h4>
              <ul class="list-disc list-inside text-sm text-primary-blue space-y-1 ml-4">
                <li><a href="#" class="hover:underline">專案文件 (${escapeHtml(project.id)}).docx (模擬文件)</a></li>
                <li><a href="#" class="hover:underline">階段性報告 v1.pdf (模擬文件)</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-primary-blue"></i>
            專案任務列表
          </h3>
          <div id="project-tasks-list">
            ${
              projectTasks.length>0
                ? projectTasks.map(t=>`
                  <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                    <div class="flex-grow">
                      <p class="font-medium text-gray-800">${escapeHtml(t.taskName||"")}</p>
                      <p class="text-xs text-gray-500">負責人: ${escapeHtml(t.assignee||"")} | 期限: ${escapeHtml(t.dueDate||"")}</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${
                      t.status==='完成' ? 'bg-secondary-green/20 text-secondary-green' :
                      t.status==='進行中' ? 'bg-yellow-100 text-yellow-800' :
                      t.status==='更新' ? 'bg-blue-100 text-blue-800' :
                      'bg-red-100 text-red-800'
                    }">${escapeHtml(t.status||"")}</span>
                  </div>
                `).join('')
                : '<p class="text-gray-500 text-center py-4">此專案目前沒有建立的任務。</p>'
            }
          </div>
          <div class="flex items-center justify-between mt-4">
            <button onclick="setView('tasks')" class="text-sm text-primary-blue hover:underline flex items-center">
              前往任務管理頁面新增任務 <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
            </button>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600">切換專案：</label>
              <select id="details-switch-select" class="rounded-md border-gray-300 p-2 border">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}" ${p.id===projectId?'selected':''}>${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join('')}
              </select>
              <button id="details-switch-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">查看</button>
            </div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById('details-switch-btn')?.addEventListener('click', ()=>{
        const sel = document.getElementById('details-switch-select'); const val = sel?.value || null;
        if(val) setView('details', val);
      });
    }

    // 任務管理
    function renderTaskManagement(){
      const c = document.getElementById("main-content");

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-primary-blue"></i> 任務管理中心
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">分配新任務</h3>
            <form id="new-task-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">所屬專案</label>
                <select id="task-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>' }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">任務名稱</label>
                <input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">分配給</label>
                <select id="task-assignee" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projectManagers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("") }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">截止日期</label>
                <input type="date" id="task-due-date" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-800">分配任務</button>
            </form>
            <div id="task-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">所有任務追蹤</h3>

            <div class="flex space-x-3 mb-4 text-sm">
              <select id="task-filter-manager" class="rounded-md border-gray-300 p-2 border">
                <option value="">所有負責人</option>
                ${ projectManagers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("") }
              </select>
              <select id="task-filter-status" class="rounded-md border-gray-300 p-2 border">
                <option value="">所有狀態</option>
                <option value="待辦">待辦</option>
                <option value="進行中">進行中</option>
                <option value="完成">完成</option>
                <option value="更新">即時更新</option>
              </select>
              <button onclick="renderTaskList()" class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">過濾</button>
            </div>

            <div id="current-tasks-list" class="space-y-2"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("new-task-form")?.addEventListener("submit", handleNewTaskSubmission);
      renderTaskList();
    }

    async function handleNewTaskSubmission(e){
      e.preventDefault();
      const feedback = document.getElementById("task-form-feedback");
      if(!isAuthorized()){ showModal("初始化中","請稍後再試。"); return; }

      const projectId = document.getElementById("task-project-id").value;
      const projectTitle = projects.find(p=>p.id===projectId)?.title || projectId;
      const taskName = document.getElementById("task-name").value;
      const assignee = document.getElementById("task-assignee").value;
      const dueDate = document.getElementById("task-due-date").value;

      if(!projectId){
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent="請先選擇專案。"; return;
      }
      try{
        await addDoc(collection(db, TASKS_COLLECTION_PATH), {
          projectId, taskName, assignee, dueDate, status:"待辦",
          createdAt: serverTimestamp(), reporterId: currentUserId
        });

        sendTeamsNotification(
          `[新任務分配] ${taskName}`,
          `**專案:** ${projectTitle} (${projectId})\n\n**負責人:** ${assignee}\n\n**截止日期:** ${dueDate}\n\n**狀態:** 待辦`,
          "1e40af"
        );

        feedback.className="mt-4 text-sm text-secondary-green";
        feedback.textContent="任務分配成功！";
        document.getElementById("new-task-form").reset();
      }catch(err){
        console.error(err);
        feedback.className="mt-4 text-sm text-red-600";
        feedback.textContent="任務分配失敗：資料庫錯誤。";
      }
    }

    function renderTaskList(){
      const list = document.getElementById("current-tasks-list"); if(!list) return;

      const fm = document.getElementById("task-filter-manager")?.value || "";
      const fs = document.getElementById("task-filter-status")?.value || "";

      const data = tasks
        .filter(t => (!fm || t.assignee===fm) && (!fs || t.status===fs))
        .sort((a,b)=> (a.status==="待辦" && b.status!=="待辦")?-1 : (a.status!=="待辦" && b.status==="待辦")?1 : (new Date(a.dueDate)-new Date(b.dueDate)));

      if(data.length===0){
        list.innerHTML = '<p class="text-gray-500 text-center py-8">沒有符合過濾條件的任務。</p>';
        return;
      }

      list.innerHTML = data.map(t=>{
        const project = projects.find(p=>p.id===t.projectId);
        let badge="bg-gray-100 text-gray-700", actionText="標記完成", actionFn=`updateTaskStatus('${escapeHtml(t.id)}','完成')`;
        if(t.status==="待辦"){ badge="bg-red-100 text-red-800"; actionText="開始進行"; actionFn=`updateTaskStatus('${escapeHtml(t.id)}','進行中')`; }
        else if(t.status==="進行中"){ badge="bg-yellow-100 text-yellow-800"; }
        else if(t.status==="完成"){ badge="bg-secondary-green/20 text-secondary-green"; actionText="已完成"; actionFn=`showModal('已完成','此任務已標記完成，無法再操作。')`; }
        else if(t.status==="更新"){ badge="bg-blue-100 text-blue-800"; actionText="查看詳情"; actionFn=`setView('details','${escapeHtml(t.projectId)}')`; }

        return `
          <div class="project-card bg-gray-50 p-4 rounded-lg border-l-4 ${ t.status==="待辦"?"border-red-500": t.status==="進行中"?"border-yellow-500": t.status==="完成"?"border-green-500":"border-blue-500"}">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <p class="font-bold text-lg text-gray-900">${escapeHtml(t.taskName||"")}</p>
                <p class="text-xs text-gray-500">專案: <span class="font-medium text-primary-blue cursor-pointer hover:underline" onclick="setView('details','${escapeHtml(t.projectId)}')">${escapeHtml(project?.title||t.projectId)}</span></p>
              </div>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${badge}">${escapeHtml(t.status||"")}</span>
            </div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between items-center">
              <p><i data-lucide="user" class="w-4 h-4 inline mr-1"></i> 負責人: <span class="font-medium">${escapeHtml(t.assignee||"")}</span>
                 <span class="ml-4"><i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> 期限: ${escapeHtml(t.dueDate||"")}</span></p>
              <button onclick="${actionFn}" class="px-3 py-1 text-xs rounded-lg text-white ${ t.status!=="更新" ? "bg-secondary-green hover:bg-green-700" : "bg-blue-600 hover:bg-blue-700"}">${actionText}</button>
            </div>
          </div>`;
      }).join("");

      if(window.lucide?.createIcons) lucide.createIcons();
    }

    async function updateTaskStatus(taskId, newStatus){
      if(!isAuthorized()){ showModal("初始化中","請稍後再試。"); return; }
      try{
        await updateDoc(doc(db, TASKS_COLLECTION_PATH, taskId), { status:newStatus, updatedAt: serverTimestamp() });
        const task = tasks.find(t=>t.id===taskId);
        const projectTitle = projects.find(p=>p.id===task?.projectId)?.title || task?.projectId;

        if(task){
          let color="f97316"; if(newStatus==="完成") color="059669"; if(newStatus==="進行中") color="eab308";
          sendTeamsNotification(
            `[任務狀態更新] ${task.taskName}`,
            `**專案:** ${projectTitle}\n\n**任務:** ${task.taskName}\n\n**負責人:** ${task.assignee}\n\n**新狀態:** **${newStatus}**`,
            color
          );
        }
      }catch(err){
        console.error(err);
        showModal("錯誤", `更新任務狀態失敗：${err.message}`);
      }
    }
    window.updateTaskStatus = updateTaskStatus;

    // 行事曆
    function buildCalendarEventsForFC(){
      return events.map(ev=>{
        const start=ev.startDate, end=(ev.endDate && ev.endDate!==ev.startDate)?ev.endDate:ev.startDate;
        return { id:ev.id, title:`${ev.title||""} (${ev.assignee||""})`, start, end, allDay:true,
                 extendedProps:{ projectId: ev.projectId, assignee: ev.assignee, description: ev.description||"" } };
      });
    }

    function renderCalendar(){
      const c = document.getElementById("main-content");

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="calendar" class="w-7 h-7 mr-3 text-primary-blue"></i> 行事曆
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg">
            <div id="calendar"></div>
          </div>

          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增行事</h3>
            <form id="new-event-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">所屬專案</label>
                <select id="evt-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>' }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">標題</label>
                <input type="text" id="evt-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">參與者/負責人</label>
                <select id="evt-assignee" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projectManagers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("") }
                </select>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">開始日期</label>
                  <input type="date" id="evt-start" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">結束日期</label>
                  <input type="date" id="evt-end" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">說明（可選）</label>
                <textarea id="evt-desc" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="補充說明"></textarea>
              </div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-800">新增行事</button>
            </form>
            <div id="event-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const calEl = document.getElementById("calendar");
      if(calEl && window.FullCalendar){
        if(calendarInstance) { calendarInstance.destroy(); calendarInstance=null; }
        calendarInstance = new FullCalendar.Calendar(calEl, {
          locale:"zh-tw",
          initialView:"dayGridMonth",
          height:700,
          headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek" },
          events: buildCalendarEventsForFC(),
          dateClick:(info)=>{ const s=document.getElementById("evt-start"); const e=document.getElementById("evt-end"); if(s) s.value=info.dateStr; if(e) e.value=info.dateStr; },
          eventClick:(info)=>{ 
            const ev=info.event; 
            const pId = ev.extendedProps?.projectId||""; 
            const desc=ev.extendedProps?.description||""; 
            showModal(ev.title||"行事", `專案：${pId}\n日期：${ev.startStr}${ev.endStr?(' - '+ev.endStr):''}\n說明：${desc}`);
          }
        });
        calendarInstance.render();
      }

      document.getElementById("new-event-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback = document.getElementById("event-form-feedback");
        if(!isAuthorized()){ showModal("初始化中","請稍後再試。"); return; }

        const projectId = document.getElementById("evt-project-id").value;
        const title = document.getElementById("evt-title").value;
        const assignee = document.getElementById("evt-assignee").value;
        const startDate = document.getElementById("evt-start").value;
        const endDate = document.getElementById("evt-end").value;
        const description = document.getElementById("evt-desc").value || "";

        if(!projectId || !title || !startDate || !endDate){
          feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請完整填寫表單。"; return;
        }

        try{
          await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
            projectId, title, assignee, startDate, endDate, description,
            createdAt: serverTimestamp(), reporterId: currentUserId
          });
          feedback.className="mt-4 text-sm text-secondary-green";
          feedback.textContent="新增行事成功！";
          document.getElementById("new-event-form").reset();

          const pTitle = projects.find(p=>p.id===projectId)?.title || projectId;
          sendTeamsNotification(
            `[行事新增] ${title}`,
            `**專案:** ${pTitle} (${projectId})\n\n**負責人:** ${assignee}\n\n**期間:** ${startDate} ~ ${endDate}`,
            "1e40af"
          );

          // 即時重繪行事曆
          if(calendarInstance){
            calendarInstance.removeAllEvents();
            calendarInstance.addEventSource(buildCalendarEventsForFC());
          }
        }catch(err){
          console.error(err);
          feedback.className="mt-4 text-sm text-red-600";
          feedback.textContent="新增行事失敗：資料庫錯誤。";
        }
      });
    }

    // 簡易報告與下載
    function downloadBlob(filename, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
    }

    function renderReport(){
      const c = document.getElementById("main-content");
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="file-text" class="w-7 h-7 mr-3 text-primary-blue"></i> 報告與下載
        </h2>

        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
          <p class="text-gray-700">可匯出目前前端快取的資料為 JSON（僅示範用途）。</p>
          <div class="flex gap-3">
            <button id="dl-projects" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">下載專案 JSON</button>
            <button id="dl-tasks" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">下載任務 JSON</button>
            <button id="dl-events" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">下載行事 JSON</button>
          </div>
          <p class="text-xs text-gray-500">實務導出可改為後端產生 CSV/PDF。</p>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();
      document.getElementById("dl-projects")?.addEventListener("click", ()=>downloadBlob(`projects-${APP_ID}.json`, JSON.stringify(projects, null, 2)));
      document.getElementById("dl-tasks")?.addEventListener("click", ()=>downloadBlob(`tasks-${APP_ID}.json`, JSON.stringify(tasks, null, 2)));
      document.getElementById("dl-events")?.addEventListener("click", ()=>downloadBlob(`events-${APP_ID}.json`, JSON.stringify(events, null, 2)));
    }

    // 系統設定
    function renderSettings(){
      const c = document.getElementById("main-content");
      const cfg = firebaseConfig || {};
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="settings" class="w-7 h-7 mr-3 text-primary-blue"></i> 系統設定
        </h2>

        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 class="text-lg font-semibold text-primary-blue mb-2">連線狀態</h3>
              <p class="text-sm">授權狀態：<span class="${isAuthorized()?'text-green-600':'text-red-600'} font-semibold">${isAuthorized()?'已授權 (匿名)':'未授權'}</span></p>
              <p class="text-sm">使用者 UID：<span class="font-mono">${escapeHtml(currentUserId||'')}</span></p>
              <p class="text-sm">APP_ID：<span class="font-mono">${escapeHtml(APP_ID)}</span></p>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-primary-blue mb-2">Firebase 設定摘要</h3>
              <ul class="text-sm text-gray-700 space-y-1">
                <li>projectId：<span class="font-mono">${escapeHtml(cfg.projectId||'')}</span></li>
                <li>authDomain：<span class="font-mono">${escapeHtml(cfg.authDomain||'')}</span></li>
                <li>storageBucket：<span class="font-mono">${escapeHtml(cfg.storageBucket||'')}</span></li>
                <li>messagingSenderId：<span class="font-mono">${escapeHtml(cfg.messagingSenderId||'')}</span></li>
                <li>appId：<span class="font-mono">${escapeHtml(cfg.appId||'')}</span></li>
              </ul>
            </div>
          </div>
          <div class="pt-2">
            <button id="btn-reinit" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">重新初始化</button>
            <button id="btn-goto-dashboard" class="ml-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">回到儀表板</button>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();
      document.getElementById("btn-reinit")?.addEventListener("click", ()=>initFirebase());
      document.getElementById("btn-goto-dashboard")?.addEventListener("click", ()=>setView('dashboard'));
    }

    // 啟動流程
    function initializeSystem(authOk){
      setView('dashboard');
      if(authOk) startRealtimeListeners();
    }

    // DOM 準備完成後初始化
    window.addEventListener('DOMContentLoaded', ()=>{
      if(window.lucide?.createIcons) lucide.createIcons();
      initFirebase();
    });
  </script>
</body>
</html>
