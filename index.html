<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://firebasestorage.googleapis.com
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src 'self';
                 object-src 'none';
                 base-uri 'self';">

  <!-- UI 套件 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- 專案設定 -->
  <script>
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    // 若只允許預先建立帳號，改為 false 會隱藏註冊按鈕
    window.__ALLOW_SIGNUP = true;

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "Noto Sans TC", "sans-serif"] },
          colors: { "primary-blue":"#1e40af", "secondary-green":"#059669", "accent-orange":"#ea580c" }
        }
      }
    }
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar { overflow: hidden; }
    #app-sidebar.expanded { width: 240px !important; }
    #app-sidebar.collapsed { width: 72px !important; }
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition: background-color .15s, color .15s}
    #app-sidebar .nav-item:hover{ background-color: rgba(255,255,255,.08); color:#fff; }
    #app-sidebar .nav-item.active{ background-color: rgba(59,130,246,.18); color:#fff; }
    #app-sidebar .nav-icon{ width:22px; height:22px; stroke-width:2.2; }
    #app-sidebar svg{ stroke: currentColor; }
    #app-sidebar .nav-label{ display:inline; white-space:nowrap; font-weight:600; font-size:.875rem; }
    #app-sidebar.collapsed .nav-label{ display:none; }
    #app-main{ transition: margin-left .2s ease; }
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:70}
    .modal-card{background:#fff;border-radius:14px;max-width:28rem;width:calc(100vw - 24px);padding:16px}
  </style>
</head>
<body class="bg-gray-50 font-sans flex min-h-screen">

  <!-- 側欄 -->
  <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
    <div class="w-full">
      <div class="flex items-center justify-between px-3 mb-2">
        <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
        <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
          <i data-lucide="panel-left-close" class="nav-icon"></i>
        </button>
      </div>
      <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
        <button class="nav-item group" data-view="dashboard" title="Home" onclick="setView('dashboard')">
          <i data-lucide="house" class="nav-icon"></i><span class="nav-label">Home</span>
        </button>
        <button class="nav-item group" data-view="tasks" title="Planner" onclick="setView('tasks')">
          <i data-lucide="calendar-days" class="nav-icon"></i><span class="nav-label">Planner</span>
        </button>
        <button class="nav-item group" data-view="calendar" title="行事曆" onclick="setView('calendar')">
          <i data-lucide="calendar" class="nav-icon"></i><span class="nav-label">行事曆</span>
        </button>
        <button class="nav-item group" data-view="report" title="Brain" onclick="setView('report')">
          <i data-lucide="brain" class="nav-icon"></i><span class="nav-label">Brain</span>
        </button>
        <button class="nav-item group" data-view="community" title="資訊交流" onclick="setView('community')">
          <i data-lucide="messages-square" class="nav-icon"></i><span class="nav-label">資訊交流</span>
        </button>
        <button class="nav-item group" data-view="details" title="專案詳情" onclick="setView('details')">
          <i data-lucide="layout-dashboard" class="nav-icon"></i><span class="nav-label">專案詳情</span>
        </button>
      </nav>
    </div>

    <div class="w-full flex flex-col items-stretch space-y-1 px-1">
      <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1 hidden">
        <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
          <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
          <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm"></div>
        </div>
        <div class="min-w-0">
          <div id="user-display-name" class="text-sm font-semibold truncate"></div>
          <div id="user-email" class="text-xs opacity-80 truncate"></div>
        </div>
      </div>

      <button id="btn-signin" class="nav-item group" title="Email 登入" onclick="openAuthModal()">
        <i data-lucide="log-in" class="nav-icon"></i><span class="nav-label">登入</span>
      </button>
      <button id="btn-signout" class="nav-item group hidden" title="登出" onclick="appSignOut()">
        <i data-lucide="log-out" class="nav-icon"></i><span class="nav-label">登出</span>
      </button>
    </div>
  </aside>

  <!-- 主內容 -->
  <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
    <div id="main-content" class="w-full"></div>
  </main>

  <!-- 一般提示 Modal -->
  <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-blue">提示</h3>
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end space-x-3">
        <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">確認</button>
      </div>
    </div>
  </div>

  <!-- Email/Password 登入 Modal -->
  <div id="auth-modal" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold">Email 登入</div>
        <button class="px-2 py-1 bg-gray-100 rounded" onclick="closeAuthModal()">關閉</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm text-gray-600">Email</label>
          <input id="auth-email" type="email" class="w-full border rounded-lg p-2" placeholder="you@example.com">
        </div>
        <div>
          <label class="text-sm text-gray-600">密碼</label>
          <input id="auth-pass" type="password" class="w-full border rounded-lg p-2" placeholder="至少 6 碼">
        </div>
        <div id="auth-msg" class="text-sm h-5"></div>
        <div class="flex flex-wrap gap-2">
          <button class="btn-primary px-3 py-2 rounded bg-primary-blue text-white" onclick="handleEmailSignIn()">登入</button>
          <button id="btn-auth-signup" class="btn px-3 py-2 rounded bg-gray-100" onclick="handleEmailSignUp()">註冊</button>
          <button class="btn px-3 py-2 rounded bg-gray-100" onclick="handlePasswordReset()">忘記密碼</button>
        </div>
      </div>
    </div>
  </div>

  <!-- App 腳本 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // 全域狀態
    let db, auth, storage;
    let currentUserId = "";
    let isAuthReady = false;
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;
    const APP_CHECK_SITE_KEY = window.__app_check_site_key || "";
    const ALLOW_SIGNUP = window.__ALLOW_SIGNUP !== false;

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;

    const DEFAULT_MANAGERS = ["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];
    let managers = [];
    let currentView = "dashboard";
    let projects = [];
    let tasks = [];
    let events = [];
    let files = [];
    let communityPosts = [];
    let budgetCaps = { personnelCap: 0, operatingCap: 0, equipmentCap: 0 };
    let selectedProjectId = null;
    let calendarInstance = null;

    // 工具
    function escapeHtml(str){ if(str==null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function showModal(title, message){
      const t=document.getElementById("modal-title"), m=document.getElementById("modal-message"), modal=document.getElementById("custom-modal"), w=document.getElementById("modal-content-wrapper");
      t.textContent=title||"提示"; m.textContent=message||""; document.getElementById("modal-confirm-btn").onclick=()=>{w.classList.remove("scale-100","opacity-100");w.classList.add("scale-95","opacity-0");setTimeout(()=>modal.classList.add("hidden"),300);};
      modal.classList.remove("hidden"); modal.classList.add("flex"); setTimeout(()=>{w.classList.remove("scale-95","opacity-0"); w.classList.add("scale-100","opacity-100");},50);
    }
    function n(v){ return Number(v)||0; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function managerOptionsHtml(selected = ""){
      const list = (managers.length>0 ? managers.map(m=>m.name).filter(Boolean) : DEFAULT_MANAGERS);
      return list.map(m => `<option value="${escapeHtml(m)}" ${m===selected?'selected':''}>${escapeHtml(m)}</option>`).join("");
    }
    function tsToDateStr(v){
      try{ if(!v) return ""; if(typeof v==="string") return v.slice(0,10); if(v?.toDate) return v.toDate().toISOString().slice(0,10); if(v instanceof Date) return v.toISOString().slice(0,10); return ""; }catch{ return ""; }
    }
    function overlapsRange(start, end, s, e){
      if(!start && !end) return false; const aStart=start||end; const aEnd=end||start; const bStart=s||e; const bEnd=e||s;
      if(!bStart && !bEnd) return true; if(!aStart||!aEnd||!bStart||!bEnd) return false; return (aStart<=bEnd)&&(bStart<=aEnd);
    }
    function inRange(d, s, e){ if(!d) return false; if(s && d < s) return false; if(e && d > e) return false; return true; }
    function arrayToCsv(headers, rows){
      const esc = (val)=>{ const s = (val===undefined || val===null) ? "" : String(val); const needQuote = /[",\r\n]/.test(s); const q = s.replace(/"/g, '""'); return needQuote ? `"${q}"` : q; };
      const head = headers.map(esc).join(","); const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\r\n"); return head + "\r\n" + body;
    }
    function triggerDownloadCsv(csvText, filename){
      const blob = new Blob(["\ufeff" + csvText], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function isAuthorized(){ return !!(isAuthReady && currentUserId); }

    // Email 登入 Modal 控制
    window.openAuthModal = function(){
      const allow = (window.__ALLOW_SIGNUP !== false);
      document.getElementById('auth-modal').classList.remove('hidden');
      document.getElementById('btn-auth-signup').classList.toggle('hidden', !allow);
      document.getElementById('auth-msg').textContent='';
      document.getElementById('auth-email').focus();
    };
    window.closeAuthModal = function(){ document.getElementById('auth-modal').classList.add('hidden'); };

    function setAuthMsg(text, ok){
      const el=document.getElementById('auth-msg'); el.textContent=text||''; el.className='text-sm ' + (ok?'text-green-600':'text-red-600');
    }
    window.handleEmailSignIn = async function(){
      try{
        const email=(document.getElementById('auth-email').value||'').trim();
        const pass=document.getElementById('auth-pass').value||'';
        if(!email || !pass){ setAuthMsg('請輸入 Email 與密碼', false); return; }
        setAuthMsg('登入中...', true);
        await signInWithEmailAndPassword(auth, email, pass);
        setAuthMsg('登入成功！', true);
        closeAuthModal();
      }catch(e){ setAuthMsg(e?.message||'登入失敗', false); }
    };
    window.handleEmailSignUp = async function(){
      if(!ALLOW_SIGNUP){ return; }
      try{
        const email=(document.getElementById('auth-email').value||'').trim();
        const pass=document.getElementById('auth-pass').value||'';
        if(!email || pass.length<6){ setAuthMsg('請輸入 Email 與至少 6 碼密碼', false); return; }
        setAuthMsg('註冊中...', true);
        await createUserWithEmailAndPassword(auth, email, pass);
        setAuthMsg('註冊成功，已登入！', true);
        closeAuthModal();
      }catch(e){ setAuthMsg(e?.message||'註冊失敗', false); }
    };
    window.handlePasswordReset = async function(){
      try{
        const email=(document.getElementById('auth-email').value||'').trim();
        if(!email){ setAuthMsg('請輸入 Email 再重設密碼', false); return; }
        await sendPasswordResetEmail(auth, email);
        setAuthMsg('已寄出重設密碼信，請查收。', true);
      }catch(e){ setAuthMsg(e?.message||'寄送失敗', false); }
    };

    // Firebase 初始化 + Auth
    async function initFirebase(){
      if(!firebaseConfig) { console.error("缺少 Firebase 設定"); return; }
      const app = initializeApp(firebaseConfig);
      if(APP_CHECK_SITE_KEY){ initializeAppCheck(app, { provider: new ReCaptchaV3Provider(APP_CHECK_SITE_KEY), isTokenAutoRefreshEnabled: true }); }
      db = getFirestore(app);
      auth = getAuth(app);
      storage = getStorage(app);

      onAuthStateChanged(auth, async (user)=>{
        isAuthReady = true;
        if(user){
          currentUserId = user.uid;
          userProfile = { displayName: user.displayName || "", email: user.email || "", photoURL: user.photoURL || "" };
          updateAuthUI(true);
          if(!listenersStarted) initializeSystem(true);
        }else{
          currentUserId = "";
          userProfile = { displayName:"", email:"", photoURL:"" };
          updateAuthUI(false);
          initializeSystem(false);
        }
      });
    }

    function updateAuthUI(loggedIn){
      const btnIn  = document.getElementById("btn-signin");
      const btnOut = document.getElementById("btn-signout");
      const userBox = document.getElementById("user-box");
      const nameEl = document.getElementById("user-display-name");
      const emailEl = document.getElementById("user-email");
      const avatarEl = document.getElementById("user-avatar");
      const initialEl = document.getElementById("user-initial");

      if(btnIn)  btnIn.classList.toggle("hidden", !!loggedIn);
      if(btnOut) btnOut.classList.toggle("hidden", !loggedIn);

      if(userBox){
        userBox.classList.toggle("hidden", !loggedIn);
        if(loggedIn){
          const displayName = userProfile.displayName || userProfile.email?.split("@")[0] || "使用者";
          const email = userProfile.email || "";
          if(nameEl) nameEl.textContent = displayName;
          if(emailEl) emailEl.textContent = email;
          if(userProfile.photoURL){
            avatarEl?.setAttribute("src", userProfile.photoURL);
            avatarEl?.classList.remove("hidden");
            initialEl?.classList.add("hidden");
          }else{
            if(avatarEl){ avatarEl.removeAttribute("src"); avatarEl.classList.add("hidden"); }
            if(initialEl){
              const init = (displayName || "U").trim()[0]?.toUpperCase() || "U";
              initialEl.textContent = init;
              initialEl.classList.remove("hidden");
            }
          }
        }
      }
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); }
      catch(e){ console.error(e); showModal("登出失敗", e?.message || String(e)); }
    };

    // 系統初始化與監聽
    function initializeSystem(withData){
      if(currentView!=="dashboard") currentView = "dashboard";
      renderDashboard(true);
      if(withData) startRealtimeListeners();
    }
    function startRealtimeListeners(){
      if(!db || listenersStarted) return; listenersStarted = true;
      onSnapshot(query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{ projects = snap.docs.map(d=>({id:d.id, ...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{ tasks = snap.docs.map(d=>({id:d.id, ...d.data()})); rerenderByView(); });
      onSnapshot(query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")), (snap)=>{ events = snap.docs.map(d=>({id:d.id, ...d.data()})); if(currentView==="calendar") renderCalendar(); });
      onSnapshot(query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")), (snap)=>{ files = snap.docs.map(d=>({id:d.id, ...d.data()})); if(currentView==="details") renderProjectDetails(selectedProjectId); });
      onSnapshot(doc(db, SETTINGS_DOC_PATH), (snap)=>{ if(snap.exists()){ const d=snap.data()||{}; budgetCaps = { personnelCap:n(d.personnelCap), operatingCap:n(d.operatingCap), equipmentCap:n(d.equipmentCap) }; } else { budgetCaps = { personnelCap:0, operatingCap:0, equipmentCap:0 }; } if(currentView==="dashboard") renderDashboard(); });
      onSnapshot(query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")), (snap)=>{ managers = snap.docs.map(d=>({ id:d.id, ...d.data() })); rerenderByView(); });
      onSnapshot(query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")), (snap)=>{ communityPosts = snap.docs.map(d=>({ id:d.id, ...d.data() })); if(currentView==="community") renderCommunity(); });
    }

    // 視圖切換
    window.setView = function(view, arg){
      currentView = view;
      setActiveByView(view);
      if(view==="dashboard"){ renderDashboard(); }
      else if(view==="creation"){ renderProjectCreation(); }
      else if(view==="details"){ selectedProjectId = (typeof arg === "string" && arg) ? arg : (projects[0]?.id || null); renderProjectDetails(selectedProjectId); }
      else if(view==="tasks"){ renderTaskManagement(); }
      else if(view==="calendar"){ renderCalendar(); }
      else if(view==="report"){ renderReport(); }
      else if(view==="community"){ renderCommunity(); }
    };
    function rerenderByView(){
      if(currentView==="dashboard") renderDashboard();
      if(currentView==="creation") renderProjectCreation();
      if(currentView==="details") renderProjectDetails(selectedProjectId);
      if(currentView==="tasks") renderTaskManagement();
      if(currentView==="calendar") renderCalendar();
      if(currentView==="report") renderReport();
      if(currentView==="community") renderCommunity();
    }
    function setActiveByView(view){
      document.querySelectorAll('#app-sidebar .nav-item').forEach(el=>{ el.classList.toggle('active', el.getAttribute('data-view') === view); });
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    // 儀表板（保留你的版型，列出每個專案）
    function renderDashboard(isBoot=false){
      const c = document.getElementById("main-content"); if(!c) return;
      const notLogged = !currentUserId;

      const totalProjects = projects.length;
      const completed = projects.filter(p => (n(p.progress)) >= 95).length;
      const totalBudget = projects.reduce((s,p)=>s+n(p.budget),0);
      const empty = totalProjects===0;

      let personnelUsed = 0, operatingUsed = 0, equipmentUsed = 0;
      for(const p of projects){
        const pu = ('personnelUsed' in p) ? n(p.personnelUsed) : n(p.personnelBudget);
        const ou = ('operatingUsed' in p) ? n(p.operatingUsed) : n(p.operatingBudget);
        const eu = ('equipmentUsed' in p) ? n(p.equipmentUsed) : n(p.equipmentBudget);
        personnelUsed += pu; operatingUsed += ou; equipmentUsed += eu;
      }
      const pc = n(budgetCaps.personnelCap), oc = n(budgetCaps.operatingCap), ec = n(budgetCaps.equipmentCap);
      const pRate = pc>0 ? clamp01(personnelUsed/pc) : 0;
      const oRate = oc>0 ? clamp01(operatingUsed/oc) : 0;
      const eRate = ec>0 ? clamp01(equipmentUsed/ec) : 0;
      const pRemain = pc - personnelUsed, oRemain = oc - operatingUsed, eRemain = ec - equipmentUsed;
      const barClass = (rate, remain)=> remain>=0 ? (rate>=0.95 ? "bg-yellow-400" : "bg-primary-blue") : "bg-red-500";

      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案儀表板
          ${notLogged ? '<span class="ml-3 text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">請先登入以讀取資料</span>' : ''}
        </h2>

        ${ isBoot && !listenersStarted ? `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-pulse">
            ${[1,2,3].map(()=>`
              <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
                <div class="h-8 bg-gray-200 rounded w-1/2"></div>
              </div>`).join('')}
          </div>
        ` : ''}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between">
              <i data-lucide="layers" class="w-8 h-8 text-primary-blue"></i>
              <span class="text-3xl font-extrabold text-gray-900">${totalProjects}</span>
            </div>
            <p class="text-gray-500 mt-2">總專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-green">
            <div class="flex items-center justify-between">
              <i data-lucide="check-circle" class="w-8 h-8 text-secondary-green"></i>
              <span class="text-3xl font-extrabold text-gray-900">${completed}</span>
            </div>
            <p class="text-gray-500 mt-2">接近完成專案數</p>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-accent-orange">
            <div class="flex items-center justify-between">
              <i data-lucide="wallet" class="w-8 h-8 text-accent-orange"></i>
              <span class="text-xl font-extrabold text-gray-900">${fmtMoney(totalBudget)}</span>
            </div>
            <p class="text-gray-500 mt-2">所有專案的預算概算總計</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費總預算</div><div class="text-sm text-gray-500">${fmtMoney(pc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate, pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(personnelUsed)}</strong>（${(pRate*100).toFixed(0)}%）</span><span>${pRemain>=0 ? `餘額：<strong>${fmtMoney(pRemain)}</strong>` : `超支：<strong class="text-red-600">${fmtMoney(-pRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費總預算</div><div class="text-sm text-gray-500">${fmtMoney(oc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate, oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(operatingUsed)}</strong>（${(oRate*100).toFixed(0)}%）</span><span>${oRemain>=0 ? `餘額：<strong>${fmtMoney(oRemain)}</strong>` : `超支：<strong class="text-red-600">${fmtMoney(-oRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費總預算</div><div class="text-sm text-gray-500">${fmtMoney(ec)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate, eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(equipmentUsed)}</strong>（${(eRate*100).toFixed(0)}%）</span><span>${eRemain>=0 ? `餘額：<strong>${fmtMoney(eRemain)}</strong>` : `超支：<strong class="text-red-600">${fmtMoney(-eRemain)}</strong>`}</span></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">所有專案概覽</h3>
          ${
            empty ? `
            <div class="text-center py-10">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
              <p class="text-lg text-gray-600">${notLogged ? '請先登入以載入專案資料。' : '目前沒有專案資料。'}</p>
              <button onclick="setView('creation')" class="mt-4 px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 新增第一個專案
              </button>
            </div>` : `
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號/名稱</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專案管理人</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">進度</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">即時狀態</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${projects.map(p=>{
                    const prog = n(p.progress);
                    const bar = prog>=95 ? "bg-secondary-green" : (prog<50?"bg-accent-orange":"bg-primary-blue");
                    const badge = prog>=95 ? "bg-secondary-green/10 text-secondary-green" : (prog<50?"bg-accent-orange/10 text-accent-orange":"bg-primary-blue/10 text-primary-blue");
                    return `
                    <tr>
                      <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-blue hover:underline cursor-pointer" onclick="setView('details','${escapeHtml(p.id)}')">
                        <div class="text-xs text-gray-500">${escapeHtml(p.projectCode||p.id)}</div>${escapeHtml(p.title||'(未命名專案)')}
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800">${escapeHtml(p.manager||"")}</td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <div class="w-32 bg-gray-200 rounded-full h-2.5"><div class="progress-bar h-2.5 rounded-full ${bar}" style="width:${prog}%"></div></div>
                        <span class="text-xs text-gray-500 mt-1 inline-block">${prog}%</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badge}">${escapeHtml(p.status||"")}</span>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <button onclick="setView('details','${escapeHtml(p.id)}')" class="text-primary-blue hover:text-blue-700 text-sm">查看詳情</button>
                      </td>
                    </tr>`;}).join("")}
                </tbody>
              </table>
            </div>`}
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i data-lucide="send" class="w-5 h-5 mr-2 text-primary-blue"></i> 即時更新/問題回報
          </h3>
          <form id="integration-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">選擇專案</label>
              <select id="update-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>'}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">負責人</label>
              <select id="update-manager" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                ${ managerOptionsHtml() }
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">更新/問題描述</label>
              <textarea id="update-message" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="請輸入更新內容"></textarea>
            </div>
            <button type="submit" class="w-full py-2 bg-accent-orange text-white rounded-lg hover:bg-orange-700">提交更新</button>
          </form>
          <div id="update-feedback" class="mt-4 text-sm font-medium"></div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("integration-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const projectId = document.getElementById("update-project-id").value;
        const manager = document.getElementById("update-manager").value;
        const message = document.getElementById("update-message").value;
        const feedback = document.getElementById("update-feedback");

        if(!message || !projectId){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請填寫完整的更新訊息。"; return; }
        if(!isAuthorized()){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先登入再提交。"; return; }
        try{
          await addDoc(collection(db, TASKS_COLLECTION_PATH), {
            projectId, taskName:`即時更新: ${message.substring(0,30)}...`, description: message,
            assignee: manager, dueDate: new Date().toISOString().slice(0,10), status:"更新",
            createdAt: serverTimestamp(), reporterId: currentUserId
          });
          feedback.className="mt-4 text-sm text-secondary-green"; feedback.textContent=`成功提交更新。`;
          document.getElementById("integration-form").reset();
        }catch(err){
          console.error(err); feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="提交更新失敗：資料庫錯誤。";
        }
      });
    }

    // 新增/編輯專案：表單頁（包含：計畫編號/名稱/管理者/主持人/人事/設備/業務費）
    function renderProjectCreation(){
      const c = document.getElementById("main-content");
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="folder-plus" class="w-7 h-7 mr-3 text-primary-blue"></i> 新增/編輯專案資料
        </h2>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增專案</h3>
          <form id="new-project-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">專案編號（唯一）</label>
              <input type="text" id="proj-id" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="例如 TP-2025-001"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">專案名稱</label>
              <input type="text" id="proj-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">專案管理者</label>
                <select id="proj-manager" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ managerOptionsHtml() }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">計畫主持人</label>
                <input type="text" id="proj-pi" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="主持人姓名"/>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">人事費 (NTD)</label>
                <input type="number" id="proj-personnel" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">設備費 (NTD)</label>
                <input type="number" id="proj-equipment" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">業務費 (NTD)</label>
                <input type="number" id="proj-operating" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">預算概算 (自動合計)</label>
              <input type="number" id="proj-budget" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2 border bg-gray-100" readonly/>
              <p class="text-xs text-gray-500 mt-1">預算概算 = 人事費 + 設備費 + 業務費</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">初始進度 (%)</label>
                <input type="number" id="proj-progress" min="0" max="100" value="0" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">初始狀態描述</label>
                <input type="text" id="proj-status" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
            </div>

            <button type="submit" class="w-full py-2 bg-secondary-green text-white rounded-lg hover:bg-green-700">儲存新專案</button>
          </form>
          <div id="project-form-feedback" class="mt-4 text-sm font-medium"></div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const inputs = ["proj-personnel","proj-operating","proj-equipment"].map(id=>document.getElementById(id));
      const totalEl = document.getElementById("proj-budget");
      const recalc = ()=>{ totalEl.value = inputs.map(el=>Number(el.value)||0).reduce((a,b)=>a+b,0); };
      inputs.forEach(el=>el?.addEventListener("input", recalc)); recalc();

      document.getElementById("new-project-form")?.addEventListener("submit", handleNewProjectSubmission);
    }

    function isValidProjectId(id){ return /^[A-Za-z0-9_-]{3,64}$/.test(id||""); }
    async function handleNewProjectSubmission(e){
      e.preventDefault();
      const feedback = document.getElementById("project-form-feedback");
      if(!isAuthorized()){ showModal("請先登入","請先登入後再新增專案。"); return; }

      const projectId = document.getElementById("proj-id").value.trim();
      const title = document.getElementById("proj-title").value.trim();
      const manager = document.getElementById("proj-manager").value;
      const pi      = (document.getElementById("proj-pi").value||"").trim();

      const personnelBudget = n(document.getElementById("proj-personnel").value);
      const equipmentBudget = n(document.getElementById("proj-equipment").value);
      const operatingBudget = n(document.getElementById("proj-operating").value);
      const budget = n(document.getElementById("proj-budget").value);
      const progress = Math.max(0, Math.min(100, n(document.getElementById("proj-progress").value)));
      const status = document.getElementById("proj-status").value.trim();

      if(!isValidProjectId(projectId)){
        feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="格式錯誤：專案編號僅能包含英數字、底線、連字號，長度 3–64。"; return;
      }
      if(projects.some(p=>p.id===projectId)){
        feedback.className="mt-4 text-sm text-red-600"; feedback.textContent=`錯誤：專案編號 ${projectId} 已存在！`; return;
      }

      try{
        await setDoc(doc(db, PROJECTS_COLLECTION_PATH, projectId), {
          id: projectId, projectCode: projectId, title, manager, pi,
          budget, personnelBudget, equipmentBudget, operatingBudget,
          progress, status, createdAt: serverTimestamp(), reporterId: currentUserId
        });
        feedback.className="mt-4 text-sm text-secondary-green"; feedback.textContent="專案新增成功！";
        document.getElementById("new-project-form").reset(); document.getElementById("proj-budget").value = 0;
      }catch(err){
        console.error(err); feedback.className="mt-4 text-sm text-red-600"; feedback.textContent=`專案新增失敗：${err.message}`;
      }
    }

    // 專案詳情（含附件）
    function renderProjectDetails(projectId){
      const container = document.getElementById("main-content");

      if(!projects || projects.length===0){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
            <p class="text-gray-700 mb-4">目前沒有任何專案資料。</p>
            <button onclick="setView('creation')" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">新增第一個專案</button>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        return;
      }

      if(!projectId){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-gray-700 mb-4">請選擇要查看的專案：</p>
            <div class="flex items-center gap-3">
              <select id="details-project-select" class="rounded-md border-gray-300 p-2 border flex-1">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("")}
              </select>
              <button id="details-go-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">查看詳情</button>
            </div>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        document.getElementById('details-go-btn')?.addEventListener('click',()=>{
          const sel = document.getElementById('details-project-select'); const val = sel?.value || null;
          if(val) setView('details', val);
        });
        return;
      }

      const project = projects.find(p=>p.id===projectId);
      if(!project){
        container.innerHTML = `
          <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i> 專案詳情
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <p class="text-red-600 mb-4">找不到專案「${escapeHtml(String(projectId))}」。請重新選擇：</p>
            <div class="flex items-center gap-3">
              <select id="details-project-select" class="rounded-md border-gray-300 p-2 border flex-1">
                ${projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("")}
              </select>
              <button id="details-go-btn" class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-700">查看詳情</button>
            </div>
          </div>`;
        if(window.lucide?.createIcons) lucide.createIcons();
        document.getElementById('details-go-btn')?.addEventListener('click',()=>{
          const sel = document.getElementById('details-project-select'); const val = sel?.value || null;
          if(val) setView('details', val);
        });
        return;
      }

      const progress = Number(project.progress)||0;
      const barColor = progress>=95 ? "bg-secondary-green" : (progress<50?"bg-accent-orange":"bg-primary-blue");
      const projectFiles = files.filter(f=>f.projectId===projectId);

      container.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary-blue"></i>
          專案詳情: ${escapeHtml(project.title)}
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-3">
            <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">基本資訊</h3>
            <p class="text-sm"><strong class="text-gray-600">計畫編號:</strong> ${escapeHtml(project.projectCode||project.id)}</p>
            <p class="text-sm"><strong class="text-gray-600">專案管理人:</strong> <span class="text-lg font-bold text-secondary-green">${escapeHtml(project.manager||"")}</span></p>
            <p class="text-sm"><strong class="text-gray-600">計畫主持人:</strong> ${escapeHtml(project.pi||"")}</p>
            <p class="text-sm"><strong class="text-gray-600">預算概算:</strong> ${fmtMoney(project.budget)}</p>
            <div class="text-sm text-gray-700 pl-1">
              <p>・人事費：${fmtMoney(project.personnelBudget)}</p>
              <p>・設備費：${fmtMoney(project.equipmentBudget)}</p>
              <p>・業務費：${fmtMoney(project.operatingBudget)}</p>
            </div>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-primary-blue mb-4 border-b pb-2">流程進度與相關文件</h3>
            <div class="flex items-center space-x-4 mb-4">
              <span class="text-gray-600 font-medium">總進度:</span>
              <div class="flex-grow bg-gray-200 rounded-full h-4">
                <div class="progress-bar h-4 rounded-full ${barColor}" style="width:${progress}%"></div>
              </div>
              <span class="font-bold text-lg ${progress>=95?'text-secondary-green':'text-primary-blue'}">${progress}%</span>
            </div>
            <p class="text-sm text-gray-700">目前狀態: <span class="font-medium text-lg text-red-500">${escapeHtml(project.status||"")}</span></p>

            <div class="mt-6">
              <h4 class="text-md font-semibold text-gray-700">附件上傳</h4>
              <div class="flex items-center gap-2">
                <input type="file" id="file-input" multiple class="block w-full text-sm text-gray-700"/>
                <button id="file-upload-btn" class="px-3 py-2 text-sm bg-primary-blue text-white rounded-lg hover:bg-blue-700">上傳</button>
              </div>
              <div id="file-upload-progress" class="text-xs text-gray-600 mt-2"></div>

              <h4 class="text-md font-semibold text-gray-700 mt-4">附件列表</h4>
              <ul id="file-list" class="list-disc list-inside text-sm text-primary-blue space-y-1 ml-4 mt-2">
                ${
                  projectFiles.length
                  ? projectFiles.map(f=>`
                      <li>
                        <a href="${escapeHtml(f.url)}" target="_blank" class="hover:underline">${escapeHtml(f.name)}</a>
                        <span class="text-gray-500">(${Math.round((Number(f.size)||0)/1024)} KB)</span>
                        ${ (f.reporterId||"")===currentUserId
                            ? `<button class="ml-2 text-red-600 text-xs hover:underline" onclick="deleteProjectFile('${escapeHtml(f.id)}')">刪除</button>`
                            : "" }
                      </li>
                    `).join("")
                  : '<li class="text-gray-500">尚無附件</li>'
                }
              </ul>
            </div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("file-upload-btn")?.addEventListener("click", async ()=>{
        const inp = document.getElementById("file-input");
        const progressEl = document.getElementById("file-upload-progress");
        const fl = inp?.files;
        if(!fl || fl.length===0){ showModal("未選擇檔案","請先選擇檔案再上傳。"); return; }
        if(!isAuthorized()){ showModal("請先登入","請先登入後再上傳。"); return; }
        try{
          progressEl.textContent = "上傳中...";
          await uploadProjectFiles(projectId, fl, (pct, name)=>{ progressEl.textContent = `上傳 ${name}：${pct}%`; });
          progressEl.textContent = "上傳完成。";
          inp.value = "";
        }catch(err){ console.error(err); progressEl.textContent = `上傳失敗：${err.message}`; }
      });
    }

    async function uploadProjectFiles(projectId, fileList, onProgress){
      for(const file of fileList){
        const safeName = file.name.replace(/[^\w.\-() ]+/g, "_");
        const storagePath = `artifacts/${APP_ID}/uploads/project_files/${projectId}/${Date.now()}_${safeName}`;
        const refObj = sRef(storage, storagePath);
        const task = uploadBytesResumable(refObj, file, { contentType: file.type || "application/octet-stream", customMetadata: { ownerUid: currentUserId } });
        await new Promise((resolve, reject)=>{ task.on("state_changed", snap => { if(onProgress){ const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100); onProgress(pct, file.name); } }, reject, resolve ); });
        const url = await getDownloadURL(refObj);
        await addDoc(collection(db, FILES_COLLECTION_PATH), {
          projectId, name: file.name, size: file.size || 0, contentType: file.type || "",
          url, storagePath, uploadedAt: serverTimestamp(), reporterId: currentUserId
        });
      }
    }
    async function deleteProjectFile(fileId){
      if(!isAuthorized()){ showModal("請先登入","請先登入後再操作。"); return; }
      const f = files.find(x=>x.id===fileId); if(!f){ showModal("找不到檔案",""); return; }
      if((f.reporterId||"") !== currentUserId){ showModal("權限限制","僅上傳者可刪除此檔案。"); return; }
      try{
        if(f.storagePath){ await deleteObject(sRef(storage, f.storagePath)); }
        await deleteDoc(doc(db, FILES_COLLECTION_PATH, fileId));
        showModal("刪除成功", f.name);
      }catch(err){ console.error(err); showModal("錯誤", `刪除檔案失敗：${err.message}`); }
    }
    window.deleteProjectFile = deleteProjectFile;

    // 任務
    function renderTaskManagement(){
      const c = document.getElementById("main-content");
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-primary-blue"></i> 任務管理中心
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">分配新任務</h3>
            <form id="new-task-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">所屬專案</label>
                <select id="task-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>'}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">任務名稱</label>
                <input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">分配給</label>
                <select id="task-assignee" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ managerOptionsHtml() }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">截止日期</label>
                <input type="date" id="task-due-date" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/>
              </div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-800">分配任務</button>
            </form>
            <div id="task-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>

          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">所有任務追蹤</h3>

            <div class="flex space-x-3 mb-4 text-sm">
              <select id="task-filter-manager" class="rounded-md border-gray-300 p-2 border">
                <option value="">所有負責人</option>
                ${ managerOptionsHtml() }
              </select>
              <select id="task-filter-status" class="rounded-md border-gray-300 p-2 border">
                <option value="">所有狀態</option>
                <option value="待辦">待辦</option>
                <option value="進行中">進行中</option>
                <option value="完成">完成</option>
                <option value="更新">即時更新</option>
              </select>
              <button onclick="renderTaskList()" class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">過濾</button>
            </div>

            <div id="current-tasks-list" class="space-y-2"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      document.getElementById("new-task-form")?.addEventListener("submit", handleNewTaskSubmission);
      renderTaskList();
    }

    async function handleNewTaskSubmission(e){
      e.preventDefault();
      const feedback = document.getElementById("task-form-feedback");
      if(!isAuthorized()){ showModal("請先登入","請先登入後再分配任務。"); return; }

      const projectId = document.getElementById("task-project-id").value;
      const taskName = document.getElementById("task-name").value;
      const assignee = document.getElementById("task-assignee").value;
      const dueDate = document.getElementById("task-due-date").value;

      if(!projectId){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先選擇專案。"; return; }
      try{
        const taskRef = await addDoc(collection(db, TASKS_COLLECTION_PATH), {
          projectId, taskName, assignee, dueDate, status:"待辦",
          createdAt: serverTimestamp(), reporterId: currentUserId
        });
        await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
          projectId, title: taskName, assignee, startDate: dueDate, endDate: dueDate,
          description: `任務：${taskName}（自動建立於任務分配）`,
          createdFromTaskId: taskRef.id, createdAt: serverTimestamp(), reporterId: currentUserId
        });
        feedback.className="mt-4 text-sm text-secondary-green"; feedback.textContent="任務分配成功！已同步建立行事曆事件。";
        document.getElementById("new-task-form").reset();
      }catch(err){ console.error(err); feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="任務分配失敗：資料庫錯誤。"; }
    }

    function renderTaskList(){
      const list = document.getElementById("current-tasks-list"); if(!list) return;
      const fm = document.getElementById("task-filter-manager")?.value || "";
      const fs = document.getElementById("task-filter-status")?.value || "";
      const data = tasks
        .filter(t => (!fm || t.assignee===fm) && (!fs || t.status===fs))
        .sort((a,b)=> (a.status==="待辦" && b.status!=="待辦")?-1 : (a.status!=="待辦" && b.status==="待辦")?1 : (new Date(a.dueDate)-new Date(b.dueDate)));
      if(data.length===0){ list.innerHTML = '<p class="text-gray-500 text-center py-8">沒有符合過濾條件的任務。</p>'; return; }
      list.innerHTML = data.map(t=>{
        const project = projects.find(p=>p.id===t.projectId);
        let badge="bg-gray-100 text-gray-700", actionText="標記完成", actionFn=`updateTaskStatus('${escapeHtml(t.id)}','完成')`;
        if(t.status==="待辦"){ badge="bg-red-100 text-red-800"; actionText="開始進行"; actionFn=`updateTaskStatus('${escapeHtml(t.id)}','進行中')`; }
        else if(t.status==="進行中"){ badge="bg-yellow-100 text-yellow-800"; }
        else if(t.status==="完成"){ badge="bg-secondary-green/20 text-secondary-green"; actionText="已完成"; actionFn=`showModal('已完成','此任務已標記完成，無法再操作。')`; }
        else if(t.status==="更新"){ badge="bg-blue-100 text-blue-800"; actionText="查看詳情"; actionFn=`setView('details','${escapeHtml(t.projectId)}')`; }
        return `
          <div class="project-card bg-gray-50 p-4 rounded-lg border-l-4 ${ t.status==="待辦"?"border-red-500": t.status==="進行中"?"border-yellow-500": t.status==="完成"?"border-green-500":"border-blue-500"}">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <p class="font-bold text-lg text-gray-900">${escapeHtml(t.taskName||"")}</p>
                <p class="text-xs text-gray-500">專案: <span class="font-medium text-primary-blue cursor-pointer hover:underline" onclick="setView('details','${escapeHtml(t.projectId)}')">${escapeHtml(project?.title || t.projectId || "")}</span></p>
              </div>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${badge}">${escapeHtml(t.status||"")}</span>
            </div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between items-center">
              <p><i data-lucide="user" class="w-4 h-4 inline mr-1"></i> 負責人: <span class="font-medium">${escapeHtml(t.assignee||"")}</span>
                 <span class="ml-4"><i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> 期限: ${escapeHtml(t.dueDate||"")}</span></p>
              <button onclick="${actionFn}" class="px-3 py-1 text-xs rounded-lg text-white ${ t.status!=="更新" ? "bg-secondary-green hover:bg-green-700" : "bg-blue-600 hover:bg-blue-700"}">${actionText}</button>
            </div>
          </div>`;
      }).join("");
      if(window.lucide?.createIcons) lucide.createIcons();
    }

    async function updateTaskStatus(taskId, newStatus){
      if(!isAuthorized()){ showModal("請先登入","請先登入後再操作。"); return; }
      try{
        await updateDoc(doc(db, TASKS_COLLECTION_PATH, taskId), { status:newStatus, updatedAt: serverTimestamp() });
      }catch(err){ console.error(err); showModal("錯誤", `更新任務狀態失敗：${err.message}`); }
    }
    window.updateTaskStatus = updateTaskStatus;

    // 行事曆
    function buildCalendarEventsForFC(){
      return events.map(ev=>{
        const start=ev.startDate, end=(ev.endDate && ev.endDate!==ev.startDate)?ev.endDate:ev.startDate;
        return { id:ev.id, title:`${ev.title||""} (${ev.assignee||""})`, start, end, allDay:true,
                 extendedProps:{ projectId: ev.projectId, assignee: ev.assignee, description: ev.description||"" } };
      });
    }
    function renderCalendar(){
      const c = document.getElementById("main-content");
      c.innerHTML = `
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
          <i data-lucide="calendar" class="w-7 h-7 mr-3 text-primary-blue"></i> 行事曆
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg"><div id="calendar"></div></div>
          <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">新增行事</h3>
            <form id="new-event-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">所屬專案</label>
                <select id="evt-project-id" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                  ${ projects.length>0 ? projects.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} - ${escapeHtml(p.title)}</option>`).join("") : '<option value="">請先新增專案</option>'}
                </select>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">標題</label><input type="text" id="evt-title" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              <div><label class="block text-sm font-medium text-gray-700">參與者/負責人</label><select id="evt-assignee" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">${ managerOptionsHtml() }</select></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">開始日期</label><input type="date" id="evt-start" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
                <div><label class="block text-sm font-medium text-gray-700">結束日期</label><input type="date" id="evt-end" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">說明（可選）</label><textarea id="evt-desc" rows="3" class="mt-1 block w-full rounded-md border-gray-300 p-2 border" placeholder="補充說明"></textarea></div>
              <button type="submit" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-800">新增行事</button>
            </form>
            <div id="event-form-feedback" class="mt-4 text-sm font-medium"></div>
          </div>
        </div>
      `;
      if(window.lucide?.createIcons) lucide.createIcons();

      const calEl = document.getElementById("calendar");
      if(calEl && window.FullCalendar){
        if(calendarInstance) { calendarInstance.destroy(); calendarInstance=null; }
        calendarInstance = new FullCalendar.Calendar(calEl, {
          locale:"zh-tw", initialView:"dayGridMonth", height:700,
          headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek" },
          events: buildCalendarEventsForFC(),
          dateClick:(info)=>{ const s=document.getElementById("evt-start"); const e=document.getElementById("evt-end"); if(s) s.value=info.dateStr; if(e) e.value=info.dateStr; },
          eventClick:(info)=>{ const ev=info.event; const pId = ev.extendedProps?.projectId||""; const desc=ev.extendedProps?.description||""; showModal(ev.title, `專案: ${pId}\n負責: ${ev.extendedProps?.assignee||""}\n${desc?('說明: '+desc):''}`); }
        }); calendarInstance.render();
      }

      document.getElementById("new-event-form")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const feedback = document.getElementById("event-form-feedback");
        if(!isAuthorized()){ showModal("請先登入","請先登入後再新增行事。"); return; }
        const projectId = document.getElementById("evt-project-id").value;
        const title = document.getElementById("evt-title").value;
        const assignee = document.getElementById("evt-assignee").value;
        const startDate = document.getElementById("evt-start").value;
        const endDate = document.getElementById("evt-end").value;
        const description = document.getElementById("evt-desc").value;
        if(!projectId){ feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="請先選擇專案。"; return; }
        try{
          await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
            projectId, title, assignee, startDate, endDate, description,
            createdAt: serverTimestamp(), reporterId: currentUserId
          });
          feedback.className="mt-4 text-sm text-secondary-green"; feedback.textContent="行事已新增！";
          document.getElementById("new-event-form").reset(); renderCalendar();
        }catch(err){ console.error(err); feedback.className="mt-4 text-sm text-red-600"; feedback.textContent="新增行事失敗：資料庫錯誤。"; }
      });
    }

    // 報告、社群（原樣，略：已於上方函式中保留）

    // 側欄展開/收合
    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const isCurrentlyExpanded = sb.classList.contains('expanded');
      const nextExpanded = (typeof force === 'boolean') ? force : !isCurrentlyExpanded;
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){
        btn.title = nextExpanded ? '收合' : '展開';
        btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="nav-icon"></i>' : '<i data-lucide="panel-left-open" class="nav-icon"></i>';
      }
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
      if(window.lucide?.createIcons) lucide.createIcons();
    };

    // 啟動
    window.addEventListener('DOMContentLoaded', ()=>{
      const savedExpanded = (()=>{
        try{ return localStorage.getItem('sidebarExpanded') !== '0'; }catch{ return true; }
      })();
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      sb.classList.toggle('expanded', savedExpanded);
      sb.classList.toggle('collapsed', !savedExpanded);
      sb.style.width = savedExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = savedExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){
        btn.title = savedExpanded ? '收合' : '展開';
        btn.innerHTML = savedExpanded ? '<i data-lucide="panel-left-close" class="nav-icon"></i>' : '<i data-lucide="panel-left-open" class="nav-icon"></i>';
      }

      currentView = "dashboard";
      renderDashboard(true);
      initFirebase();

      if(window.lucide?.createIcons) lucide.createIcons();
    });
  </script>
</body>
</html>
