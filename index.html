<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>深耕計畫專案管理儀表板</title>

  <!-- CSP：擴充常用來源，避免 Storage/頭像/Google 登入被擋 -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline'
                            https://www.gstatic.com
                            https://*.gstatic.com
                            https://cdn.tailwindcss.com
                            https://unpkg.com
                            https://cdn.jsdelivr.net
                            https://www.google.com
                            https://*.google.com
                            https://apis.google.com;
                 connect-src 'self'
                              https://firestore.googleapis.com
                              https://identitytoolkit.googleapis.com
                              https://securetoken.googleapis.com
                              https://www.googleapis.com
                              https://*.googleapis.com
                              https://apis.google.com
                              https://*.gstatic.com
                              https://accounts.google.com
                              https://firebasestorage.googleapis.com
                              https://*.firebasestorage.app
                              https://content-firebaseappcheck.googleapis.com
                              https://script.google.com
                              https://script.googleusercontent.com
                              https://*.logic.azure.com
                              https://*.azure-apim.net;
                 img-src 'self' data: https: https://*.googleusercontent.com https://*.firebasestorage.app;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 frame-src 'self'
                           https://www.google.com
                           https://*.google.com
                           https://www.gstatic.com
                           https://*.gstatic.com
                           https://accounts.google.com
                           https://apis.google.com;
                 object-src 'none';
                 base-uri 'self';">

  <!-- UI 套件 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- 專案設定（請依你的 Firebase 專案調整） -->
  <script>
    window.__firebase_config_object = {
      apiKey: "AIzaSyCIXWS0ynK4GdsdQIXkOs3fHuzAendZ7LA",
      authDomain: "taiwanplan-f7566.firebaseapp.com",
      projectId: "taiwanplan-f7566",
      storageBucket: "taiwanplan-f7566.firebasestorage.app",
      messagingSenderId: "874700126533",
      appId: "1:874700126533:web:5461432d0169b7de6ee62c"
    };
    window.__app_id = "taiwanplan-f7566";
    window.__sharepoint_flow_url = ""; // 可填入 Power Automate HTTP Trigger
    window.__ai_summary_webapp_url = ""; // 可填入 Apps Script WebApp 產生摘要
  </script>

  <style>
    .project-card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:transform .2s}
    .project-card:hover{transform:translateY(-2px)}
    .progress-bar{transition:width .5s ease-in-out}
    #app-sidebar{overflow:hidden}
    #app-sidebar.expanded{width:240px!important}
    #app-sidebar.collapsed{width:72px!important}
    #app-sidebar .nav-item{display:flex;align-items:center;gap:.75rem;width:100%;padding:.5rem .5rem;border-radius:.75rem;color:#e5e7eb;transition:background-color .15s,color .15s}
    #app-sidebar .nav-item:hover{background-color:rgba(255,255,255,.08);color:#fff}
    #app-sidebar .nav-item.active{background-color:rgba(59,130,246,.18);color:#fff}
    #app-sidebar .nav-icon{width:22px;height:22px;stroke-width:2.2}
    #app-sidebar .nav-label{display:inline;white-space:nowrap;font-weight:600;font-size:.875rem}
    #app-sidebar.collapsed .nav-label{display:none}
    #app-main{transition:margin-left .2s ease}
    .landing-bg{
      background: radial-gradient(1200px 600px at 85% 85%, #7c3aed30, transparent 60%),
                  radial-gradient(1000px 500px at 0% 100%, #ec489930, transparent 55%),
                  linear-gradient(180deg, #ffffff 0%, #f7f7fb 100%);
    }
    #debug{position:fixed;right:8px;bottom:8px;background:#111827;color:#e5e7eb;border-radius:10px;max-width:48rem;width:calc(100vw - 16px);font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;display:none}
    #debug header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid #374151}
    #debug pre{margin:0;padding:8px 10px;max-height:40vh;overflow:auto;white-space:pre-wrap}
    #debug .pill{background:#374151;color:#9ca3af;border-radius:20px;padding:2px 8px;margin-left:6px;font-size:11px}
    #debug .ok{color:#10b981} #debug .warn{color:#f59e0b} #debug .err{color:#ef4444}

    /* In-App Browser Overlay */
    #inapp-overlay{position:fixed;inset:0;z-index:60;background:rgba(17,24,39,.85);color:#e5e7eb;display:none}
    #inapp-card{max-width:30rem;margin:10vh auto;background:#111827;border:1px solid #374151;border-radius:14px;padding:18px}
    .action-btn{display:inline-flex;align-items:center;gap:.4rem;border-radius:10px;padding:.5rem .8rem}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-gray{background:#374151;color:#e5e7eb}
    .link{color:#2563eb;cursor:pointer}
    .link:hover{text-decoration:underline}
    .disabled{opacity:.6;cursor:not-allowed}

    /* 全域狀態列（顯示 Firestore/登入錯誤） */
    #status-banner{position:fixed;left:16px;right:16px;bottom:16px;z-index:50;border-radius:12px;padding:10px 12px;display:none}

    /* 簡易彈窗 */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:70}
    .modal-card{background:#fff;border-radius:14px;max-width:42rem;width:calc(100vw - 24px);padding:16px}
    .form-row{display:flex;gap:.75rem}
    .form-row>*{flex:1}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:.5rem .6rem;text-align:left}
    .chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.75rem}
    .chip.todo{background:#eef2ff;color:#3730a3}
    .chip.wip{background:#ecfeff;color:#155e75}
    .chip.done{background:#ecfdf5;color:#065f46}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.45rem .75rem;border-radius:.6rem}
    .btn-primary{background:#1e40af;color:#fff}
    .btn-gray{background:#f3f4f6}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .card{background:#fff;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:14px}
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- 登入首頁 -->
  <section id="landing" class="landing-bg min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 text-2xl font-extrabold text-blue-800">
          <i data-lucide="sparkles" class="w-6 h-6"></i> 深耕計畫 PM
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Welcome back! 歡迎回來！</h1>
        <p class="text-sm text-gray-500 text-center mt-2">請選擇登入方式</p>

        <!-- Google 登入 -->
        <button id="btn-google" onclick="signInWithGoogle()" disabled
                class="mt-4 w-full py-3 rounded-xl bg-blue-800 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold flex items-center justify-center gap-2">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> 使用 Google 登入
        </button>

        <!-- Email/Password 備援登入 -->
        <div class="mt-6">
          <div class="text-center text-sm text-gray-500 mb-2">或使用 Email 登入</div>
          <form id="email-form" class="space-y-3">
            <input id="email" type="email" required placeholder="Email" class="w-full border rounded-lg p-2 border-gray-300"/>
            <input id="password" type="password" required placeholder="密碼（至少 6 碼）" class="w-full border rounded-lg p-2 border-gray-300"/>
            <div class="flex gap-2">
              <button id="btn-email-signin" type="submit" class="flex-1 py-2 rounded-lg bg-gray-900 text-white">Email 登入</button>
              <button id="btn-email-signup" type="button" class="flex-1 py-2 rounded-lg bg-gray-100">註冊</button>
            </div>
            <div class="text-right">
              <button id="btn-reset" type="button" class="text-xs text-blue-700 underline">忘記密碼</button>
            </div>
            <div id="email-msg" class="text-sm"></div>
          </form>
        </div>

        <div class="flex items-center justify-between mt-3 text-xs text-gray-600">
          <div id="landing-loading" class="hidden">登入狀態還原中，請稍候…</div>
          <div class="space-x-3">
            <button id="btn-auth-reset" class="hidden link" onclick="clearAuthStuck()">清除登入狀態</button>
            <button id="btn-open-window" class="hidden link" onclick="openInNewWindow()">在新視窗開啟</button>
          </div>
        </div>
      </div>

      <p class="text-xs text-gray-400 text-center mt-6">本網站使用 Firebase Auth；登入後方能讀取/寫入資料。</p>
    </div>
  </section>

  <!-- In-App Browser Overlay -->
  <div id="inapp-overlay" aria-hidden="true">
    <div id="inapp-card">
      <div class="text-lg font-bold mb-1">請在外部瀏覽器開啟以使用 Google 登入</div>
      <div class="text-sm text-gray-300">
        偵測到目前是 App 內建瀏覽器（LINE/FB/IG 等），Google 登入會被封鎖（403: disallowed_useragent）。<br/>
        你仍可使用「Email 登入」；若要用 Google 登入，請改在外部瀏覽器開啟本頁。
      </div>
      <ul class="text-sm text-gray-200 list-disc pl-6 mt-3 space-y-1">
        <li>點右上角或分享選單，選「在瀏覽器中開啟」（iOS: Safari；Android: Chrome）。</li>
        <li>或點下方「在新視窗開啟」；若仍在 App 內，請手動複製網址到外部瀏覽器。</li>
      </ul>
      <div class="mt-4 flex gap-2">
        <button class="action-btn btn-blue" onclick="openInNewWindow()"><i data-lucide='external-link' class='w-4 h-4'></i>在新視窗開啟</button>
        <button class="action-btn btn-gray" onclick="copyUrl()"><i data-lucide='clipboard' class='w-4 h-4'></i>複製本站網址</button>
      </div>
    </div>
  </div>

  <!-- 應用殼 -->
  <div id="app-shell" class="hidden">
    <aside id="app-sidebar" class="fixed inset-y-2 left-2 z-10 rounded-2xl bg-black text-white shadow-2xl flex flex-col justify-between py-3 transition-all duration-200 expanded" style="width:240px;">
      <div class="w-full">
        <div class="flex items-center justify-between px-3 mb-2">
          <button class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 shadow-md" title="Home" onclick="setView('dashboard')"></button>
          <button id="btn-toggle" class="p-2 rounded-lg hover:bg-white/10" title="收合/展開" onclick="toggleSidebar()">
            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
          </button>
        </div>
        <nav class="w-full flex flex-col items-stretch space-y-1 px-1">
          <button class="nav-item group" data-view="dashboard" onclick="setView('dashboard')"><i data-lucide="house" class="nav-icon"></i><span class="nav-label">Home</span></button>
          <button class="nav-item group" data-view="tasks" onclick="setView('tasks')"><i data-lucide="clipboard-check" class="nav-icon"></i><span class="nav-label">任務</span></button>
          <button class="nav-item group" data-view="calendar" onclick="setView('calendar')"><i data-lucide="calendar" class="nav-icon"></i><span class="nav-label">行事曆</span></button>
          <button class="nav-item group" data-view="report" onclick="setView('report')"><i data-lucide="file-text" class="nav-icon"></i><span class="nav-label">報告</span></button>
          <button class="nav-item group" data-view="community" onclick="setView('community')"><i data-lucide="messages-square" class="nav-icon"></i><span class="nav-label">資訊交流</span></button>
          <button class="nav-item group" data-view="details" onclick="setView('details')"><i data-lucide="layout-dashboard" class="nav-icon"></i><span class="nav-label">專案詳情</span></button>
        </nav>
      </div>
      <div class="w-full flex flex-col items-stretch space-y-1 px-1">
        <div id="user-box" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-white/10 mx-1">
          <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
            <img id="user-avatar" alt="" class="w-full h-full object-cover hidden">
            <div id="user-initial" class="w-full h-full flex items-center justify-center text-black/70 font-bold text-sm">U</div>
          </div>
          <div class="min-w-0">
            <div id="user-display-name" class="text-sm font-semibold truncate"></div>
            <div id="user-email" class="text-xs opacity-80 truncate"></div>
          </div>
        </div>
        <button id="btn-signout" class="nav-item group" onclick="appSignOut()">
          <i data-lucide="log-out" class="nav-icon"></i><span class="nav-label">登出</span>
        </button>
      </div>
    </aside>

    <main id="app-main" class="flex-grow p-8" style="margin-left:240px;">
      <!-- 連線/權限狀態列 -->
      <div id="status-banner" class="bg-yellow-100 text-yellow-900 border border-yellow-300"></div>
      <div id="main-content" class="w-full"></div>
    </main>
  </div>

  <!-- Debug 面板（網址加 ?debug=1 開啟） -->
  <div id="debug">
    <header>
      <div>Auth Debug<span id="dbg-state" class="pill">init</span></div>
      <button style="color:#9ca3af" onclick="document.getElementById('debug').style.display='none'">✕</button>
    </header>
    <pre id="dbg-log"></pre>
  </div>

  <!-- App 腳本 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      indexedDBLocalPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      inMemoryPersistence,
      GoogleAuthProvider,
      onAuthStateChanged,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel, getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    setLogLevel('error');

    // ============ Debug ============
    const debugMode = /[?&]debug=1/.test(location.search);
    const dbgEl = document.getElementById('debug');
    const dbgLogEl = document.getElementById('dbg-log');
    const dbgStateEl = document.getElementById('dbg-state');
    if (debugMode) dbgEl.style.display='block';
    function logDbg(type, msg, obj){
      if(!debugMode) return;
      const now = new Date().toISOString().slice(11,19);
      dbgLogEl.textContent += `[${now}] [${type}] ${msg}${obj?`: ${typeof obj==='string'?obj:JSON.stringify(obj)}`:''}\n`;
      dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
    }
    function setDbgState(s, cls){ if(!debugMode) return; dbgStateEl.textContent = s; dbgStateEl.className = 'pill ' + (cls||''); }

    // ============ 全域 ============
    let db, auth, storage;
    let currentUserId = "";
    let listenersStarted = false;
    let userProfile = { displayName:"", email:"", photoURL:"" };

    // 設定
    const APP_ID = window.__app_id || "default-app-id";
    const firebaseConfig = window.__firebase_config_object || null;

    // Firestore 路徑
    const PROJECTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/project_metadata`;
    const TASKS_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_tasks`;
    const EVENTS_COLLECTION_PATH   = `artifacts/${APP_ID}/public/data/calendar_events`;
    const FILES_COLLECTION_PATH    = `artifacts/${APP_ID}/public/data/project_files`;
    const SETTINGS_DOC_PATH        = `artifacts/${APP_ID}/public/settings`;
    const MANAGERS_COLLECTION_PATH = `artifacts/${APP_ID}/public/settings/project_managers`;
    const COMMUNITY_COLLECTION_PATH= `artifacts/${APP_ID}/public/community/posts`;

    // DOM
    const landing = document.getElementById("landing");
    const landingLoading=document.getElementById("landing-loading");
    const appShell = document.getElementById("app-shell");
    const btnGoogle = document.getElementById('btn-google');
    const resetBtn = document.getElementById('btn-auth-reset');
    const openWindowBtn = document.getElementById('btn-open-window');
    const inAppOverlay = document.getElementById('inapp-overlay');

    const emailForm = document.getElementById('email-form');
    const emailInput= document.getElementById('email');
    const passInput = document.getElementById('password');
    const emailMsg  = document.getElementById('email-msg');

    const statusBanner = document.getElementById('status-banner');

    // ============ 小工具 ============
    function showModal(title, message){ alert((title||"提示") + (message?("\n\n" + message):"")); }
    function n(v){ return Number(v)||0; }
    function fmtMoney(x){ return `$${(Number(x)||0).toLocaleString()}`; }
    function tsToDateStr(v){
      try{
        if(!v) return "";
        if (typeof v==="string") return v.slice(0,10);
        if (v?.toDate) return v.toDate().toISOString().slice(0,10);
        if (v instanceof Date) return v.toISOString().slice(0,10);
      }catch(e){ return "" }
      return "";
    }
    function canUseSessionStorage(){ try{ const k='__ss__'+Math.random(); sessionStorage.setItem(k,'1'); const ok=sessionStorage.getItem(k)==='1'; sessionStorage.removeItem(k); return ok; } catch{ return false; } }
    function isLikelyInAppBrowser(){
      const ua = navigator.userAgent || '';
      return /(FBAN|FBAV|Instagram|Line\/| Line;|MicroMessenger|WeChat|Twitter|TikTok|MiuiBrowser|wv;|; wv\)|OPR\/|DuckDuckGo)/i.test(ua);
    }
    function openInNewWindow(){ try{ window.open(location.href,'_blank','noopener,noreferrer'); }catch{} }
    window.openInNewWindow = openInNewWindow;
    async function copyUrl(){
      const url = location.href.split('#')[0];
      try{ await navigator.clipboard.writeText(url); showModal('已複製網址', url); }
      catch{ showModal('請手動複製網址', url); }
    }
    window.copyUrl = copyUrl;

    function setBanner(type, text){
      if(!statusBanner) return;
      const cls = type==='error' ? 'bg-red-100 text-red-900 border-red-300'
                : type==='warn' ? 'bg-yellow-100 text-yellow-900 border-yellow-300'
                : 'bg-green-100 text-green-900 border-green-300';
      statusBanner.className = cls + ' rounded-xl px-3 py-2 mb-3';
      statusBanner.style.display = 'block';
      statusBanner.innerHTML = text || '';
    }
    function clearBanner(){ if(statusBanner){ statusBanner.style.display='none'; statusBanner.innerHTML=''; } }

    // ============ 使用者 UI ============
    function updateUserChips(){
      const nameEl = document.getElementById("user-display-name");
      const emailEl= document.getElementById("user-email");
      const avatar = document.getElementById("user-avatar");
      const initial= document.getElementById("user-initial");
      const displayName = userProfile.displayName || userProfile.email?.split("@")[0] || "使用者";
      const email = userProfile.email || "";
      if(nameEl) nameEl.textContent = displayName;
      if(emailEl) emailEl.textContent = email;
      if(userProfile.photoURL){
        avatar?.setAttribute("src", userProfile.photoURL);
        avatar?.classList.remove("hidden");
        initial?.classList.add("hidden");
      }else{
        avatar?.classList.add("hidden");
        if(initial){ initial.textContent = (displayName[0]||"U").toUpperCase(); initial.classList.remove("hidden"); }
      }
    }

    function showAppShell(show){
      if(show){ landing.classList.add("hidden"); appShell.classList.remove("hidden"); }
      else{ appShell.classList.add("hidden"); landing.classList.remove("hidden"); }
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    function applyUser(user){
      if(user){
        currentUserId = user.uid;
        userProfile = { displayName:user.displayName||"", email:user.email||"", photoURL:user.photoURL||"" };
        updateUserChips();
        showAppShell(true);
        if(!listenersStarted) initializeSystem(true);
        setDbgState('signed-in','ok'); logDbg('OK','applyUser signed-in',{uid:user.uid,email:user.email});
        clearBanner();
      }else{
        currentUserId = "";
        userProfile = { displayName:"", email:"", photoURL:"" };
        showAppShell(false);
        setDbgState('signed-out'); logDbg('INFO','applyUser signed-out');
      }
    }

    // ============ 登入輔助 ============
    async function clearAuthStuck(){
      try{ landingLoading?.classList.add("hidden"); }catch{}
      try{ btnGoogle?.removeAttribute('disabled'); }catch{}
      try{ await signOut(auth); }catch{}
      try{ [localStorage, sessionStorage].forEach(store=>{ try{ for(const k of Object.keys(store)){ if(/^firebase:/.test(k) || /firebase/i.test(k)) store.removeItem(k); } }catch{} }); }catch{}
      logDbg('WARN','auth cache cleared');
      alert('已清除登入快取，請重新登入。若你在 App 內建瀏覽器，建議改用外部瀏覽器或使用 Email 登入。');
    }
    window.clearAuthStuck = clearAuthStuck;

    // 追蹤 redirect 啟動與回來的還原狀態（避免「回來卻沒人」）
    const REDIRECT_FLAG_KEY = 'auth:redirect:startedAt';
    function markRedirectStart(){ try{ localStorage.setItem(REDIRECT_FLAG_KEY, String(Date.now())); }catch{} }
    function redirectStartedMs(){ try{ return Number(localStorage.getItem(REDIRECT_FLAG_KEY)||0); }catch{ return 0 } }
    function clearRedirectFlag(){ try{ localStorage.removeItem(REDIRECT_FLAG_KEY); }catch{} }

    // Google 登入：popup → redirect（僅當 sessionStorage 可用）＋ 強化錯誤提示
    window.signInWithGoogle = async function(){
      if(isLikelyInAppBrowser()){
        inAppOverlay.style.display = 'block';
        openWindowBtn?.classList.remove('hidden');
        resetBtn?.classList.remove('hidden');
        showModal("請在外部瀏覽器開啟", "目前為 App 內建瀏覽器環境，Google 登入會被封鎖（403: disallowed_useragent）。請改用 Safari/Chrome 或使用 Email 登入。");
        return;
      }
      try{
        if(!auth){ await initFirebase().catch(()=>{}); }
        if(!auth){ showModal("初始化中","驗證服務尚未就緒，請稍候再試或重新整理。"); return; }
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        try{
          setDbgState('popup','warn'); logDbg('INFO','signInWithPopup try',{ua:navigator.userAgent});
          await signInWithPopup(auth, provider);
          logDbg('OK','signInWithPopup success');
          return;
        }catch(e){
          const code = e?.code || "";
          logDbg('WARN','signInWithPopup failed', {code, message:e?.message});
          const ssOK = canUseSessionStorage();
          if(ssOK){
            setDbgState('redirecting','warn'); logDbg('INFO','fallback to signInWithRedirect');
            markRedirectStart();
            await signInWithRedirect(auth, provider);
            return;
          }else{
            openWindowBtn?.classList.remove('hidden');
            resetBtn?.classList.remove('hidden');
            setBanner('warn', '瀏覽器封鎖了登入視窗或儲存機制，請允許彈出視窗、改用外部瀏覽器，或使用 Email 登入。');
            showModal("瀏覽器封鎖了登入視窗",
              "請允許彈出視窗（pop-up），或點「在新視窗開啟」，或改用外部瀏覽器（Chrome/Edge/Safari 非無痕），或改用下方 Email 登入。");
          }
        }
      }catch(e){
        logDbg('ERR','signInWithGoogle outer catch', {code:e?.code, message:e?.message});
        landingLoading?.classList.add("hidden");
        btnGoogle?.removeAttribute('disabled');
        resetBtn?.classList.remove('hidden');
      }
    };

    // Email/Password 登入/註冊/重設
    function setEmailMsg(text, ok){
      emailMsg.textContent = text || "";
      emailMsg.className = "text-sm " + (ok ? "text-green-600" : "text-red-600");
    }
    emailForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const email = emailInput.value.trim();
        const pass  = passInput.value;
        setEmailMsg("登入中...", true);
        await signInWithEmailAndPassword(auth, email, pass);
        setEmailMsg("登入成功！正在進入儀表板...", true);
      }catch(err){
        setEmailMsg(err?.message || "登入失敗", false);
      }
    });
    document.getElementById('btn-email-signup').addEventListener('click', async ()=>{
      try{
        const email = emailInput.value.trim();
        const pass  = passInput.value;
        if(pass.length < 6){ setEmailMsg("密碼至少 6 碼。", false); return; }
        setEmailMsg("註冊中...", true);
        await createUserWithEmailAndPassword(auth, email, pass);
        setEmailMsg("註冊成功，已自動登入！", true);
      }catch(err){
        setEmailMsg(err?.message || "註冊失敗", false);
      }
    });
    document.getElementById('btn-reset').addEventListener('click', async ()=>{
      try{
        const email = (emailInput.value || "").trim();
        if(!email){ setEmailMsg("請先輸入 Email 再點重設密碼。", false); return; }
        await sendPasswordResetEmail(auth, email);
        setEmailMsg("已寄出重設密碼信，請查收。", true);
      }catch(err){
        setEmailMsg(err?.message || "寄送失敗", false);
      }
    });

    window.appSignOut = async function(){
      try{ await signOut(auth); showModal("已登出","您已成功登出。"); applyUser(null); }
      catch(e){ showModal("登出失敗", e?.message || String(e)); }
    };

    window.toggleSidebar = function(force){
      const sb = document.getElementById('app-sidebar');
      const main = document.getElementById('app-main');
      const nextExpanded = (typeof force === 'boolean') ? force : !sb.classList.contains('expanded');
      sb.classList.toggle('expanded', nextExpanded);
      sb.classList.toggle('collapsed', !nextExpanded);
      sb.style.width = nextExpanded ? '240px' : '72px';
      if(main) main.style.marginLeft = nextExpanded ? '240px' : '72px';
      const btn = document.getElementById('btn-toggle');
      if(btn){ btn.innerHTML = nextExpanded ? '<i data-lucide="panel-left-close" class="w-5 h-5"></i>' : '<i data-lucide="panel-left-open" class="w-5 h-5"></i>'; }
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
      try{ localStorage.setItem('sidebarExpanded', nextExpanded ? '1' : '0'); }catch{}
    };

    // ============ Firebase 初始化 ============
    async function choosePersistence(auth){
      const candidates = [indexedDBLocalPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence];
      for(const p of candidates){
        try{ await setPersistence(auth, p); logDbg('OK','persistence selected', {name: p.type || (p.toString?.() || 'unknown')}); return p; }
        catch(e){ logDbg('WARN','persistence failed', {target:p.type || 'unknown', code:e?.code, message:e?.message}); }
      }
      return null;
    }

    // 等待 auth 狀態回來（onAuthStateChanged 或 getRedirectResult 其一先到）
    function waitForAuthUser(timeoutMs=15000){
      return new Promise(async (resolve)=>{
        let settled = false;
        const t = setTimeout(()=>{ if(!settled){ settled = true; resolve(null); } }, timeoutMs);

        const unsub = onAuthStateChanged(auth, (user)=>{
          if(!settled && user){ settled = true; clearTimeout(t); unsub(); resolve(user); }
        });

        try{
          const rr = await getRedirectResult(auth);
          if(!settled && rr?.user){ settled = true; clearTimeout(t); unsub(); resolve(rr.user); }
          else logDbg('INFO','getRedirectResult '+(rr?.user?'user':'empty'));
        }catch(e){
          logDbg('ERR','getRedirectResult error', {code:e?.code, message:e?.message});
          if(e?.code === 'auth/unauthorized-domain'){
            setBanner('error','Google 登入被拒（unauthorized-domain）。請到 Firebase Console → Authentication → Settings → Authorized domains 加入 chylio.github.io。');
          }else if((e?.message||'').toLowerCase().includes('initial state')){
            setBanner('warn','瀏覽器清除了登入初始狀態（missing initial state）。請允許此站的 Cookie/重新導向，或改用 Email 登入/外部瀏覽器。');
          }
        }
      });
    }

    async function initFirebase(){
      if(auth) return;
      if(!firebaseConfig){ showModal("設定錯誤","缺少 Firebase 設定"); return; }

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app); auth.languageCode='zh-TW';
      db = getFirestore(app);
      storage = getStorage(app);

      landingLoading?.classList.remove("hidden");
      resetBtn?.classList.add('hidden');
      openWindowBtn?.classList.toggle('hidden', !isLikelyInAppBrowser());
      setDbgState('restoring','warn'); logDbg('INFO','init: restoring...', {ua:navigator.userAgent, ssOK: canUseSessionStorage(), inApp:isLikelyInAppBrowser(), path: location.pathname});

      // 逾時保護
      let settled=false;
      const safetyTimer=setTimeout(()=>{
        if(!settled){
          logDbg('WARN','restore-timeout','no auth state after 7s');
          landingLoading?.classList.add("hidden");
          btnGoogle?.removeAttribute('disabled');
          resetBtn?.classList.remove('hidden');
          setDbgState('timeout','warn');
        }
      },7000);

      // onAuthStateChanged
      onAuthStateChanged(auth, (user)=>{
        logDbg('INFO','onAuthStateChanged', !!user ? 'user present' : 'no user');
        applyUser(user);
        btnGoogle?.removeAttribute('disabled');
      });

      // 選擇持久化
      try{ await choosePersistence(auth); }catch(e){ logDbg('ERR','choosePersistence error', {code:e?.code, message:e?.message}); }

      // 若剛剛從 redirect 回來，等待還原
      const redirectedAt = redirectStartedMs();
      if(redirectedAt){
        setDbgState('restoring','warn');
        const u = await waitForAuthUser(15000);
        clearRedirectFlag();
        if(u){
          logDbg('OK','redirect restored',{uid:u.uid,email:u.email});
          applyUser(u);
        }else{
          setBanner('warn','Google 重新導向回來但無法取得登入狀態。請允許彈出視窗與 Cookie，或改用 Email 登入。');
        }
      }

      landingLoading?.classList.add("hidden");
      settled=true; clearTimeout(safetyTimer);
    }

    function isAuthorized(){ return !!currentUserId; }

    // ============ 資料狀態 ============
    let managers=[]; const DEFAULT_MANAGERS=["蔡雅雯","陳乃菁","吳曉琪","蘇琬淳","楊穎潔","王小明","李小華","張曉安"];
    let currentView="dashboard",selectedProjectId=null,calendarInstance=null;
    let projects=[],tasks=[],events=[],files=[],communityPosts=[],budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0};

    // ============ 監聽與處理 ============
    function setActiveByView(view){
      document.querySelectorAll('#app-sidebar .nav-item').forEach(el=>{ el.classList.toggle('active', el.getAttribute('data-view') === view); });
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }
    window.setView=function(view,arg){
      currentView=view; setActiveByView(view);
      if(view==="dashboard") renderDashboard();
      else if(view==="tasks") renderTaskManagement();
      else if(view==="calendar") renderCalendar();
      else if(view==="report") renderReport();
      else if(view==="community") renderCommunity();
      else if(view==="details"){ selectedProjectId=(typeof arg==="string"&&arg)?arg:(projects[0]?.id||null); renderProjectDetails(selectedProjectId); }
    };
    function rerenderByView(){
      if(currentView==="dashboard") renderDashboard();
      if(currentView==="tasks") renderTaskManagement();
      if(currentView==="calendar") renderCalendar(true);
      if(currentView==="report") renderReport();
      if(currentView==="community") renderCommunity();
      if(currentView==="details") renderProjectDetails(selectedProjectId);
    }

    function initializeSystem(withData){
      currentView="dashboard"; renderDashboard(true);
      if(withData) startRealtimeListeners();
      const saved = (()=>{ try{ return localStorage.getItem('sidebarExpanded')!=='0'; }catch{return true} })();
      toggleSidebar(saved);
    }

    function handleDbError(source, err){
      console.error('Firestore error ['+source+']', err);
      logDbg('ERR','onSnapshot '+source, {code: err?.code, message: err?.message});
      if(err?.code === 'permission-denied'){
        setBanner('error', `資料庫讀取被拒絕（permission-denied）。<br/>
          請到 Firebase Console → Firestore Database → Rules，暫時設定允許已登入使用者讀寫
          <code>artifacts/${APP_ID}/public/**</code> 的文件。`);
      }else{
        setBanner('warn', `無法讀取 ${source} 資料：${err?.message || '未知錯誤'}`);
      }
    }

    function startRealtimeListeners(){
      if(!db || listenersStarted) return; listenersStarted=true;

      onSnapshot(
        query(collection(db, PROJECTS_COLLECTION_PATH), orderBy("createdAt","desc")),
        (s)=>{ projects=s.docs.map(d=>({id:d.id,...d.data()})); clearBanner(); rerenderByView(); },
        (e)=> handleDbError('projects', e)
      );
      onSnapshot(
        query(collection(db, TASKS_COLLECTION_PATH), orderBy("createdAt","desc")),
        (s)=>{ tasks=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="tasks") renderTaskManagement(); },
        (e)=> handleDbError('tasks', e)
      );
      onSnapshot(
        query(collection(db, EVENTS_COLLECTION_PATH), orderBy("startDate","asc")),
        (s)=>{ events=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="calendar") renderCalendar(true); },
        (e)=> handleDbError('events', e)
      );
      onSnapshot(
        query(collection(db, FILES_COLLECTION_PATH), orderBy("uploadedAt","desc")),
        (s)=>{ files=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="details") renderProjectDetails(selectedProjectId); },
        (e)=> handleDbError('files', e)
      );
      onSnapshot(
        doc(db, SETTINGS_DOC_PATH),
        (snap)=>{ if(snap.exists()){ const d=snap.data()||{}; budgetCaps={ personnelCap:n(d.personnelCap), operatingCap:n(d.operatingCap), equipmentCap:n(d.equipmentCap) }; } else { budgetCaps={personnelCap:0,operatingCap:0,equipmentCap:0}; } if(currentView==='dashboard') renderDashboard(); },
        (e)=> handleDbError('settings', e)
      );
      onSnapshot(
        query(collection(db, MANAGERS_COLLECTION_PATH), orderBy("name","asc")),
        (s)=>{ managers=s.docs.map(d=>({id:d.id,...d.data()})); },
        (e)=> handleDbError('managers', e)
      );
      onSnapshot(
        query(collection(db, COMMUNITY_COLLECTION_PATH), orderBy("createdAt","desc")),
        (s)=>{ communityPosts=s.docs.map(d=>({id:d.id,...d.data()})); if(currentView==="community") renderCommunity(); },
        (e)=> handleDbError('community', e)
      );
    }

    // ============ 儀表板 ============
    function renderDashboard(isBoot=false){
      const c=document.getElementById("main-content"); if(!c) return;

      const totalProjects=projects.length;
      const completed=projects.filter(p=> (n(p.progress))>=95 ).length;
      const totalBudget=projects.reduce((s,p)=>s+n(p.budget),0);
      const empty=totalProjects===0;

      let personnelUsed=0,operatingUsed=0,equipmentUsed=0;
      for(const p of projects){
        const pu=('personnelUsed' in p)?n(p.personnelUsed):n(p.personnelBudget);
        const ou=('operatingUsed' in p)?n(p.operatingUsed):n(p.operatingBudget);
        const eu=('equipmentUsed' in p)?n(p.equipmentUsed):n(p.equipmentBudget);
        personnelUsed+=pu; operatingUsed+=ou; equipmentUsed+=eu;
      }
      const pc=n(budgetCaps.personnelCap), oc=n(budgetCaps.operatingCap), ec=n(budgetCaps.equipmentCap);
      const pRate=pc>0?Math.max(0,Math.min(1,personnelUsed/pc)):0;
      const oRate=oc>0?Math.max(0,Math.min(1,operatingUsed/oc)):0;
      const eRate=ec>0?Math.max(0,Math.min(1,equipmentUsed/ec)):0;
      const pRemain=pc-personnelUsed, oRemain=oc-operatingUsed, eRemain=ec-equipmentUsed;
      const barClass=(rate,remain)=> remain>=0?(rate>=0.95?"bg-yellow-400":"bg-blue-800"):"bg-red-500";

      function sectionCard(title, value, icon, color){
        return `
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 ${color}">
            <div class="flex items-center justify-between">
              <div class="text-gray-500">${title}</div>
              <i data-lucide="${icon}" class="w-8 h-8 ${color.includes('blue')?'text-blue-800':color.includes('green')?'text-green-600':'text-orange-600'}"></i>
            </div>
            <div class="mt-3 text-3xl font-extrabold text-gray-900">${value}</div>
          </div>`;
      }

      // 任務統計
      const taskTotal = tasks.length;
      const taskTodo = tasks.filter(t => (t.status||'Todo')==='Todo').length;
      const taskWip  = tasks.filter(t => (t.status||'Todo')==='InProgress').length;
      const taskDone = tasks.filter(t => (t.status||'Todo')==='Done').length;
      const overdue  = tasks.filter(t => (t.dueDate && new Date(t.dueDate) < new Date() && (t.status||'')!=='Done')).length;

      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-blue-800"></i>專案儀表板</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          ${sectionCard('專案總數', totalProjects, 'layers', 'border-blue-800')}
          ${sectionCard('接近完成', completed, 'check-circle', 'border-green-600')}
          ${sectionCard('總預算', fmtMoney(totalBudget), 'wallet', 'border-orange-600')}
          ${sectionCard('逾期任務', overdue, 'alarm-clock', 'border-red-600')}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">人事費總預算</div><div class="text-sm text-gray-500">${fmtMoney(pc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(pRate,pRemain)}" style="width:${(pRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(personnelUsed)}</strong>（${(pRate*100).toFixed(0)}%）</span><span>${pRemain>=0?`餘額：<strong>${fmtMoney(pRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-pRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">業務費總預算</div><div class="text-sm text-gray-500">${fmtMoney(oc)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(oRate,oRemain)}" style="width:${(oRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(operatingUsed)}</strong>（${(oRate*100).toFixed(0)}%）</span><span>${oRemain>=0?`餘額：<strong>${fmtMoney(oRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-oRemain)}</strong>`}</span></div>
          </div>
          <div class="project-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-800">
            <div class="flex items-center justify-between mb-2"><div class="font-semibold text-gray-800">設備費總預算</div><div class="text-sm text-gray-500">${fmtMoney(ec)}</div></div>
            <div class="w-full bg-gray-200 rounded-full h-3"><div class="progress-bar h-3 rounded-full ${barClass(eRate,eRemain)}" style="width:${(eRate*100).toFixed(0)}%"></div></div>
            <div class="mt-2 text-sm text-gray-700 flex justify-between"><span>已用：<strong>${fmtMoney(equipmentUsed)}</strong>（${(eRate*100).toFixed(0)}%）</span><span>${eRemain>=0?`餘額：<strong>${fmtMoney(eRemain)}</strong>`:`超支：<strong class="text-red-600">${fmtMoney(-eRemain)}</strong>`}</span></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="card">
            <div class="font-semibold mb-3 flex items-center"><i data-lucide="clipboard-list" class="w-5 h-5 mr-2 text-blue-800"></i>任務狀態分佈</div>
            <div class="text-sm text-gray-700">總任務：<b>${taskTotal}</b>，待辦：<b>${taskTodo}</b>，進行中：<b>${taskWip}</b>，已完成：<b>${taskDone}</b>，逾期：<b class="text-red-600">${overdue}</b></div>
            <div class="mt-3"><button class="btn btn-primary" onclick="setView('tasks')"><i data-lucide="arrow-right"></i>前往任務</button></div>
          </div>
          <div class="card">
            <div class="font-semibold mb-3 flex items-center"><i data-lucide="calendar" class="w-5 h-5 mr-2 text-blue-800"></i>近期事件</div>
            <ul class="text-sm text-gray-700 space-y-1">
              ${events.slice(0,8).map(e=>`<li>• ${e.title||'未命名'}（${tsToDateStr(e.startDate)}${e.endDate?` ~ ${tsToDateStr(e.endDate)}`:''}）</li>`).join('') || '<li class="text-gray-500">目前沒有事件</li>'}
            </ul>
            <div class="mt-3"><button class="btn btn-primary" onclick="setView('calendar')"><i data-lucide="arrow-right"></i>前往行事曆</button></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          ${ empty ? `
            <div class="text-center py-8">
              <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mx-auto mb-3"></i>
              <p class="text-gray-700 mb-3">目前沒有專案資料。</p>
              <button onclick="seedDemoData()" class="px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-700">
                <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i> 建立示範資料
              </button>
            </div>` : `
            <div class="text-gray-700">已載入 ${totalProjects} 個專案。從左側選單瀏覽任務、行事曆與詳情。</div>
          `}
        </div>
      `;
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    async function seedDemoData(){
      if(!isAuthorized()){ showModal("請先登入","請先登入後再建立示範資料。"); return; }
      try{
        const pRef = await addDoc(collection(db, PROJECTS_COLLECTION_PATH), {
          title: "示範專案 A",
          manager: "蔡雅雯",
          budget: 1000000,
          personnelBudget: 400000,
          operatingBudget: 300000,
          equipmentBudget: 300000,
          progress: 10,
          status: "進行中",
          createdAt: serverTimestamp(),
          reporterId: currentUserId
        });
        await addDoc(collection(db, TASKS_COLLECTION_PATH), {
          title: "啟動會議",
          projectId: pRef.id,
          assignee: "王小明",
          dueDate: new Date().toISOString().slice(0,10),
          status: "Todo",
          priority: "High",
          createdAt: serverTimestamp(),
          creatorId: currentUserId
        });
        await addDoc(collection(db, EVENTS_COLLECTION_PATH), {
          title: "啟動會議",
          startDate: new Date().toISOString().slice(0,10),
          endDate: new Date().toISOString().slice(0,10),
          allDay: true,
          createdAt: serverTimestamp(),
          creatorId: currentUserId
        });
        setBanner('success', "已建立示範資料，稍候數秒資料會出現在各模組。");
      }catch(err){
        handleDbError('seed', err);
      }
    }

    // ============ 任務 ============
    function managerOptionsHtml(selected=""){
      const list=(managers.length>0?managers.map(m=>m.name).filter(Boolean):DEFAULT_MANAGERS);
      return list.map(m=>`<option value="${m}" ${m===selected?'selected':''}>${m}</option>`).join("");
    }
    function projectOptionsHtml(selected=""){
      return projects.map(p=>`<option value="${p.id}" ${p.id===selected?'selected':''}>${p.title||p.id}</option>`).join("");
    }
    function statusChip(s){
      if(s==='Done') return '<span class="chip done">完成</span>';
      if(s==='InProgress') return '<span class="chip wip">進行中</span>';
      return '<span class="chip todo">待辦</span>';
    }
    function renderTaskManagement(){
      const c=document.getElementById("main-content"); if(!c) return;
      const q=`
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 flex items-center"><i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-blue-800"></i>任務管理</h2>
          <div class="flex gap-2">
            <input id="task-search" placeholder="搜尋任務/負責人" class="border rounded-lg px-3 py-2 text-sm"/>
            <select id="task-filter-status" class="border rounded-lg px-3 py-2 text-sm">
              <option value="">全部狀態</option>
              <option value="Todo">待辦</option>
              <option value="InProgress">進行中</option>
              <option value="Done">已完成</option>
            </select>
            <button class="btn btn-primary" id="btn-add-task"><i data-lucide="plus"></i>新增任務</button>
          </div>
        </div>
        <div class="card overflow-auto">
          <table class="table text-sm">
            <thead><tr>
              <th>任務</th><th>所屬專案</th><th>負責人</th><th>期限</th><th>優先</th><th>狀態</th><th>動作</th>
            </tr></thead>
            <tbody id="task-tbody"></tbody>
          </table>
        </div>
      `;
      c.innerHTML = q;

      const searchEl=document.getElementById('task-search');
      const filterEl=document.getElementById('task-filter-status');
      const tbody=document.getElementById('task-tbody');

      function renderRows(){
        const kw=(searchEl.value||"").trim().toLowerCase();
        const st=filterEl.value||"";
        const rows=tasks.filter(t=>{
          const hitKw=!kw || (String(t.title||'').toLowerCase().includes(kw) || String(t.assignee||'').toLowerCase().includes(kw));
          const hitSt=!st || (t.status===st);
          return hitKw && hitSt;
        }).map(t=>{
          const pj=projects.find(p=>p.id===t.projectId);
          return `<tr>
            <td class="font-semibold">${t.title||''}</td>
            <td>${pj? (pj.title||pj.id) : (t.projectId||'-')}</td>
            <td>${t.assignee||''}</td>
            <td>${t.dueDate||''}</td>
            <td>${t.priority||''}</td>
            <td>${statusChip(t.status||'Todo')}</td>
            <td class="whitespace-nowrap">
              <button class="btn btn-gray" data-edit="${t.id}"><i data-lucide="edit-3"></i>編輯</button>
              <button class="btn btn-danger" data-del="${t.id}"><i data-lucide="trash-2"></i>刪除</button>
            </td>
          </tr>`;
        }).join('') || `<tr><td colspan="7" class="text-gray-500 text-center py-6">尚無任務</td></tr>`;
        tbody.innerHTML = rows;
        if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
      }
      renderRows();

      searchEl.oninput=renderRows; filterEl.onchange=renderRows;

      document.getElementById('btn-add-task').onclick = () => openTaskModal();
      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-edit') || btn.getAttribute('data-del');
        const t = tasks.find(x=>x.id===id);
        if(btn.hasAttribute('data-edit')) openTaskModal(t);
        if(btn.hasAttribute('data-del')){
          if(confirm(`確定刪除任務「${t?.title||id}」？`)){
            await deleteDoc(doc(db, TASKS_COLLECTION_PATH, id)).catch(err=>handleDbError('task-delete',err));
          }
        }
      });
    }

    function openTaskModal(task){
      const isEdit=!!task;
      const modal=document.createElement('div');
      modal.className='modal-backdrop';
      modal.innerHTML=`
        <div class="modal-card">
          <div class="flex items-center justify-between mb-3">
            <div class="text-lg font-bold">${isEdit?'編輯任務':'新增任務'}</div>
            <button class="btn btn-gray" id="m-close">關閉</button>
          </div>
          <div class="space-y-3">
            <div class="form-row">
              <div><label class="text-sm text-gray-600">任務名稱</label><input id="m-title" class="w-full border rounded-lg p-2" value="${task?.title||''}"></div>
              <div><label class="text-sm text-gray-600">所屬專案</label>
                <select id="m-project" class="w-full border rounded-lg p-2">${projectOptionsHtml(task?.projectId||'')}</select>
              </div>
            </div>
            <div class="form-row">
              <div><label class="text-sm text-gray-600">負責人</label>
                <select id="m-assignee" class="w-full border rounded-lg p-2">${managerOptionsHtml(task?.assignee||'')}</select>
              </div>
              <div><label class="text-sm text-gray-600">期限</label><input id="m-due" type="date" class="w-full border rounded-lg p-2" value="${task?.dueDate||''}"></div>
            </div>
            <div class="form-row">
              <div><label class="text-sm text-gray-600">優先</label>
                <select id="m-pri" class="w-full border rounded-lg p-2">
                  ${['Low','Medium','High','Urgent'].map(p=>`<option ${task?.priority===p?'selected':''}>${p}</option>`).join('')}
                </select>
              </div>
              <div><label class="text-sm text-gray-600">狀態</label>
                <select id="m-st" class="w-full border rounded-lg p-2">
                  <option value="Todo" ${(!task || task.status==='Todo')?'selected':''}>待辦</option>
                  <option value="InProgress" ${(task?.status==='InProgress')?'selected':''}>進行中</option>
                  <option value="Done" ${(task?.status==='Done')?'selected':''}>完成</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-600">說明</label>
              <textarea id="m-desc" rows="3" class="w-full border rounded-lg p-2" placeholder="補充說明...">${task?.description||''}</textarea>
            </div>
            <div class="flex justify-end gap-2">
              <button class="btn btn-gray" id="m-close2">取消</button>
              <button class="btn btn-primary" id="m-save">儲存</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close=()=>{ try{ document.body.removeChild(modal); }catch{} };
      modal.querySelector('#m-close').onclick=close;
      modal.querySelector('#m-close2').onclick=close;
      modal.querySelector('#m-save').onclick = async ()=>{
        const title=modal.querySelector('#m-title').value.trim();
        const projectId=modal.querySelector('#m-project').value;
        const assignee=modal.querySelector('#m-assignee').value;
        const dueDate=modal.querySelector('#m-due').value;
        const priority=modal.querySelector('#m-pri').value;
        const status=modal.querySelector('#m-st').value;
        const description=modal.querySelector('#m-desc').value.trim();
        if(!title){ alert('請輸入任務名稱'); return; }
        try{
          if(isEdit){
            await updateDoc(doc(db, TASKS_COLLECTION_PATH, task.id), { title, projectId, assignee, dueDate, priority, status, description, updatedAt: serverTimestamp() });
          }else{
            await addDoc(collection(db, TASKS_COLLECTION_PATH), { title, projectId, assignee, dueDate, priority, status, description, createdAt: serverTimestamp(), creatorId: currentUserId });
          }
          close();
        }catch(err){ handleDbError('task-save', err); }
      };
    }

    // ============ 行事曆 ============
    function renderCalendar(keepInstance=false){
      const c=document.getElementById("main-content"); if(!c) return;
      c.innerHTML=`
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 flex items-center"><i data-lucide="calendar" class="w-7 h-7 mr-3 text-blue-800"></i>行事曆</h2>
          <div class="flex gap-2">
            <button id="btn-add-event" class="btn btn-primary"><i data-lucide="plus"></i>新增事件</button>
          </div>
        </div>
        <div id="calendar" class="bg-white rounded-xl shadow p-2"></div>
      `;
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}

      const el=document.getElementById('calendar');
      const data = events.map(e=>({
        id: e.id,
        title: e.title || '未命名',
        start: e.startDate,
        end: e.endDate || e.startDate,
        allDay: !!e.allDay
      }));

      if(calendarInstance && keepInstance){
        // 更新現有日曆事件
        const api = calendarInstance.getApi();
        api.removeAllEvents();
        data.forEach(evt => api.addEvent(evt));
      }else{
        calendarInstance = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          height: 'auto',
          selectable: true,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          dateClick: info => openEventModal({ startDate: info.dateStr, endDate: info.dateStr, allDay: true }),
          eventClick: info => {
            const e = events.find(x=>x.id===info.event.id);
            openEventModal(e || { id: info.event.id, title: info.event.title, startDate: info.event.startStr, endDate: info.event.endStr, allDay: info.event.allDay });
          }
        });
        calendarInstance.render();
        data.forEach(evt => calendarInstance.addEvent(evt));
      }

      document.getElementById('btn-add-event').onclick = ()=> openEventModal();
    }

    function openEventModal(event){
      const isEdit=!!(event && event.id);
      const modal=document.createElement('div');
      modal.className='modal-backdrop';
      modal.innerHTML=`
        <div class="modal-card">
          <div class="flex items-center justify-between mb-3">
            <div class="text-lg font-bold">${isEdit?'編輯事件':'新增事件'}</div>
            <button class="btn btn-gray" id="m-close">關閉</button>
          </div>
          <div class="space-y-3">
            <div class="form-row">
              <div><label class="text-sm text-gray-600">標題</label><input id="m-title" class="w-full border rounded-lg p-2" value="${event?.title||''}"></div>
              <div><label class="text-sm text-gray-600">整天</label>
                <select id="m-allday" class="w-full border rounded-lg p-2"><option value="1" ${event?.allDay?'selected':''}>是</option><option value="0" ${!event?.allDay?'selected':''}>否</option></select>
              </div>
            </div>
            <div class="form-row">
              <div><label class="text-sm text-gray-600">開始</label><input id="m-start" type="date" class="w-full border rounded-lg p-2" value="${event?.startDate||''}"></div>
              <div><label class="text-sm text-gray-600">結束</label><input id="m-end" type="date" class="w-full border rounded-lg p-2" value="${event?.endDate||event?.startDate||''}"></div>
            </div>
            <div>
              <label class="text-sm text-gray-600">備註</label>
              <textarea id="m-notes" rows="3" class="w-full border rounded-lg p-2" placeholder="補充說明...">${event?.notes||''}</textarea>
            </div>
            <div class="flex justify-between">
              ${isEdit?`<button class="btn btn-danger" id="m-del"><i data-lucide="trash-2"></i>刪除</button>`:'<span></span>'}
              <div class="flex gap-2">
                <button class="btn btn-gray" id="m-close2">取消</button>
                <button class="btn btn-primary" id="m-save">儲存</button>
              </div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close=()=>{ try{ document.body.removeChild(modal); }catch{} };
      modal.querySelector('#m-close').onclick=close;
      modal.querySelector('#m-close2').onclick=close;

      if(isEdit){
        modal.querySelector('#m-del').onclick = async ()=>{
          if(confirm('確定刪除此事件？')){
            await deleteDoc(doc(db, EVENTS_COLLECTION_PATH, event.id)).catch(err=>handleDbError('event-delete',err));
            close();
          }
        };
      }

      modal.querySelector('#m-save').onclick = async ()=>{
        const title=modal.querySelector('#m-title').value.trim();
        const allDay=modal.querySelector('#m-allday').value==='1';
        const startDate=modal.querySelector('#m-start').value;
        const endDate=modal.querySelector('#m-end').value||startDate;
        const notes=modal.querySelector('#m-notes').value.trim();
        if(!title || !startDate){ alert('請輸入標題與開始日期'); return; }
        try{
          if(isEdit){
            await updateDoc(doc(db, EVENTS_COLLECTION_PATH, event.id), { title, startDate, endDate, allDay, notes, updatedAt: serverTimestamp() });
          }else{
            await addDoc(collection(db, EVENTS_COLLECTION_PATH), { title, startDate, endDate, allDay, notes, createdAt: serverTimestamp(), creatorId: currentUserId });
          }
          close();
        }catch(err){ handleDbError('event-save', err); }
      };
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    // ============ 報告 ============
    function renderReport(){
      const c=document.getElementById("main-content"); if(!c) return;

      const taskByStatus = ['Todo','InProgress','Done'].map(s=>({s, n: tasks.filter(t=> (t.status||'Todo')===s).length}));
      const overdueTasks = tasks.filter(t=> t.dueDate && new Date(t.dueDate)<new Date() && (t.status||'')!=='Done');
      const budgetByProject = projects.map(p=>{
        const personnel = n(p.personnelUsed ?? p.personnelBudget);
        const operating = n(p.operatingUsed ?? p.operatingBudget);
        const equipment = n(p.equipmentUsed ?? p.equipmentBudget);
        const used = personnel+operating+equipment;
        return { id:p.id, title:p.title||p.id, budget:n(p.budget), used };
      });

      function exportCSV(){
        const rows=[['Project','Budget','Used'],
          ...budgetByProject.map(x=>[x.title, x.budget, x.used])
        ];
        const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='budget-report.csv';
        document.body.appendChild(a); a.click(); a.remove();
      }

      c.innerHTML=`
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 flex items-center"><i data-lucide="file-text" class="w-7 h-7 mr-3 text-blue-800"></i>報告</h2>
          <div class="flex gap-2">
            <button class="btn btn-gray" id="btn-export"><i data-lucide="download"></i>匯出 CSV</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="card">
            <div class="font-semibold mb-3">任務狀態統計</div>
            <ul class="text-sm text-gray-700">
              ${taskByStatus.map(x=>`<li>• ${x.s==='Todo'?'待辦':x.s==='InProgress'?'進行中':'完成'}：<b>${x.n}</b></li>`).join('')}
              <li>• 逾期：<b class="text-red-600">${overdueTasks.length}</b></li>
            </ul>
          </div>
          <div class="card">
            <div class="font-semibold mb-3">專案預算使用</div>
            <table class="table text-sm">
              <thead><tr><th>專案</th><th>預算</th><th>已用</th></tr></thead>
              <tbody>
                ${budgetByProject.map(b=>`<tr><td>${b.title}</td><td>${fmtMoney(b.budget)}</td><td>${fmtMoney(b.used)}</td></tr>`).join('') || '<tr><td colspan="3" class="text-gray-500">無資料</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="font-semibold mb-3">文字摘要</div>
          <div class="text-sm text-gray-700" id="report-summary">- 專案數：${projects.length}；任務總數：${tasks.length}（逾期 ${overdueTasks.length}）</div>
        </div>
      `;
      document.getElementById('btn-export').onclick = exportCSV;
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    // ============ 社群 ============
    function renderCommunity(){
      const c=document.getElementById("main-content"); if(!c) return;
      const list=communityPosts;
      c.innerHTML=`
        <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center"><i data-lucide="messages-square" class="w-7 h-7 mr-3 text-blue-800"></i>資訊交流</h2>
        <div class="card mb-4">
          <div class="form-row">
            <input id="post-title" class="border rounded-lg p-2" placeholder="標題">
            <input id="post-tag" class="border rounded-lg p-2" placeholder="標籤（選填）">
          </div>
          <textarea id="post-content" rows="3" class="w-full border rounded-lg p-2 mt-2" placeholder="分享訊息、公告或討論..."></textarea>
          <div class="flex justify-end mt-2">
            <button class="btn btn-primary" id="btn-post"><i data-lucide="send"></i>發佈</button>
          </div>
        </div>
        <div id="post-list" class="space-y-3"></div>
      `;
      const listEl=document.getElementById('post-list');
      listEl.innerHTML = list.map(p=>`
        <div class="card">
          <div class="flex justify-between">
            <div class="font-semibold">${p.title||'(無標題)'} ${p.tag?`<span class="chip todo ml-2">#${p.tag}</span>`:''}</div>
            ${(p.authorId===currentUserId)?`<button class="btn btn-danger" data-del="${p.id}"><i data-lucide="trash-2"></i>刪除</button>`:''}
          </div>
          <div class="text-sm text-gray-700 mt-1 whitespace-pre-wrap">${p.content||''}</div>
          <div class="text-xs text-gray-500 mt-1">${p.authorName||p.authorEmail||''} · ${tsToDateStr(p.createdAt)}</div>
        </div>
      `).join('') || '<div class="text-gray-500">目前沒有貼文</div>';

      document.getElementById('btn-post').onclick = async ()=>{
        const title=document.getElementById('post-title').value.trim();
        const tag=document.getElementById('post-tag').value.trim();
        const content=document.getElementById('post-content').value.trim();
        if(!content){ alert('請輸入內容'); return; }
        try{
          await addDoc(collection(db, COMMUNITY_COLLECTION_PATH), {
            title, tag, content,
            authorId: currentUserId, authorEmail: userProfile.email||'', authorName: userProfile.displayName||'',
            createdAt: serverTimestamp()
          });
          document.getElementById('post-title').value='';
          document.getElementById('post-tag').value='';
          document.getElementById('post-content').value='';
        }catch(err){ handleDbError('post-add',err); }
      };
      listEl.addEventListener('click', async (e)=>{
        const btn=e.target.closest('button');
        if(!btn) return;
        if(btn.hasAttribute('data-del')){
          const id=btn.getAttribute('data-del');
          if(confirm('確定刪除此貼文？')) await deleteDoc(doc(db, COMMUNITY_COLLECTION_PATH, id)).catch(err=>handleDbError('post-del',err));
        }
      });
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
    }

    // ============ 專案詳情 + 檔案 ============
    function renderProjectDetails(projectId){
      const c=document.getElementById("main-content"); if(!c) return;

      const project = projects.find(p=>p.id===projectId);
      const fileList = files.filter(f=>f.projectId===projectId);

      c.innerHTML=`
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-blue-800"></i>專案詳情</h2>
          <div class="flex gap-2">
            <select id="pd-project" class="border rounded-lg px-3 py-2">
              ${projects.map(p=>`<option value="${p.id}" ${p.id===projectId?'selected':''}>${p.title||p.id}</option>`).join('')}
            </select>
            <button class="btn btn-primary" id="btn-new-project"><i data-lucide="plus"></i>新增專案</button>
          </div>
        </div>

        ${project? `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="card md:col-span-2">
            <div class="font-semibold mb-2">基本資訊</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>專案名稱：<b>${project.title||''}</b></div>
              <div>專案經理：<b>${project.manager||''}</b></div>
              <div>狀態：<b>${project.status||''}</b></div>
              <div>進度：<b>${n(project.progress)||0}%</b></div>
              <div>總預算：<b>${fmtMoney(project.budget||0)}</b></div>
            </div>
            <div class="mt-3">
              <button class="btn btn-gray" id="btn-edit-project"><i data-lucide="edit-3"></i>編輯</button>
              <button class="btn btn-danger" id="btn-del-project"><i data-lucide="trash-2"></i>刪除</button>
            </div>
          </div>

          <div class="card">
            <div class="font-semibold mb-2">檔案</div>
            <input id="file-input" type="file" class="block w-full text-sm" />
            <button class="btn btn-primary mt-2" id="btn-upload"><i data-lucide="upload"></i>上傳</button>
            <div class="text-xs text-gray-500 mt-1">支援小型附件示範上傳。</div>
          </div>

          <div class="card md:col-span-3">
            <div class="font-semibold mb-2">檔案清單</div>
            <table class="table text-sm">
              <thead><tr><th>檔名</th><th>大小</th><th>上傳時間</th><th>動作</th></tr></thead>
              <tbody id="file-tbody">
                ${fileList.map(f=>`
                  <tr>
                    <td><a class="text-blue-700 underline" href="${f.downloadURL}" target="_blank" rel="noopener">${f.name}</a></td>
                    <td>${(Number(f.size)||0).toLocaleString()} B</td>
                    <td>${tsToDateStr(f.uploadedAt)}</td>
                    <td><button class="btn btn-danger" data-del="${f.id}"><i data-lucide="trash-2"></i>刪除</button></td>
                  </tr>`).join('') || '<tr><td colspan="4" class="text-gray-500">尚無檔案</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
        ` : `
          <div class="card">
            <div class="text-gray-600">尚未選擇專案，請從上方選單選取或新增專案。</div>
          </div>
        `}
      `;
      if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}

      const projectSel=document.getElementById('pd-project');
      if(projectSel) projectSel.onchange=()=> renderProjectDetails(projectSel.value);

      const fileTbody=document.getElementById('file-tbody');
      if(fileTbody) fileTbody.addEventListener('click', async (e)=>{
        const btn=e.target.closest('button'); if(!btn) return;
        if(btn.hasAttribute('data-del')){
          const id=btn.getAttribute('data-del');
          const f=files.find(x=>x.id===id);
          if(!f) return;
          if(confirm(`確定刪除檔案 ${f.name}？`)){
            try{
              // 刪雲檔
              if(f.storagePath){ await deleteObject(sRef(storage, f.storagePath)).catch(()=>{}); }
              await deleteDoc(doc(db, FILES_COLLECTION_PATH, id));
            }catch(err){ handleDbError('file-delete', err); }
          }
        }
      });

      const btnNew=document.getElementById('btn-new-project');
      if(btnNew) btnNew.onclick = ()=> openProjectModal();

      if(project){
        document.getElementById('btn-edit-project').onclick = ()=> openProjectModal(project);
        document.getElementById('btn-del-project').onclick = async ()=>{
          if(confirm(`確定刪除專案「${project.title||project.id}」？（不會連動刪除任務/檔案）`)){
            await deleteDoc(doc(db, PROJECTS_COLLECTION_PATH, project.id)).catch(err=>handleDbError('project-delete',err));
            selectedProjectId = projects[0]?.id || null;
            renderProjectDetails(selectedProjectId);
          }
        };
        document.getElementById('btn-upload').onclick = async ()=>{
          const input=document.getElementById('file-input');
          const file=input?.files?.[0];
          if(!file){ alert('請先選取檔案'); return; }
          try{
            const path=`${APP_ID}/${currentUserId}/${Date.now()}_${file.name}`;
            const ref=sRef(storage, path);
            const snap = await uploadBytesResumable(ref, file);
            const url = await getDownloadURL(snap.ref);
            await addDoc(collection(db, FILES_COLLECTION_PATH), {
              projectId: project.id,
              name: file.name,
              size: file.size,
              contentType: file.type,
              storagePath: path,
              downloadURL: url,
              uploadedAt: serverTimestamp(),
              uploaderId: currentUserId
            });
            setBanner('success','檔案已上傳');
          }catch(err){ handleDbError('file-upload',err); }
        };
      }
    }

    function openProjectModal(project){
      const isEdit=!!project;
      const modal=document.createElement('div');
      modal.className='modal-backdrop';
      modal.innerHTML=`
        <div class="modal-card">
          <div class="flex items-center justify-between mb-3">
            <div class="text-lg font-bold">${isEdit?'編輯專案':'新增專案'}</div>
            <button class="btn btn-gray" id="m-close">關閉</button>
          </div>
          <div class="space-y-3">
            <div class="form-row">
              <div><label class="text-sm text-gray-600">專案名稱</label><input id="m-title" class="w-full border rounded-lg p-2" value="${project?.title||''}"></div>
              <div><label class="text-sm text-gray-600">專案經理</label>
                <select id="m-manager" class="w-full border rounded-lg p-2">${managerOptionsHtml(project?.manager||'')}</select>
              </div>
            </div>
            <div class="form-row">
              <div><label class="text-sm text-gray-600">總預算</label><input id="m-budget" type="number" class="w-full border rounded-lg p-2" value="${project?.budget||0}"></div>
              <div><label class="text-sm text-gray-600">進度 %</label><input id="m-progress" type="number" min="0" max="100" class="w-full border rounded-lg p-2" value="${project?.progress||0}"></div>
            </div>
            <div class="form-row">
              <div><label class="text-sm text-gray-600">狀態</label>
                <select id="m-status" class="w-full border rounded-lg p-2">
                  ${['進行中','規劃中','已結案','延後'].map(s=>`<option ${project?.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
              </div>
              <div></div>
            </div>
            <div class="flex justify-end gap-2">
              <button class="btn btn-gray" id="m-close2">取消</button>
              <button class="btn btn-primary" id="m-save">儲存</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close=()=>{ try{ document.body.removeChild(modal); }catch{} };
      modal.querySelector('#m-close').onclick=close;
      modal.querySelector('#m-close2').onclick=close;
      modal.querySelector('#m-save').onclick = async ()=>{
        const title=modal.querySelector('#m-title').value.trim();
        const manager=modal.querySelector('#m-manager').value;
        const budget=Number(modal.querySelector('#m-budget').value)||0;
        const progress=Math.max(0,Math.min(100,Number(modal.querySelector('#m-progress').value)||0));
        const status=modal.querySelector('#m-status').value;
        if(!title){ alert('請輸入專案名稱'); return; }
        try{
          if(isEdit){
            await updateDoc(doc(db, PROJECTS_COLLECTION_PATH, project.id), { title, manager, budget, progress, status, updatedAt: serverTimestamp() });
            selectedProjectId = project.id;
          }else{
            const ref = await addDoc(collection(db, PROJECTS_COLLECTION_PATH), { title, manager, budget, progress, status, createdAt: serverTimestamp(), reporterId: currentUserId });
            selectedProjectId = ref.id;
          }
          close();
          renderProjectDetails(selectedProjectId);
        }catch(err){ handleDbError('project-save',err); }
      };
    }

    // ============ 啟動 ============
    window.addEventListener('DOMContentLoaded', () => {
      initFirebase().catch(e=>{
        logDbg('ERR','initFirebase failed', {code:e?.code, message:e?.message});
        landingLoading?.classList.add("hidden");
        btnGoogle?.removeAttribute('disabled');
        resetBtn?.classList.remove('hidden');
        setBanner('error', '初始化失敗：' + (e?.message || '未知錯誤'));
      });
    });

    if(window.lucide?.createIcons) try{ lucide.createIcons(); }catch{}
  </script>
</body>
</html>
